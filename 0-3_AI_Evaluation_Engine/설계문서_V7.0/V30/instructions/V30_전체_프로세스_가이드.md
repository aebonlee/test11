# V30 전체 프로세스 가이드

**작성일**: 2026-01-14
**버전**: V30
**목적**: 4개 AI 분담 웹검색 수집 + 풀링 평가 전체 프로세스

---

## 1. V30 개요

### 핵심 변경사항

| 항목 | V28 | V30 |
|------|-----|-----|
| 수집 AI | 1개 (Claude) | **3개 (Gemini, Perplexity, Grok)** |
| 평가 AI | 1개 | **5개 (Claude, ChatGPT, Gemini, Grok, Perplexity 제외)** |
| 수집 방식 | AI 기억 | **웹검색 필수** |
| 수집 개수 | 50개/카테고리 | **100개/카테고리** |
| 데이터 유형 | 통합 | **공식/공개 분리** |
| 평가 방식 | 개별 | **풀링 평가** |

### 수집 비율 (60-30-10) - 비용 최적화 버전

```
Gemini     60% = 공식 50개 + 공개 10개 (X 제외 SNS 담당)
Perplexity 30% = 공개 30개 (뉴스/언론 전담)
Grok       10% = 공개 10개 (X/트위터 전담)
─────────────────────────────
합계      100% = 100개/카테고리

⚠️ Claude/ChatGPT = 수집 제외 (웹검색 비용 문제)
   → 평가에만 사용
```

### 수집 제외 사유 (Claude/ChatGPT)

| AI | 문제점 |
|---|---|
| Claude | web_search 도구 **검색당 $0.01 추가 과금** |
| ChatGPT | Bing 검색 연동 **별도 과금** |
| Gemini | Google Search Grounding **무료** ✅ |
| Perplexity | 검색 비용 **API 요금에 포함** ✅ |
| Grok | X/Twitter 접근 **무료** ✅ |

---

## 2. 사전 준비

### 2.1 API 키 설정

`.env` 파일에 다음 키 설정:

```bash
# 수집용 (3개) - 웹검색 비용 무료/포함
GEMINI_API_KEY=AIza...           # Gemini (60% 수집 + 평가) - Google Search 무료
PERPLEXITY_API_KEY=pplx-...      # Perplexity (30% 수집) - 검색 비용 포함
XAI_API_KEY=xai-...              # Grok (10% 수집) - X/Twitter 무료

# 평가용 (2개) - 웹검색 비용 문제로 수집 제외
ANTHROPIC_API_KEY=sk-ant-...     # Claude (평가만) ⚠️ 수집 제외
OPENAI_API_KEY=sk-...            # ChatGPT (평가만) ⚠️ 수집 제외

# Supabase
SUPABASE_URL=https://...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
```

### 2.2 데이터베이스 테이블 생성

```sql
-- V30 수집 데이터 테이블
CREATE TABLE IF NOT EXISTS collected_data_v30 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    category TEXT NOT NULL,
    data_type TEXT NOT NULL,           -- 'official' or 'public'
    collector_ai TEXT NOT NULL,        -- 'perplexity', 'claude', 'gemini', 'grok'
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    source_url TEXT NOT NULL,
    source_name TEXT,
    published_date DATE,
    sentiment TEXT,                    -- 'positive', 'negative', 'neutral'
    is_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- V30 평가 테이블
CREATE TABLE IF NOT EXISTS evaluations_v30 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    category TEXT NOT NULL,
    evaluator_ai TEXT NOT NULL,
    rating TEXT NOT NULL,
    score INTEGER NOT NULL,
    reasoning TEXT,
    evaluated_at TIMESTAMPTZ DEFAULT NOW()
);

-- V30 카테고리 점수 테이블
CREATE TABLE IF NOT EXISTS ai_category_scores_v30 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    category TEXT NOT NULL,
    score INTEGER NOT NULL,
    ai_details JSONB,
    calculated_at TIMESTAMPTZ DEFAULT NOW()
);

-- V30 최종 점수 테이블
CREATE TABLE IF NOT EXISTS ai_final_scores_v30 (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL,
    politician_name TEXT NOT NULL,
    final_score INTEGER NOT NULL,
    grade TEXT NOT NULL,
    category_scores JSONB,
    calculated_at TIMESTAMPTZ DEFAULT NOW(),
    version TEXT DEFAULT 'V30'
);

-- 인덱스
CREATE INDEX IF NOT EXISTS idx_v30_collected_politician ON collected_data_v30(politician_id);
CREATE INDEX IF NOT EXISTS idx_v30_collected_category ON collected_data_v30(category);
CREATE INDEX IF NOT EXISTS idx_v30_eval_politician ON evaluations_v30(politician_id);
```

### 2.3 의존성 설치

```bash
pip install anthropic openai google-generativeai supabase python-dotenv json-repair
```

---

## 3. 전체 프로세스

```
┌─────────────────────────────────────────────────────────────┐
│ [1단계] 수집 - collect_v30.py (3개 AI만)                    │
│                                                             │
│ Gemini    ──┬── 공식 50개 (Google Search 무료)             │
│             └── 공개 10개 (X 제외 SNS: FB, 인스타, 유튜브) │
│ Perplexity ──── 공개 30개 (뉴스/언론 전담)                 │
│ Grok      ────── 공개 10개 (X/트위터 전담)                 │
│                                                             │
│ ⚠️ Claude/ChatGPT = 수집 제외 (웹검색 비용 문제)           │
│                     ↓                                       │
│            collected_data_v30 저장                          │
├─────────────────────────────────────────────────────────────┤
│ [2단계] 검증 & 재수집 - validate_v30.py                     │
│                                                             │
│ 검증 항목:                                                  │
│ ✓ URL 실제 존재 여부 (HEAD/GET 요청)                       │
│ ✓ source_type 규칙 (OFFICIAL/PUBLIC 도메인 매칭)           │
│ ✓ 필수 필드 검증 (title, content, source_url)              │
│ ✓ 기간 제한 검증 (공식 4년, 공개 2년)                      │
│ ✓ 가짜 URL 패턴 탐지                                       │
│                     ↓                                       │
│ 검증 실패 → 삭제 → 해당 AI로 재수집 (최대 5회 반복)        │
├─────────────────────────────────────────────────────────────┤
│ [3단계] 풀링 & 중복 제거                                    │
│                                                             │
│ 3개 AI 수집 데이터 통합                                     │
│ - 같은 AI가 같은 URL 2번 수집 → 중복 제거 (1개만 유지)     │
│ - 다른 AI가 같은 URL 수집 → 모두 유지 (제거 안 함)         │
├─────────────────────────────────────────────────────────────┤
│ [4단계] 평가 - evaluate_v30.py (4개 AI)                     │
│                                                             │
│ Claude  ──┬── 풀링된 전체 데이터 평가 (수집 안 함, 평가만) │
│ ChatGPT ──┤                                                │
│ Gemini  ──┤                                                │
│ Grok    ──┘                                                │
│                                                             │
│ ⚠️ Perplexity = 평가 제외 (수집만 담당)                    │
│                     ↓                                       │
│            evaluations_v30 저장                             │
├─────────────────────────────────────────────────────────────┤
│ [5단계] 점수 계산 - calculate_v30_scores.py                 │
│                                                             │
│ 4개 AI 평가 결과 종합 → 카테고리 점수 → 최종 점수          │
│                     ↓                                       │
│   ai_category_scores_v30, ai_final_scores_v30 저장         │
└─────────────────────────────────────────────────────────────┘
```

### 3.1 역할 및 자동화

#### 메인 에이전트 (Claude Code) 역할

V30에서는 **메인 에이전트 (Claude Code)**가 전체 파이프라인을 자동으로 오케스트레이션합니다.

```
┌─────────────────────────────────────────────────────────────┐
│ 📌 메인 에이전트의 자동화 기능                              │
│                                                             │
│ 1. 수집 완료 감지                                           │
│    → collect_v30.py 실행 완료 시점 자동 감지               │
│                                                             │
│ 2. 자동 검증 트리거                                         │
│    → validate_v30.py 자동 실행                             │
│    → 검증 실패 항목 자동 재수집 (최대 5회)                 │
│                                                             │
│ 3. 진행 상황 모니터링                                       │
│    → 각 단계별 완료 여부 추적                              │
│    → 오류 발생 시 자동 보고                                │
│                                                             │
│ 4. 사용자 개입 최소화                                       │
│    → 수집 → 검증 → 재수집이 자동으로 완료될 때까지 반복    │
│    → 최종 결과만 사용자에게 보고                           │
└─────────────────────────────────────────────────────────────┘
```

#### 자동 검증 트리거 (V30 신규 기능)

```python
# collect_v30.py 내장 자동 검증 로직

# 수집 완료 후 자동 실행
if not args.skip_validation:
    print("🔍 자동 검증 시작...")

    # validate_v30.py 임포트 및 실행
    from validate_v30 import run_validation_pipeline

    result = run_validation_pipeline(
        politician_id=args.politician_id,
        politician_name=args.politician_name,
        mode='all',
        ai_name=args.ai
    )

    print(f"✅ 검증 완료: 유효 {result['valid']}개, 무효 {result['invalid']}개")
```

#### 자동화 옵션

```bash
# 기본: 자동 검증 활성화
python collect_v30.py --politician_id=ID --politician_name="이름"

# 자동 검증 건너뛰기 (수동 검증 시)
python collect_v30.py --politician_id=ID --politician_name="이름" --skip-validation
```

#### 장점

```
✅ 수동 개입 불필요
   - 수집 후 자동으로 검증 실행
   - 검증 실패 시 자동으로 재수집

✅ 시간 절약
   - 수집 → 검증 → 재수집 자동 반복
   - 사용자는 최종 결과만 확인

✅ 오류 조기 발견
   - 수집 직후 즉시 검증
   - 문제 데이터 즉시 재수집

✅ 일관성 보장
   - 모든 정치인에 동일한 검증 적용
   - 수동 검증 누락 방지
```

---

## 4. 실행 방법

### 4.0 전체 워크플로우 자동 실행 (NEW - 2026-01-19)

**run_v30_workflow.py** - 수집 → 검증 → 평가 → 재평가 → 점수계산 자동화

```bash
# 전체 워크플로우 자동 실행 (권장)
python run_v30_workflow.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --parallel

# 수집 건너뛰기 (이미 수집된 경우)
python run_v30_workflow.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --skip_collect

# 평가 건너뛰기 (이미 평가된 경우)
python run_v30_workflow.py \
  --politician_id=d0a5d6e1 \
  --politician_name="조은희" \
  --skip_evaluate
```

**자동 워크플로우 프로세스**:
```
1. 수집 (collect_v30.py)
   ↓
2. 수집 검증 (110% 이내 체크)
   ↓
3. 데이터 검증 및 재수집 (validate_v30.py) ✅ 자동화
   - URL 실제 존재 여부 확인
   - 도메인 유효성 검사
   - 기간 제한 검증
   - 검증 실패 시 자동 재수집
   ↓
4. 평가 (evaluate_v30.py)
   ↓
5. 평가 검증 (97% 이상 체크)
   ↓
6. 재평가 (누락 평가 자동 처리) ✅ 자동화
   ↓
7. 점수 계산 (calculate_v30_scores.py)
```

**품질 기준**:
- 수집: 목표 1,000개, 최대 110% 이내 (1,100개)
- 평가: 97% 이상 완료 (누락 시 자동 재평가)

**자동화 개선 (2026-01-19)**:
- evaluate_v30.py: 90% 완료 체크 → 100% 완료 체크로 변경
- 재평가 자동화: 누락된 평가만 자동 처리
- 재수집 자동화: validate_v30.py 통합, URL/도메인/기간 검증 및 자동 재수집

### 4.1 수집 (collect_v30.py)

```bash
# 전체 수집 (4개 AI × 10개 카테고리)
python collect_v30.py --politician_id=62e7b453 --politician_name="오세훈"

# 특정 AI만
python collect_v30.py --politician_id=62e7b453 --politician_name="오세훈" --ai=Perplexity

# 특정 카테고리만
python collect_v30.py --politician_id=62e7b453 --politician_name="오세훈" --category=1

# 병렬 실행 (빠름)
python collect_v30.py --politician_id=62e7b453 --politician_name="오세훈" --parallel
```

### 4.2 평가 (evaluate_v30.py)

```bash
# 전체 평가 (4개 AI × 10개 카테고리)
python evaluate_v30.py --politician_id=62e7b453 --politician_name="오세훈"

# 특정 AI만
python evaluate_v30.py --politician_id=62e7b453 --politician_name="오세훈" --ai=Claude

# 병렬 실행
python evaluate_v30.py --politician_id=62e7b453 --politician_name="오세훈" --parallel
```

### 4.3 점수 계산 (calculate_v30_scores.py)

```bash
python calculate_v30_scores.py --politician_id=62e7b453 --politician_name="오세훈"
```

### 4.4 전체 파이프라인 (일괄 실행)

```bash
# 순차 실행
python collect_v30.py --politician_id=62e7b453 --politician_name="오세훈" && \
python evaluate_v30.py --politician_id=62e7b453 --politician_name="오세훈" && \
python calculate_v30_scores.py --politician_id=62e7b453 --politician_name="오세훈"
```

---

## 5. 평가 등급 체계 (+4 ~ -4)

### 5.1 등급 → 점수 변환 (V28 기준)

| 등급 | 점수(×2) | 객관적 기준 |
|------|----------|-------------|
| **+4** | +8점 | 탁월 - 법률 제정, 공식 수상, 대통령 표창 |
| **+3** | +6점 | 우수 - 정책 성과 수치화 가능 |
| **+2** | +4점 | 양호 - 일반 긍정 활동 (발의, 제안) |
| **+1** | +2점 | 경미한 긍정 - 노력, 참석 |
| **-1** | -2점 | 경미한 부정 - 비판, 지적 |
| **-2** | -4점 | 일반 부정 - 논란, 의혹 |
| **-3** | -6점 | 심각한 부정 - 수사, 조사 |
| **-4** | -8점 | 최악 - 기소, 유죄, 처벌 |

### 5.2 카테고리 점수 계산

```
카테고리 점수 = (PRIOR + 평균평점 × COEFFICIENT) × 10

PRIOR = 6.0
COEFFICIENT = 0.5

예시:
- 평균평점 +8 (+4등급): (6.0 + 8 × 0.5) × 10 = 100점
- 평균평점 0 (중립): (6.0 + 0 × 0.5) × 10 = 60점
- 평균평점 -8 (-4등급): (6.0 + (-8) × 0.5) × 10 = 20점

범위: 20점 ~ 100점
```

### 5.3 최종 점수

```
최종 점수 = 10개 카테고리 점수 합계
범위: 200점 ~ 1000점
```

### 5.4 최종 등급 (10단계)

| 점수 범위 | 등급 | 이름 | 의미 |
|-----------|------|------|------|
| 920~1000 | **M** | Mugunghwa | 최우수 |
| 840~919 | **D** | Diamond | 우수 |
| 760~839 | **E** | Emerald | 양호 |
| 680~759 | **P** | Platinum | 보통+ |
| 600~679 | **G** | Gold | 보통 |
| 520~599 | **S** | Silver | 보통- |
| 440~519 | **B** | Bronze | 미흡 |
| 360~439 | **I** | Iron | 부족 |
| 280~359 | **Tn** | Tin | 상당히 부족 |
| 200~279 | **L** | Lead | 매우 부족 |

---

## 6. 비용 예상 (비용 최적화 버전)

### 정치인 1명당 비용

| AI | 역할 | 수집량 | 비용 |
|----|------|--------|------|
| **Gemini** | 수집+평가 | 600개 | **무료** (Google Search) |
| **Perplexity** | 수집만 | 300개 | ~$1.50 (검색 포함) |
| **Grok** | 수집+평가 | 100개 | ~$0.50 |
| **수집 소계** | | 1,000개 | **~$2.00** |
| Claude | 평가만 | - | ~$1.00 |
| ChatGPT | 평가만 | - | ~$0.50 |
| **평가 소계** | 4개 AI | | **~$2.50** |
| **총 합계** | | | **~$4.50** |

### 비용 절감 효과

| 항목 | 기존 (Claude 수집) | 변경 후 | 절감액 |
|------|-------------------|---------|--------|
| Claude 웹검색 | ~$100/정치인 | $0 | **$100** |
| 총 비용 | ~$114/정치인 | ~$4.50 | **$109.50 절감** |

⚠️ **Claude web_search 제거로 약 96% 비용 절감**

---

## 7. 체크리스트

### 수집 전
- [ ] 4개 수집 API 키 설정 확인
- [ ] Supabase 연결 확인
- [ ] 정치인 ID/이름 확인
- [ ] collected_data_v30 테이블 존재 확인

### 수집 후
- [ ] 카테고리당 100개 달성 확인
- [ ] 공식 50개 + 공개 50개 확인
- [ ] 모든 항목에 URL 존재 확인
- [ ] 20-20-60 균형 확인

### 평가 전
- [ ] 4개 평가 API 키 설정 확인
- [ ] 수집 데이터 존재 확인
- [ ] evaluations_v30 테이블 존재 확인

### 평가 후
- [ ] 4개 AI × 10개 카테고리 = 40개 평가 확인
- [ ] 평가 등급 유효성 확인 (+4 ~ -4)

### 점수 계산 후
- [ ] 카테고리 점수 10개 확인
- [ ] 최종 점수 200~1000 범위 확인
- [ ] 등급 산정 확인

---

## 8. 문제 해결

### API 오류
```
❌ PERPLEXITY_API_KEY 환경변수가 설정되지 않았습니다.
→ .env 파일에 API 키 추가
```

### 수집 데이터 없음
```
⚠️ 평가할 데이터 없음
→ collect_v30.py 먼저 실행
```

### JSON 파싱 오류
```
⚠️ JSON 파싱 에러
→ json_repair 패키지 설치: pip install json-repair
```

---

## 9. 파일 구조

```
설계문서_V7.0/
├── instructions_v30/
│   ├── V30_기본방침.md              ← 핵심 방침
│   ├── V30_전체_프로세스_가이드.md  ← 현재 문서
│   ├── 1_politicians/               ← 정치인 정보
│   └── 2_collect/                   ← 10개 카테고리 지침
│       ├── cat01_expertise.md
│       ├── cat02_leadership.md
│       ├── ...
│       └── cat10_publicinterest.md
│
└── 실행스크립트/
    ├── collect_v30.py               ← 4개 AI 수집
    ├── evaluate_v30.py              ← 풀링 평가
    └── calculate_v30_scores.py      ← 점수 계산
```

---

## 10. 핵심 규칙 요약

```
[수집 규칙]
1. 웹검색 필수! AI 기억 기반 수집 금지!
2. 60-30-10 비율 준수 (Gemini-Perplexity-Grok)
3. ⚠️ Claude/ChatGPT = 수집 금지! (웹검색 비용 문제)
4. 공식 데이터(50개): Gemini 단독 담당
5. 공개 데이터(50개): Gemini 10 + Perplexity 30 + Grok 10
6. 20-20-60 균형 (부정-긍정-자유)
7. 모든 데이터에 실제 URL 필수!

[플랫폼 규칙]
8. X(트위터): Grok만 수집! 다른 AI 금지!
9. X 제외 SNS(페이스북, 인스타, 유튜브): Gemini 담당
10. 뉴스/언론: Perplexity 담당

[평가 규칙]
11. 풀링 평가: 4개 AI (Claude, ChatGPT, Gemini, Grok)
12. ⚠️ Perplexity = 평가 제외! (수집만 담당)

[공통 규칙]
13. 가짜 URL, 가짜 스캔들 = 절대 금지!
14. 등급 체계: +4 ~ -4 (V28 기준), 점수 = 등급 × 2
15. 최종 등급: 10단계 (M, D, E, P, G, S, B, I, Tn, L)
16. 중복 제거: 같은 AI가 같은 URL만 제거! 다른 AI는 유지!
```

---

**문서 끝**
