# V26.0 데이터 수집 지침 및 프로세스

**작성일**: 2026-01-04
**버전**: V26.0
**이전 버전**: V24.0

---

## 핵심 변경사항 (V24.0 → V26.0)

| 항목 | V24.0 | V26.0 |
|------|-------|-------|
| AI 개수 | 3개 (Claude, ChatGPT, Grok) | **4개 (+Gemini)** |
| OFFICIAL 기간 | 제한 없음 | **평가일 기준 4년 이내** |
| PUBLIC 기간 | 제한 없음 | **평가일 기준 1년 이내** |

---

## 1. 기간 제한 규칙 (V26.0 신규)

### 1.1 기간 제한 정의

```
┌─────────────────────────────────────────────────────────────┐
│                     평가일: 2026-01-04                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  OFFICIAL (공식 데이터)        PUBLIC (공개 데이터)          │
│  ─────────────────────        ───────────────────          │
│  4년 이내                      1년 이내                      │
│  2022-01-04 ~ 2026-01-04      2025-01-04 ~ 2026-01-04      │
│                                                             │
│  대상:                         대상:                         │
│  - 공공기록                    - 언론 보도                   │
│  - 공식 자료                   - SNS 게시물                  │
│  - 정부/기관 발표              - 블로그/커뮤니티             │
│  - 국회/지방의회 기록          - 인터뷰 기사                 │
│  - 감사원/사법부 자료          - 논평/칼럼                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 기간 제한 근거

**OFFICIAL 4년 선택 이유:**
- 지방자치단체장 임기 = 4년
- 국회의원 임기 = 4년
- 한 임기 동안의 실적 평가에 충분
- 너무 오래된 공식 기록은 현재 역량과 괴리

**PUBLIC 1년 선택 이유:**
- 언론 보도는 최신성이 생명
- 1년 전 SNS 게시물은 현재 입장과 다를 수 있음
- 최근 1년 = 현재 활동 상태 반영
- 변별력 향상 (최신 활동 중심 평가)

### 1.3 프롬프트 적용 방법

```python
# 평가일 계산
from datetime import datetime, timedelta

evaluation_date = datetime.now()
official_start = evaluation_date - timedelta(days=365*4)  # 4년 전
public_start = evaluation_date - timedelta(days=365)       # 1년 전

# 프롬프트에 기간 조건 추가
prompt = f"""
{politician_name}에 대한 {category_name} 관련 데이터를 수집하세요.

⚠️ 기간 제한 (V26.0 규칙):
- OFFICIAL 데이터: {official_start.strftime('%Y-%m-%d')} ~ {evaluation_date.strftime('%Y-%m-%d')} (4년 이내)
- PUBLIC 데이터: {public_start.strftime('%Y-%m-%d')} ~ {evaluation_date.strftime('%Y-%m-%d')} (1년 이내)

위 기간 외의 데이터는 수집하지 마세요.
데이터 날짜가 불분명한 경우, 기사/문서 내용에서 시점을 유추하여 기간 내 데이터만 포함하세요.
"""
```

### 1.4 기간 외 데이터 처리

```
기간 외 데이터 발견 시:
1. 해당 데이터 제외
2. 다른 기간 내 데이터로 대체
3. 50개 목표 달성까지 재수집

예외:
- 기간 내 데이터가 절대적으로 부족한 경우
- 해당 정치인의 활동 기간이 짧은 경우
→ 부족한 만큼 기록하고 진행 (무리한 확대 금지)
```

---

## 2. 4개 AI 체제 (V26.0 신규)

### 2.1 참여 AI 모델

| AI | 모델 | 특징 | 예상 비용/정치인 |
|----|------|------|-----------------|
| **Claude** | claude-3-5-haiku-20241022 | 균형잡힌 평가, 기존 검증됨 | $0.4~0.8 |
| **ChatGPT** | gpt-4o-mini | 보수적 평가 경향 | $0.3~0.8 |
| **Grok** | grok-3-mini | 현실감 있는 평가 | $0.3~0.8 |
| **Gemini** | gemini-2.0-flash | Google 최신 모델, 빠른 처리 | $0.2~0.5 |

### 2.2 AI별 DB 저장 규칙

```python
# ai_name 필드 값 (고정)
ai_name = "Claude"    # Claude 시스템 (모든 Claude 모델)
ai_name = "ChatGPT"   # ChatGPT 시스템 (모든 GPT 모델)
ai_name = "Grok"      # Grok 시스템
ai_name = "Gemini"    # Gemini 시스템 (신규)

# 모델명을 ai_name에 넣지 말 것!
# ❌ ai_name = "claude-3-5-haiku-20241022"
# ❌ ai_name = "gemini-2.0-flash"
```

### 2.3 풀링 기반 수집-평가 구조 (V26.0 핵심)

```
┌─────────────────────────────────────────────────────────────┐
│  [1단계: 수집] - rating 없이 뉴스/데이터만 수집               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Claude ──→ 카테고리 1~10 (각 50개) ─┐                      │
│             OFFICIAL 25개 + PUBLIC 25개                     │
│             부정 주제 최소 20% (10개)                        │
│                                      │                      │
│  ChatGPT ──→ 카테고리 1~10 (각 50개) ─┼──→ 카테고리당       │
│              OFFICIAL 25개 + PUBLIC 25개    200개 풀 생성   │
│              부정 주제 최소 20% (10개)      (중복 제거 X)    │
│                                      │                      │
│  Grok ──→ 카테고리 1~10 (각 50개) ───┤                      │
│           OFFICIAL 25개 + PUBLIC 25개                       │
│           부정 주제 최소 20% (10개)                          │
│                                      │                      │
│  Gemini ──→ 카테고리 1~10 (각 50개) ─┘                      │
│             OFFICIAL 25개 + PUBLIC 25개                     │
│             부정 주제 최소 20% (10개)                        │
│                                                             │
│  * 수집 항목: 제목, 내용, 출처, URL, 날짜, source_type       │
│  * rating은 수집 단계에서 부여하지 않음                       │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [2단계: 평가] - 200개 풀 전체를 각 AI가 독립 평가            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  200개 풀 ──→ Claude가 200개 평가                           │
│  (카테고리당)                                                │
│          ──→ ChatGPT가 200개 평가                           │
│                                                             │
│          ──→ Grok가 200개 평가                              │
│                                                             │
│          ──→ Gemini가 200개 평가                            │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  결과 (카테고리당):                                          │
│  - 데이터: 50개 × 4개 AI = 200개                            │
│  - Rating: 4개 AI가 각각 200개 평가                         │
│                                                             │
│  핵심: "모두가 찾은 것을 각자가 평가"                         │
│                                                             │
│  자연스러운 가중치 효과:                                      │
│  - 4개 AI가 동일 뉴스 수집 → 풀에 4번 포함 → 4배 영향        │
│  - 중복 제거 안 함, 가중치 계산 안 함 → 자연스럽게 반영       │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 Gemini API 설정

```python
# Gemini API 설정
import google.generativeai as genai

genai.configure(api_key=os.getenv('GEMINI_API_KEY'))

model = genai.GenerativeModel('gemini-2.0-flash')

# API 호출
response = model.generate_content(
    prompt,
    generation_config={
        'temperature': 1.0,
        'max_output_tokens': 8000,
    }
)
```

### 2.5 환경 변수 설정

```bash
# .env 파일
ANTHROPIC_API_KEY=sk-ant-...      # Claude
OPENAI_API_KEY=sk-...              # ChatGPT
XAI_API_KEY=xai-...                # Grok
GEMINI_API_KEY=AIza...             # Gemini (신규)
SUPABASE_URL=https://...
SUPABASE_KEY=eyJ...
```

---

## 3. 데이터 수집 프로세스 (유지)

### 3.1 카테고리별 50개 수집 구조

```
카테고리당 50개 = Phase 1 (부정 10개) + Phase 2 (자유 40개)

Phase 1: 부정 주제 10개 (최소 20% 보장)
├── Step 1: OFFICIAL 부정 5개 (4년 이내)
└── Step 2: PUBLIC 부정 5개 (1년 이내)

Phase 2: 자유 평가 40개 (긍정+부정 혼합)
├── Step 3: OFFICIAL 자유 20개 (4년 이내)
└── Step 4: PUBLIC 자유 20개 (1년 이내)

결과: OFFICIAL 25개 (50%) + PUBLIC 25개 (50%)
```

### 3.2 병렬 처리 구조

```
정치인 1명, AI 1개 (약 1.5분)
│
├── [그룹 1] 카테고리 1~5 (5개 동시)
│   └── 각 카테고리: 4번 API 호출 순차
│
└── [그룹 2] 카테고리 6~10 (5개 동시)
    └── 각 카테고리: 4번 API 호출 순차

전체 소요 시간:
- 1명 × 4개 AI = 약 6분 (병렬 시)
- 30명 × 4개 AI = 약 3시간 (병렬 시)
```

### 3.3 자동 재수집

```python
# 50개 미달 시 자동 재수집 (최대 5회)
MAX_RETRIES = 5
TARGET_COUNT = 50

for attempt in range(MAX_RETRIES):
    collect_all_categories(politician_id, ai_name)

    incomplete = check_incomplete_categories(politician_id, ai_name)
    if not incomplete:
        print("모든 카테고리 50개 달성!")
        break

    print(f"{len(incomplete)}개 카테고리 미달, {attempt+2}회차 재수집...")
```

---

## 4. 풀링 시스템 (V26.0)

### 4.1 풀링 방식 핵심

```
┌─────────────────────────────────────────────────────────────┐
│  풀링 = "모두가 찾은 것을 각자가 평가"                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [1단계: 수집]                                               │
│  4개 AI가 각각 50개씩 수집 → 200개 풀 (카테고리당)           │
│  - 중복 제거 안 함                                           │
│  - 가중치 계산 안 함                                         │
│  - 그냥 있는 그대로 합침                                      │
│                                                             │
│  [2단계: 평가]                                               │
│  200개 풀에 대해 각 AI가 독립적으로 평가                      │
│  - Claude가 200개 전체 평가                                  │
│  - ChatGPT가 200개 전체 평가                                 │
│  - Grok가 200개 전체 평가                                    │
│  - Gemini가 200개 전체 평가                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 자연스러운 가중치 효과

```
중복 뉴스가 있으면 자연스럽게 가중치가 반영됨:

예시: "오세훈 예산안 통과" 뉴스
- Claude가 수집 → 풀에 1번 포함
- ChatGPT가 수집 → 풀에 1번 포함
- Grok가 수집 → 풀에 1번 포함
- Gemini가 수집 → 풀에 1번 포함
────────────────────────────────
풀에 4번 포함 → 평균 계산 시 자연스럽게 4배 영향

→ 중요한 뉴스(여러 AI가 공통 발견)일수록 더 큰 영향력
→ 별도 가중치 계산 필요 없음
```

---

## 5. 등급 시스템 (유지)

### 5.1 알파벳 등급 (8단계)

```python
RATING_GRADES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']

ALPHABET_TO_NUMBER = {
    'A': 8,   # 최고
    'B': 6,   # 우수
    'C': 4,   # 양호
    'D': 2,   # 보통
    'E': -2,  # 미흡
    'F': -4,  # 부족
    'G': -6,  # 상당히 부족
    'H': -8   # 매우 부족
}
```

### 5.2 DB 저장 규칙 (CRITICAL)

```python
# ✅ 올바른 저장 (알파벳 문자열)
rating = 'A'
rating = 'B'
rating = 'H'

# ❌ 잘못된 저장 (숫자) - 절대 금지!
rating = 8
rating = -8
```

---

## 6. 실행 스크립트

### 6.1 V26.0 스크립트 목록

```bash
# Claude 수집 (기간 제한 적용)
python collect_v26_claude.py --politician_id=62e7b453 --politician_name="오세훈"

# ChatGPT 수집 (기간 제한 적용)
python collect_v26_chatgpt.py --politician_id=62e7b453 --politician_name="오세훈"

# Grok 수집 (기간 제한 적용)
python collect_v26_grok.py --politician_id=62e7b453 --politician_name="오세훈"

# Gemini 수집 (신규, 기간 제한 적용)
python collect_v26_gemini.py --politician_id=62e7b453 --politician_name="오세훈"

# 전체 4개 AI 일괄 수집
python collect_v26_all.py --politician_id=62e7b453 --politician_name="오세훈"

# 점수 계산 (V24와 동일 알고리즘)
python calculate_v24_scores_correct.py
```

### 6.2 배치 처리

```bash
# 30명 전체 수집 (4개 AI)
python collect_v26_batch.py --batch=all

# 특정 지역만 수집
python collect_v26_batch.py --region=seoul
python collect_v26_batch.py --region=gyeonggi
python collect_v26_batch.py --region=busan
```

---

## 7. 체크리스트

### 7.1 수집 전 확인

- [ ] 4개 API 키 설정 (.env)
- [ ] Supabase 연결 확인
- [ ] 평가일 기준 기간 계산 확인
- [ ] 정치인 ID 및 이름 확인

### 7.2 수집 중 확인

- [ ] 기간 제한 적용 여부 (OFFICIAL 4년, PUBLIC 1년)
- [ ] 카테고리당 50개 달성
- [ ] OFFICIAL/PUBLIC 50:50 비율
- [ ] 부정 주제 최소 20% (10개)
- [ ] rating 알파벳 저장 확인

### 7.3 수집 후 확인

- [ ] 4개 AI × 10개 카테고리 × 50개 = 2,000개 확인
- [ ] 중복 데이터 제거
- [ ] 점수 계산 실행
- [ ] AI 간 점수 비교 분석

---

## 8. 에러 처리

### 8.1 기간 외 데이터 발견

```python
def validate_date_range(data_date, source_type, evaluation_date):
    """기간 유효성 검증"""
    if source_type == 'OFFICIAL':
        min_date = evaluation_date - timedelta(days=365*4)
    else:  # PUBLIC
        min_date = evaluation_date - timedelta(days=365)

    if data_date < min_date:
        return False, f"기간 외 데이터: {data_date} (최소 {min_date})"
    return True, "OK"
```

### 8.2 Gemini API 에러

```python
# Rate Limit 처리
import time
from google.api_core.exceptions import ResourceExhausted

try:
    response = model.generate_content(prompt)
except ResourceExhausted:
    print("Rate limit 도달, 60초 대기...")
    time.sleep(60)
    response = model.generate_content(prompt)
```

---

## 9. 마이그레이션 가이드

### 9.1 V24.0 → V26.0 전환

```
기존 V24.0 데이터:
- 기간 제한 없이 수집됨
- 3개 AI (Claude, ChatGPT, Grok)

V26.0 전환 시:
1. 기존 데이터 유지 (삭제 안 함)
2. Gemini 데이터 추가 수집
3. 새 정치인은 V26.0 규칙으로 수집
4. 필요시 기존 정치인 재수집 (선택)
```

### 9.2 점수 비교 시 주의

```
V24.0 데이터와 V26.0 데이터는 직접 비교 불가능:
- 수집 기간이 다름
- AI 개수가 다름 (3개 vs 4개)

비교 방법:
- 동일 버전 내에서만 순위 비교
- 버전 간 비교 시 명시적 표기
```

---

**최종 업데이트**: 2026-01-04
**버전**: V26.0
