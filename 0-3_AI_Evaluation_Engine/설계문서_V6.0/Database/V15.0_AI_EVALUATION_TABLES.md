# V15.0 AI 평가 엔진 테이블 스키마

**작성일**: 2025-11-14
**버전**: V15.0
**담당**: AI 평가 엔진 (`0-3_AI_Evaluation_Engine`)

---

## 개요

AI 평가 엔진에서 관리하는 3개 테이블의 구조 문서입니다.

### 관리 테이블 (3개)

1. **collected_data** - AI가 수집한 평가 데이터 (500개/정치인)
2. **politician_scores** - 점수 계산 결과 (V15.0 알고리즘)
3. **politician_id_mapping** - UUID ↔ INT ID 매핑 브릿지

---

## 1. collected_data 테이블

AI가 수집한 평가 데이터 저장 (카테고리별 50개 × 10개 = 500개/정치인)

### 필드 구조 (13개 필드)

```sql
CREATE TABLE collected_data (
  collected_data_id SERIAL PRIMARY KEY,   -- 데이터 고유 ID (자동 증가)
  politician_id INT NOT NULL,             -- 정치인 ID (INT 타입)
  ai_name VARCHAR(50),                    -- AI 모델명
  category_name VARCHAR(50) NOT NULL,     -- 카테고리 영문명
  item_num INT,                           -- 항목 번호 (1~50)

  data_title VARCHAR(200) NOT NULL,       -- 데이터 제목
  data_content TEXT NOT NULL,             -- 데이터 내용
  data_source TEXT,                       -- 출처
  source_url TEXT,                        -- 출처 URL
  source_type VARCHAR(20)                 -- OFFICIAL(60%) | PUBLIC(40%)
    CHECK (source_type IN ('OFFICIAL', 'PUBLIC')),

  collection_date TIMESTAMP DEFAULT NOW(), -- 수집 일시
  rating INT NOT NULL                     -- 등급 (V15.0: -6~+10)
    CHECK (rating >= -6 AND rating <= 10),
  rating_rationale TEXT                   -- 등급 근거
);

CREATE INDEX idx_collected_data_politician_id ON collected_data(politician_id);
CREATE INDEX idx_collected_data_category_name ON collected_data(category_name);
CREATE INDEX idx_collected_data_source_type ON collected_data(source_type);
```

### V15.0 데이터 수집 기준

| 필드 | V15.0 값 | 설명 |
|------|---------|------|
| **ai_name** | "claude-3-5-haiku-20241022" | Haiku 모델 |
| **category_name** | Expertise/Leadership/... | 10개 카테고리 영문명 |
| **rating** | **-6 ~ +10** | **V15.0 비대칭 17단계** |
| **source_type** | OFFICIAL/PUBLIC | 60%/40% 비율 |
| **item_num** | 1 ~ 50 | 카테고리당 50개 |

### 카테고리 매핑 (10개)

| category_name | 한글명 | 카테고리 번호 |
|---------------|--------|-------------|
| Expertise | 전문성 | 1 |
| Leadership | 리더십 | 2 |
| Vision | 비전 | 3 |
| Integrity | 청렴성 | 4 |
| Ethics | 윤리성 | 5 |
| Accountability | 책임성 | 6 |
| Transparency | 투명성 | 7 |
| Communication | 소통능력 | 8 |
| Responsiveness | 대응성 | 9 |
| PublicInterest | 공익성 | 10 |

### 데이터 출처 분류 (source_type)

**OFFICIAL (공식 데이터) - 60%**:
- 정부/공공기관 발표 자료
- 국회/지방의회 공식 기록
- 법원 판결문/검찰 기소장
- 선거관리위원회 공식 자료
- 정부 통계/보고서
- 공공기관 감사 결과

**PUBLIC (공개 데이터) - 40%**:
- 언론 보도 (신문/방송/온라인)
- 시민단체 보고서
- 학술 논문/연구 자료
- SNS 공식 계정 발언
- 공개 인터뷰/토론회 발언

---

## 2. politician_scores 테이블

V15.0 알고리즘으로 계산된 점수 저장

### 필드 구조 (29개 필드)

```sql
CREATE TABLE politician_scores (
  -- 기본 키
  politician_id INT PRIMARY KEY,

  -- 카테고리별 평균 Rating (10개)
  category_1_avg_rating DECIMAL(4,2),    -- 전문성 (Expertise)
  category_2_avg_rating DECIMAL(4,2),    -- 리더십 (Leadership)
  category_3_avg_rating DECIMAL(4,2),    -- 비전 (Vision)
  category_4_avg_rating DECIMAL(4,2),    -- 청렴성 (Integrity)
  category_5_avg_rating DECIMAL(4,2),    -- 윤리성 (Ethics)
  category_6_avg_rating DECIMAL(4,2),    -- 책임성 (Accountability)
  category_7_avg_rating DECIMAL(4,2),    -- 투명성 (Transparency)
  category_8_avg_rating DECIMAL(4,2),    -- 소통능력 (Communication)
  category_9_avg_rating DECIMAL(4,2),    -- 대응성 (Responsiveness)
  category_10_avg_rating DECIMAL(4,2),   -- 공익성 (PublicInterest)

  -- 카테고리별 점수 (10개) - 30~110점
  category_1_score DECIMAL(5,2),
  category_2_score DECIMAL(5,2),
  category_3_score DECIMAL(5,2),
  category_4_score DECIMAL(5,2),
  category_5_score DECIMAL(5,2),
  category_6_score DECIMAL(5,2),
  category_7_score DECIMAL(5,2),
  category_8_score DECIMAL(5,2),
  category_9_score DECIMAL(5,2),
  category_10_score DECIMAL(5,2),

  -- 최종 점수 (300~1000점)
  raw_final_score DECIMAL(6,2),         -- 원점수 (1,000점 초과 가능)
  final_score DECIMAL(6,2) NOT NULL     -- 최종 점수 (1,000점 상한)
    CHECK (final_score >= 300 AND final_score <= 1000),

  -- 등급 (8단계 금속 등급)
  grade VARCHAR(1) NOT NULL
    CHECK (grade IN ('I','B','S','G','P','E','D','M')),

  -- 수집된 데이터 개수
  total_data_count INT,                  -- 총 데이터 개수 (목표: 500개)
  official_data_count INT,               -- OFFICIAL 데이터 개수
  public_data_count INT,                 -- PUBLIC 데이터 개수

  -- 메타 정보
  version VARCHAR(10) DEFAULT 'V15.0',   -- 알고리즘 버전
  calculated_at TIMESTAMP DEFAULT NOW(), -- 계산 일시
  updated_at TIMESTAMP DEFAULT NOW()     -- 업데이트 일시
);

CREATE INDEX idx_politician_scores_grade ON politician_scores(grade);
CREATE INDEX idx_politician_scores_final_score ON politician_scores(final_score DESC);
```

### V15.0 점수 계산 공식

```
Prior = 6.5
Coefficient = 0.5
Rating Range = A~-A (8단계 알파벳)

category_score = (6.5 + avg_rating × 0.5) × 10
raw_final_score = SUM(category_1_score ~ category_10_score)
final_score = MIN(raw_final_score, 1000)
```

**점수 범위**:
- 카테고리 점수: 30점 (최저) ~ 110점 (최고)
- 최종 점수: **300 ~ 1,000점** (1,000점 상한 적용)

### 등급 체계 (8단계 금속 등급)

| 등급 | 점수 범위 | 등급명 |
|:----:|-----------|--------|
| **I** | 900~1000 | Iridium (이리듐) |
| **B** | 800~899 | Bronze (브론즈) |
| **S** | 700~799 | Silver (실버) |
| **G** | 600~699 | Gold (골드) |
| **P** | 500~599 | Platinum (플래티넘) |
| **E** | 450~499 | Emerald (에메랄드) |
| **D** | 425~449 | Diamond (다이아몬드) |
| **M** | 400~424 | Mithril (미스릴) |

---

## 3. politician_id_mapping 테이블

UUID(politicians.id) ↔ INT(collected_data/politician_scores) 브릿지 테이블

### 필드 구조 (8개 필드)

```sql
CREATE TABLE politician_id_mapping (
  -- 기본 키 (정수 ID)
  integer_id INT PRIMARY KEY,

  -- 정치인 정보
  name VARCHAR(100) NOT NULL,              -- 정치인 이름
  name_en VARCHAR(100),                    -- 영문 이름
  party VARCHAR(100),                      -- 소속 정당
  position VARCHAR(100),                   -- 직위

  -- UUID 매핑 (FK to politicians.id)
  uuid_id UUID REFERENCES politicians(id), -- politicians 테이블의 UUID

  -- 메타 정보
  created_at TIMESTAMP DEFAULT NOW(),      -- 생성 일시
  updated_at TIMESTAMP DEFAULT NOW(),      -- 업데이트 일시

  -- 제약 조건
  CONSTRAINT unique_name UNIQUE(name),
  CONSTRAINT unique_uuid UNIQUE(uuid_id)
);

CREATE INDEX idx_politician_id_mapping_integer_id ON politician_id_mapping(integer_id);
CREATE INDEX idx_politician_id_mapping_uuid_id ON politician_id_mapping(uuid_id);
CREATE INDEX idx_politician_id_mapping_name ON politician_id_mapping(name);
```

### 매핑 목적

**문제점**:
- `politicians.id`: UUID (예: cd8c0263-500b-4af8-9301-174b487038a2)
- `collected_data.politician_id`: INT (1, 2, 3, ...)
- `politician_scores.politician_id`: INT (1, 2, 3, ...)

**해결책**:
- `politician_id_mapping` 테이블로 UUID ↔ INT 매핑
- 3-way JOIN 쿼리에서 중간 브릿지로 사용

### 현재 등록된 정치인 (11명)

서울시장 후보 11명 (ID 1~11)

| ID | 이름 | 영문명 | 정당 | 직위 |
|----|------|--------|------|------|
| 1 | 오세훈 | Oh Se-hoon | 국민의힘 | 서울특별시장 |
| 2 | 박주민 | Park Joo-min | 더불어민주당 | 국회의원 |
| 3 | 금태섭 | Keum Tae-seop | 무소속 | 전 국회의원 |
| 4 | 나경원 | Na Kyung-won | 국민의힘 | 전 국회의원 |
| 5 | 안철수 | Ahn Cheol-soo | 국민의힘 | 국회의원 |
| 6 | 김은혜 | Kim Eun-hye | 국민의힘 | 경기도지사 권한대행 |
| 7 | 김진표 | Kim Jin-pyo | 더불어민주당 | 전 국회의장 |
| 8 | 박영선 | Park Young-sun | 더불어민주당 | 전 중소벤처기업부 장관 |
| 9 | 우상호 | Woo Sang-ho | 더불어민주당 | 국회의원 |
| 10 | 정청래 | Chung Chung-rae | 더불어민주당 | 국회의원 |
| 11 | 진성준 | Jin Sung-joon | 더불어민주당 | 국회의원 |

---

## 테이블 간 관계

```
politician_id_mapping (브릿지)
├─ integer_id (1, 2, 3, ...)
│   ├─→ collected_data.politician_id (FK)
│   └─→ politician_scores.politician_id (FK)
│
└─ uuid_id (UUID)
    └─→ politicians.id (FK, 다른 테이블)
```

### 3-way JOIN 예시

```sql
-- 상세평가보고서 생성 쿼리
SELECT
  -- 1. 기본 정보 (politicians via mapping)
  p.name AS politician_name,
  p.party,
  p.position,

  -- 2. 종합 점수 (politician_scores)
  ps.final_score,
  ps.grade,
  ps.category_1_score,

  -- 3. 상세 데이터 (collected_data)
  cd.category_name,
  cd.data_title,
  cd.rating,
  cd.source_type

FROM politician_id_mapping m
LEFT JOIN politicians p ON m.uuid_id = p.id
LEFT JOIN politician_scores ps ON m.integer_id = ps.politician_id
LEFT JOIN collected_data cd ON m.integer_id = cd.politician_id

WHERE m.integer_id = 1
ORDER BY cd.category_name, cd.rating DESC;
```

---

## 데이터 수집 및 점수 계산 프로세스

### 1. 데이터 수집 (`src/data_collector_parallel.py`)

```bash
python src/data_collector_parallel.py --politician_id=1 --politician_name="오세훈"
```

- 10개 카테고리 × 50개 = 500개 데이터 수집
- `collected_data` 테이블에 저장
- OFFICIAL 60% + PUBLIC 40% 비율 준수

### 2. 점수 계산 (`src/score_calculator.py`)

```bash
python src/score_calculator.py --politician_id=1 --politician_name="오세훈"
```

- `collected_data`에서 Rating 평균 계산
- V15.0 알고리즘으로 점수 산출
- `politician_scores` 테이블에 UPSERT

### 3. 전체 자동화 (`src/main_orchestrator.py`)

```bash
python src/main_orchestrator.py --politician_id=1 --politician_name="오세훈"
```

- 데이터 수집 + 점수 계산 자동 실행
- 진행 상황 실시간 로깅

---

## 버전 히스토리

| 버전 | 날짜 | 주요 변경사항 |
|------|------|--------------|
| V6.0 | 2025-10-31 | Prior 7.0, Rating -5~+5 (11단계) |
| V13.0 | 2025-11-11 | Prior 6.5, Rating -7~+7 (15단계) |
| V14.0 | 2025-11-13 | Prior 6.0, Rating -8~+8 (17단계) |
| **V15.0** | **2025-11-14** | Prior 6.0, Rating **-6~+10 (17단계, 비대칭)**, **1,000점 상한**, **source_type 추가**, **politician_scores/politician_id_mapping 테이블 신규** |

---

**작성자**: Claude Code (AI 평가 엔진)
**최종 수정**: 2025-11-14
**버전**: V15.0
**상태**: 운영 중
