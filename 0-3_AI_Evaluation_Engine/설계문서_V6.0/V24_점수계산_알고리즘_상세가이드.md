# V24.0 점수 계산 알고리즘 상세 가이드

**작성일**: 2025-11-24
**버전**: V24.0
**목적**: V24.0 점수 계산 프로세스 상세 설명

---

## 🎯 개요

V24.0 시스템은 수집된 500개 데이터(알파벳 등급)를 기반으로 정치인의 최종 점수(200~1,000점)를 계산합니다.

### 핵심 원칙

1. **알파벳 등급**: DB에 A~H로 저장
2. **숫자 변환**: 계산 시에만 숫자로 변환
3. **Prior 6.0**: 중립점 (평균 0 시 60점)
4. **Coefficient 0.5**: 변동 폭 조절
5. **반올림**: 소수점 이하 반올림

---

## 📐 알고리즘 상수

### Prior (사전 확률)
```python
PRIOR = 6.0
```

**의미**: 데이터가 없을 때의 기본 점수
- 평균 rating이 0일 때: (6.0 + 0 × 0.5) × 10 = **60점**
- 중립적 평가의 기준점

### Coefficient (계수)
```python
COEFFICIENT = 0.5
```

**의미**: Rating 변동의 영향력
- 평균 +1 증가 → 점수 +5점
- 평균 -1 감소 → 점수 -5점
- 과도한 변동 방지

### 알파벳 → 숫자 매핑
```python
ALPHABET_GRADES = {
    'A': 8,   # 최우수
    'B': 6,   # 우수
    'C': 4,   # 양호
    'D': 2,   # 보통
    'E': -2,  # 미흡
    'F': -4,  # 부족
    'G': -6,  # 상당히 부족
    'H': -8   # 매우 부족
}
```

**특징**:
- 긍정 범위: +2 ~ +8 (4단계)
- 부정 범위: -2 ~ -8 (4단계)
- 대칭 구조 (균형있는 평가)

---

## 📊 3단계 계산 프로세스

### 단계 1: 카테고리별 점수 계산

10개 카테고리 각각에 대해 동일한 방식으로 계산합니다.

#### Step 1-1: DB에서 알파벳 등급 조회

**SQL 쿼리**:
```sql
SELECT rating
FROM collected_data
WHERE politician_id = '62e7b453-9bb6-4f6e-ac3b-1e72a8b5e3f4'
  AND category_name = 'Expertise'
```

**결과 예시** (50개):
```python
['F', 'E', 'B', 'A', 'B', 'C', 'B', 'E', 'D', 'A', ...]
```

---

#### Step 1-2: 알파벳 → 숫자 변환

**변환 로직**:
```python
ratings_alphabet = ['F', 'E', 'B', 'A', 'B', 'C', 'B', 'E', 'D', 'A']
ratings_numeric = [ALPHABET_GRADES[r] for r in ratings_alphabet]
# 결과: [-4, -2, 6, 8, 6, 4, 6, -2, 2, 8]
```

**중요**: DB에서 읽은 알파벳을 메모리에서만 변환, DB는 알파벳 유지!

---

#### Step 1-3: 평균 계산

**공식**:
```
평균 = 합계 / 개수
```

**예시** (전문성):
```python
합계 = -4 + (-2) + 6 + 8 + ... (50개) = 178
개수 = 50
평균 = 178 / 50 = 3.56
```

---

#### Step 1-4: 카테고리 점수 계산

**공식**:
```
카테고리 점수 = (Prior + 평균 × Coefficient) × 10
```

**예시** (전문성):
```
점수 = (6.0 + 3.56 × 0.5) × 10
     = (6.0 + 1.78) × 10
     = 7.78 × 10
     = 77.80점
```

**점수 범위**:
- 최고: (6.0 + 8 × 0.5) × 10 = **100점** (평균 +8)
- 최저: (6.0 - 8 × 0.5) × 10 = **20점** (평균 -8)

---

### 단계 2: 총점 계산

#### Step 2-1: 10개 카테고리 점수 합산

**계산**:
```python
category_scores = [
    77.80,  # 전문성
    79.80,  # 리더십
    78.80,  # 비전
    73.20,  # 청렴성
    65.40,  # 윤리성
    75.60,  # 책임성
    76.80,  # 투명성
    73.00,  # 소통능력
    78.20,  # 대응성
    76.80   # 공익성
]

총합 = sum(category_scores) = 755.40점
```

---

#### Step 2-2: 상한 적용 (최대 1000점)

**공식**:
```python
capped_score = min(총합, 1000)
```

**예시**:
```python
capped_score = min(755.40, 1000) = 755.40점
```

**이유**:
- 카테고리별 최대 100점 × 10개 = 1000점
- 이론상 최대값 제한

---

#### Step 2-3: 반올림

**공식**:
```python
final_score = round(capped_score)
```

**예시**:
```python
final_score = round(755.40) = 755점
```

**V24.0 변경사항**:
- 이전: 소수점 유지 (755.40점)
- V24.0: 반올림 적용 (755점)

---

### 단계 3: 최종 등급 산정

#### 등급 매핑 테이블

| 점수 범위 | 등급 | 영문 | 한글 |
|-----------|------|------|------|
| 900~1,000 | L | Legendary | 전설 |
| 850~899 | Tn | Titanium | 최우수+ |
| 800~849 | I | Iridium | 최우수 |
| 750~799 | B | Bronze | 우수 |
| 700~749 | P | Platinum | 보통+ |
| 600~699 | S | Silver | 보통- |
| 500~599 | G | Gold | 미흡+ |
| 400~499 | E | Emerald | 미흡 |
| 300~399 | D | Diamond | 부족 |
| 200~299 | M | Marble | 매우 부족 |

**등급 산정 로직**:
```python
if final_score >= 900:
    grade = 'L'
elif final_score >= 850:
    grade = 'Tn'
elif final_score >= 800:
    grade = 'I'
elif final_score >= 750:
    grade = 'B'
...
```

**예시** (오세훈):
```
점수: 755점
등급: B (Bronze, 우수)
범위: 750~799점
```

---

## 🧮 전체 계산 예시 (오세훈)

### 입력 데이터
```
정치인: 오세훈
ID: 62e7b453-9bb6-4f6e-ac3b-1e72a8b5e3f4
데이터: 500개 (10개 카테고리 × 50개)
```

### 단계 1: 카테고리별 점수

| 카테고리 | 평균 Rating | 계산 | 점수 |
|---------|-------------|------|------|
| 전문성 | 3.56 | (6.0 + 3.56×0.5)×10 | 77.80 |
| 리더십 | 3.96 | (6.0 + 3.96×0.5)×10 | 79.80 |
| 비전 | 3.76 | (6.0 + 3.76×0.5)×10 | 78.80 |
| 청렴성 | 2.64 | (6.0 + 2.64×0.5)×10 | 73.20 |
| 윤리성 | 1.08 | (6.0 + 1.08×0.5)×10 | 65.40 |
| 책임성 | 3.12 | (6.0 + 3.12×0.5)×10 | 75.60 |
| 투명성 | 3.36 | (6.0 + 3.36×0.5)×10 | 76.80 |
| 소통능력 | 2.60 | (6.0 + 2.60×0.5)×10 | 73.00 |
| 대응성 | 3.64 | (6.0 + 3.64×0.5)×10 | 78.20 |
| 공익성 | 3.36 | (6.0 + 3.36×0.5)×10 | 76.80 |

### 단계 2: 총점 계산
```
합계: 755.40점
상한 적용: min(755.40, 1000) = 755.40점
반올림: round(755.40) = 755점
```

### 단계 3: 최종 등급
```
점수: 755점
등급: B (Bronze, 우수)
```

---

## 📈 점수 범위 분석

### 이론적 점수 범위

**최고점** (모든 카테고리 A 등급):
```
평균 = 8.0
카테고리 점수 = (6.0 + 8.0 × 0.5) × 10 = 100점
총점 = 100 × 10 = 1,000점
등급 = L (Legendary)
```

**최저점** (모든 카테고리 H 등급):
```
평균 = -8.0
카테고리 점수 = (6.0 - 8.0 × 0.5) × 10 = 20점
총점 = 20 × 10 = 200점
등급 = M (Marble)
```

**중립점** (모든 카테고리 평균 0):
```
평균 = 0.0
카테고리 점수 = (6.0 + 0.0 × 0.5) × 10 = 60점
총점 = 60 × 10 = 600점
등급 = S (Silver, 보통-)
```

### Prior 6.0의 의미

**Prior가 6.0인 이유**:
1. 중립점이 60점 (600점 총점)
2. 정규분포 가정 시 평균 부근
3. 긍정/부정 균형 유지

**Prior 변경의 영향**:
- Prior 6.5 → 6.0: 점수 범위 250~1,000 → 200~1,000
- 변별력 향상 (하한 50점 낮아짐)

---

## 🔍 검증 방법

### 점수 재계산 검증

**Python 코드**:
```python
from supabase import create_client
import os

# 1. 데이터 조회
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
response = supabase.table('collected_data') \
    .select('rating') \
    .eq('politician_id', politician_id) \
    .eq('category_name', 'Expertise') \
    .execute()

# 2. 알파벳 → 숫자 변환
ALPHABET_GRADES = {
    'A': 8, 'B': 6, 'C': 4, 'D': 2,
    'E': -2, 'F': -4, 'G': -6, 'H': -8
}
ratings = [ALPHABET_GRADES[r['rating']] for r in response.data]

# 3. 평균 계산
avg = sum(ratings) / len(ratings)

# 4. 점수 계산
score = (6.0 + avg * 0.5) * 10
print(f"전문성: {score:.2f}점")
```

### 수동 계산 예시

**카테고리 1개 검증** (전문성):
1. 50개 rating 수동 확인: A가 5개, B가 10개, C가 8개, ...
2. 숫자 변환: 8×5 + 6×10 + 4×8 + ... = 178
3. 평균: 178 / 50 = 3.56
4. 점수: (6.0 + 3.56×0.5) × 10 = 77.80점

---

## ⚠️ 주의사항

### 1. Rating 저장 형식
```python
# ❌ 금지 - DB에 숫자 저장
item['rating'] = 8

# ✅ 올바른 방법 - DB에 알파벳 저장
item['rating'] = 'A'

# ✅ 계산 시에만 숫자 변환
numeric = ALPHABET_GRADES[item['rating']]  # 'A' → 8
```

### 2. 반올림 시점
```python
# ❌ 잘못된 순서 - 카테고리마다 반올림
score1 = round((6.0 + 3.56 * 0.5) * 10)  # 78점
score2 = round((6.0 + 3.96 * 0.5) * 10)  # 80점
total = score1 + score2  # 오차 누적!

# ✅ 올바른 순서 - 마지막에만 반올림
score1 = (6.0 + 3.56 * 0.5) * 10  # 77.80점
score2 = (6.0 + 3.96 * 0.5) * 10  # 79.80점
total = round(score1 + score2)  # 158점 (정확)
```

### 3. 상한 적용 시점
```python
# ✅ 올바른 순서
total = sum(category_scores)  # 755.40
capped = min(total, 1000)     # 755.40
final = round(capped)          # 755

# ❌ 잘못된 순서 - 반올림 먼저
total = sum(category_scores)  # 755.40
rounded = round(total)         # 755
capped = min(rounded, 1000)   # 755 (동일하지만 논리적으로 틀림)
```

---

## 🔗 관련 문서

- **CLAUDE.md**: V24.0 작업 지침 (알고리즘 요약)
- **V24_수집지침_및_프로세스.md**: 데이터 수집 프로세스
- **등급체계_10단계_200-1000점_V24.md**: 등급 시스템 상세

---

## 📝 버전 히스토리

### V24.0 (2025-11-24)
- **Prior**: 6.5 → 6.0 변경
- **반올림**: 적용
- **점수 범위**: 250~1,000 → 200~1,000

### V23.0 (2025-11-20)
- **Rating 형식**: 숫자 → 알파벳 변경
- **등급 범위**: A~H (8단계) 확정

---

**최종 업데이트**: 2025-11-24
**버전**: V24.0
**상태**: 최종 승인
