"""
토큰 사용량 분석 및 최적화 방안
"""
import json

# 현재 프롬프트 구조 분석
with open('pooling_batch_summary_김동연.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

print("=" * 100)
print("현재 토큰 사용량 분석")
print("=" * 100)
print()

# 예상 토큰 계산 (대략적)
# 1 토큰 ≈ 4 characters (영문 기준)
# 한글은 1글자 ≈ 2-3 토큰

print("1. 입력 토큰 (Input Tokens)")
print("-" * 100)
print()

# 프롬프트 구조 (추정)
prompt_structure = """
시스템 프롬프트:
- 역할 설명: 100 토큰
- 평가 기준 설명: 200 토큰
- 출력 형식 지정: 150 토큰

뉴스 데이터 (배치당):
- 10개 뉴스 × 평균 500자 = 5,000자
- 5,000자 ≈ 2,500 토큰

카테고리 설명:
- 카테고리별 기준: 300 토큰

총 입력 토큰 (배치당): 450 + 2,500 + 300 = 3,250 토큰
"""

print(prompt_structure)
print()

print("2. 출력 토큰 (Output Tokens)")
print("-" * 100)
print()

output_structure = """
10개 뉴스 평가:
- 뉴스당 평가:
  * rating: 1 토큰 (A-H)
  * rating_rationale: 평균 100 토큰
  
- 10개 × 100 토큰 = 1,000 토큰

총 출력 토큰 (배치당): 1,000 토큰
"""

print(output_structure)
print()

print("3. 전체 토큰 사용량 (1명 정치인)")
print("-" * 100)
print()

total_calculation = """
1명 정치인:
- 카테고리: 10개
- 배치: 15개 (150개 뉴스 ÷ 10)
- AI: 3개

배치당 토큰:
- 입력: 3,250 토큰
- 출력: 1,000 토큰
- 합계: 4,250 토큰

1명당 총 토큰:
= 4,250 토큰 × 15 배치 × 10 카테고리 × 3 AI
= 4,250 × 450
= 1,912,500 토큰

27명 추가:
= 1,912,500 × 27
= 51,637,500 토큰 (약 5천만 토큰)

예상 비용 (GPT-4 기준):
- 입력: $10/1M 토큰
- 출력: $30/1M 토큰
- 입력 비용: 3,250 × 450 × 27 / 1,000,000 × 10 = $395
- 출력 비용: 1,000 × 450 × 27 / 1,000,000 × 30 = $365
- 총 비용: $760
"""

print(total_calculation)
print()

print("=" * 100)
print("토큰 최적화 방안")
print("=" * 100)
print()

optimization_1 = """
방안 1: 프롬프트 압축 (50% 절감)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

현재:
"당신은 정치인 평가 전문가입니다. 
다음 뉴스 기사들을 읽고 정치인의 [카테고리]에 대해 평가해주세요.
평가 기준은 다음과 같습니다:
1. 매우 긍정적: A (+8점)
2. 긍정적: B (+6점)
..."

최적화:
"평가 전문가. 뉴스 기반 정치인 [카테고리] 평가.
등급: A(+8) B(+6) C(+4) D(+2) E(-2) F(-4) G(-6) H(-8)"

토큰 절감: 450 → 100 토큰 (78% 감소)
"""

print(optimization_1)
print()

optimization_2 = """
방안 2: 뉴스 요약 (60% 절감)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

현재:
- 전체 뉴스 텍스트 전송 (평균 500자)
- 10개 × 500자 = 5,000자 ≈ 2,500 토큰

최적화:
- 핵심 문장만 추출 (200자)
- 10개 × 200자 = 2,000자 ≈ 1,000 토큰

구현:
def summarize_news(news_text):
    # 첫 문장 + 핵심 키워드만
    sentences = news_text.split('.')
    return sentences[0] + "..." + extract_keywords(news_text)

토큰 절감: 2,500 → 1,000 토큰 (60% 감소)
"""

print(optimization_2)
print()

optimization_3 = """
방안 3: rationale 생략 (80% 절감)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

현재:
{
  "rating": "A",
  "rating_rationale": "이 뉴스는 정치인의 전문성을 보여줍니다. 
                       경제 정책에 대한 깊은 이해와 실행력을 
                       입증하는 내용입니다..."
}

최적화:
{
  "rating": "A"
}

토큰 절감: 1,000 → 200 토큰 (80% 감소)

※ rationale은 디버깅용이었으므로 생략 가능
"""

print(optimization_3)
print()

optimization_4 = """
방안 4: 배치 크기 증가 (고정 비용 분산)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

현재 (배치 10개):
- 고정 프롬프트: 450 토큰
- 뉴스 데이터: 2,500 토큰
- 배치당 총: 2,950 토큰
- 15 배치 × 2,950 = 44,250 토큰

최적화 (배치 50개):
- 고정 프롬프트: 450 토큰 (동일)
- 뉴스 데이터: 12,500 토큰 (5배)
- 배치당 총: 12,950 토큰
- 3 배치 × 12,950 = 38,850 토큰

토큰 절감: 44,250 → 38,850 (12% 감소)

※ 고정 비용(프롬프트) 분산 효과
"""

print(optimization_4)
print()

optimization_5 = """
방안 5: 샘플링 (80% 절감)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

현재:
- 150개 뉴스 전체 평가
- 1,912,500 토큰

최적화:
- 30개 뉴스만 샘플링 (20%)
- 382,500 토큰

토큰 절감: 1,912,500 → 382,500 (80% 감소)

검증 필요:
- 30개로도 순위 일치도 유지되는지 확인
- ρ > 0.9 유지 시 채택
"""

print(optimization_5)
print()

print("=" * 100)
print("최적 조합")
print("=" * 100)
print()

optimal_combination = """
방안 1 + 2 + 3 + 4 조합
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 프롬프트 압축: 450 → 100 토큰
2. 뉴스 요약: 2,500 → 1,000 토큰  
3. rationale 생략: 1,000 → 200 토큰
4. 배치 크기 50개: 고정비용 분산

배치당 토큰 (50개 뉴스):
- 입력: 100 + (1,000 × 5) = 5,100 토큰
- 출력: 200 × 5 = 1,000 토큰
- 합계: 6,100 토큰

1명당 총 토큰:
= 6,100 × 3 배치 × 10 카테고리 × 3 AI
= 6,100 × 90
= 549,000 토큰

27명 추가:
= 549,000 × 27
= 14,823,000 토큰 (약 1천5백만 토큰)

비용:
- 입력: 5,100 × 90 × 27 / 1,000,000 × 10 = $124
- 출력: 1,000 × 90 × 27 / 1,000,000 × 30 = $73
- 총 비용: $197

절감율:
- 토큰: 51,637,500 → 14,823,000 (71% 감소)
- 비용: $760 → $197 (74% 감소)
"""

print(optimal_combination)
print()

print("=" * 100)
print("추가 최적화: 방안 5 포함")
print("=" * 100)
print()

with_sampling = """
방안 1 + 2 + 3 + 4 + 5 조합
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

샘플링 추가 (150개 → 30개):

1명당 총 토큰:
= 549,000 × 20% (샘플링)
= 109,800 토큰

27명 추가:
= 109,800 × 27
= 2,964,600 토큰 (약 3백만 토큰)

비용:
= $197 × 20%
= $39

최종 절감율:
- 토큰: 51,637,500 → 2,964,600 (94% 감소)
- 비용: $760 → $39 (95% 감소)
- 시간: 49시간 → 2시간 (96% 감소)

※ 단, 샘플링 검증 필수 (순위 일치도 확인)
"""

print(with_sampling)
print()

print("=" * 100)
print("우선순위별 실행 계획")
print("=" * 100)
print()

action_plan = """
즉시 실행 (코드 수정 최소):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. rationale 생략 (1줄 수정)
   output_format = {"rating": "A"}  # rationale 제거
   → 80% 출력 토큰 절감

2. 배치 크기 50개 (1줄 수정)
   BATCH_SIZE = 50  # 10 → 50
   → 12% 입력 토큰 절감

단기 실행 (1-2일):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
3. 프롬프트 압축 (프롬프트 재작성)
   → 78% 프롬프트 토큰 절감

4. 뉴스 요약 (전처리 함수 추가)
   → 60% 뉴스 토큰 절감

검증 후 실행 (3-4일):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
5. 샘플링 (통계적 검증 후)
   → 80% 전체 토큰 절감
"""

print(action_plan)

