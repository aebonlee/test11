# ì •ì¹˜ì¸ ê¸€ì“°ê¸°/ëŒ“ê¸€ ì¸ì¦ í”„ë¡œì„¸ìŠ¤

## ê°œìš”

ì •ì¹˜ì¸ì´ ê¸€/ëŒ“ê¸€ì„ ì‘ì„±í•  ë•Œ **ë“±ë¡ëœ ì •ì¹˜ì¸ì¸ì§€ í™•ì¸**í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì…ë‹ˆë‹¤.

**í•µì‹¬ ìš”êµ¬ì‚¬í•­:**
- âœ… ë“±ë¡ëœ ì •ì¹˜ì¸ë§Œ ê¸€ì“°ê¸° ê°€ëŠ¥
- âœ… ë³¸ì¸ ì¸ì¦ í•„ìš” (ì´ë©”ì¼ ì¸ì¦)
- âœ… í¸ë¦¬í•œ ì‚¬ìš©ì ê²½í—˜ (24ì‹œê°„ ì„¸ì…˜ ìœ ì§€)
- âœ… ì •ì¹˜ì¸ ì •ë³´ í‘œì‹œ (ì‹¤ëª… + ì§ìœ„ + ì •ë‹¹)

---

## í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°

### 1ï¸âƒ£ ìµœì´ˆ ê¸€ì“°ê¸° ì‹œë„

```
ì‚¬ìš©ìê°€ "ì •ì¹˜ì¸ìœ¼ë¡œ ê¸€ì“°ê¸°" ë²„íŠ¼ í´ë¦­
   â†“
ì •ì¹˜ì¸ ì„ íƒ í™”ë©´ (ë“œë¡­ë‹¤ìš´ ë˜ëŠ” ê²€ìƒ‰)
   â†“
ì •ì¹˜ì¸ ì„ íƒ (ì˜ˆ: "ì˜¤ì„¸í›ˆ - ì„œìš¸íŠ¹ë³„ì‹œì¥ - êµ­ë¯¼ì˜í˜")
   â†“
ì´ë©”ì¼ ì¸ì¦ í™”ë©´ìœ¼ë¡œ ì´ë™
```

### 2ï¸âƒ£ ì´ë©”ì¼ ì¸ì¦

```
POST /api/politicians/verify/send-code
{
  "name": "ì˜¤ì„¸í›ˆ",
  "party": "êµ­ë¯¼ì˜í˜",
  "position": "ì„œìš¸íŠ¹ë³„ì‹œì¥"
}
   â†“
ì •ì¹˜ì¸ ì´ë©”ì¼ë¡œ 6ìë¦¬ ì½”ë“œ ë°œì†¡ (wksun999@hanmail.net)
   â†“
ì‚¬ìš©ìê°€ ì´ë©”ì¼ì—ì„œ ì½”ë“œ í™•ì¸
   â†“
ì½”ë“œ ì…ë ¥ í™”ë©´ì—ì„œ 6ìë¦¬ ì½”ë“œ ì…ë ¥
   â†“
POST /api/politicians/verify/check-code
{
  "verification_id": "uuid",
  "code": "123456"
}
   â†“
âœ… ì¸ì¦ ì„±ê³µ
   â†“
24ì‹œê°„ ìœ íš¨í•œ ì„¸ì…˜ í† í° ë°œê¸‰
```

**ì‘ë‹µ:**
```json
{
  "success": true,
  "message": "ë³¸ì¸ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
  "politician_id": "62e7b453",
  "email": "wksun999@hanmail.net",
  "session_token": "a1b2c3d4e5f6... (64ìë¦¬ hex)",
  "expires_at": "2025-12-03T10:30:00Z"
}
```

### 3ï¸âƒ£ ì„¸ì…˜ í† í° ì €ì¥ (í´ë¼ì´ì–¸íŠ¸)

```javascript
// localStorageì— ì €ì¥
localStorage.setItem('politician_session', JSON.stringify({
  politician_id: '62e7b453',
  session_token: 'a1b2c3d4e5f6...',
  expires_at: '2025-12-03T10:30:00Z'
}));
```

### 4ï¸âƒ£ ê¸€ì“°ê¸°/ëŒ“ê¸€ ì‘ì„± (ì„¸ì…˜ í† í° ì‚¬ìš©)

```javascript
// ê¸€ì“°ê¸° API í˜¸ì¶œ
const session = JSON.parse(localStorage.getItem('politician_session'));

// ë§Œë£Œ í™•ì¸
if (new Date(session.expires_at) < new Date()) {
  // ì„¸ì…˜ ë§Œë£Œ â†’ ì¬ì¸ì¦ í•„ìš”
  alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
  return;
}

// ê¸€ì“°ê¸°
await fetch('/api/posts', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    politician_id: session.politician_id,
    session_token: session.session_token,
    subject: 'ì„œìš¸ì‹œ ì£¼ìš” ì •ì±… ì•ˆë‚´',  // title â†’ subjectë¡œ ë³€ê²½ë¨
    content: '...',
    author_type: 'politician'
  })
});
```

### 5ï¸âƒ£ ì„œë²„ ì¸¡ ì„¸ì…˜ ê²€ì¦ (API)

```typescript
// POST /api/posts
export async function POST(request: NextRequest) {
  const { politician_id, session_token, subject, content } = await request.json();

  // 1. ì„¸ì…˜ í† í° ìœ íš¨ì„± í™•ì¸
  const { data: session } = await supabase
    .from('politician_sessions')
    .select('*')
    .eq('politician_id', politician_id)
    .eq('session_token', session_token)
    .gt('expires_at', new Date().toISOString())
    .single();

  if (!session) {
    return NextResponse.json(
      { error: 'ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' },
      { status: 401 }
    );
  }

  // 2. ê¸€ì“°ê¸° ì§„í–‰
  const { data: post } = await supabase
    .from('posts')
    .insert({
      politician_id,
      user_id: null,  // ì •ì¹˜ì¸ì€ user_id NULL
      subject,
      content,
      author_type: 'politician'
    })
    .select()
    .single();

  // 3. ì„¸ì…˜ last_used_at ì—…ë°ì´íŠ¸
  await supabase
    .from('politician_sessions')
    .update({ last_used_at: new Date().toISOString() })
    .eq('id', session.id);

  return NextResponse.json({ success: true, post });
}
```

---

## ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### `posts` í…Œì´ë¸”

```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY,
  user_id UUID NULL REFERENCES users(id),          -- ì¼ë°˜ íšŒì› (NULLABLE)
  politician_id TEXT NULL REFERENCES politicians(id), -- ì •ì¹˜ì¸ (8-char hex)
  subject TEXT NOT NULL,                            -- ì œëª© (title â†’ subjectë¡œ ë³€ê²½)
  content TEXT NOT NULL,
  author_type TEXT DEFAULT 'user' CHECK (author_type IN ('user', 'politician')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT posts_author_check CHECK (user_id IS NOT NULL OR politician_id IS NOT NULL)
);
```

**í•µì‹¬ ê·œì¹™:**
- âœ… `user_id` OR `politician_id` ì¤‘ í•˜ë‚˜ëŠ” ë°˜ë“œì‹œ ì¡´ì¬
- âœ… ì •ì¹˜ì¸ ê¸€: `user_id = NULL`, `politician_id = '62e7b453'`
- âœ… íšŒì› ê¸€: `user_id = UUID`, `politician_id = NULL`
- âœ… `title` â†’ `subject`ë¡œ í•„ë“œëª… ë³€ê²½ (ì œëª© ì˜ë¯¸ ëª…í™•í™”)

### `comments` í…Œì´ë¸”

```sql
CREATE TABLE comments (
  id UUID PRIMARY KEY,
  post_id UUID NOT NULL REFERENCES posts(id),
  user_id UUID NULL REFERENCES users(id),          -- ì¼ë°˜ íšŒì› (NULLABLE)
  politician_id TEXT NULL REFERENCES politicians(id), -- ì •ì¹˜ì¸
  content TEXT NOT NULL,
  parent_comment_id UUID REFERENCES comments(id),  -- ëŒ€ëŒ“ê¸€
  author_type TEXT DEFAULT 'user' CHECK (author_type IN ('user', 'politician')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT comments_author_check CHECK (user_id IS NOT NULL OR politician_id IS NOT NULL)
);
```

### `politician_sessions` í…Œì´ë¸”

```sql
CREATE TABLE politician_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
  session_token TEXT UNIQUE NOT NULL,           -- 64ìë¦¬ hex
  expires_at TIMESTAMPTZ NOT NULL,              -- ë°œê¸‰ ì‹œê° + 24ì‹œê°„
  last_used_at TIMESTAMPTZ DEFAULT NOW(),       -- ë§ˆì§€ë§‰ ì‚¬ìš© ì‹œê°„
  created_at TIMESTAMPTZ DEFAULT NOW(),
  ip_address TEXT,                              -- ë³´ì•ˆ ê°•í™”ìš©
  user_agent TEXT                               -- ë³´ì•ˆ ê°•í™”ìš©
);
```

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ë°©ë²•

### ë°©ë²• 1: Supabase Dashboard ì‚¬ìš© (ê¶Œì¥)

1. Supabase Dashboard ì ‘ì† (https://supabase.com/dashboard)
2. í”„ë¡œì íŠ¸ ì„ íƒ (`ooddlafwdpzgxfefgsrx`)
3. **SQL Editor** ë©”ë‰´ í´ë¦­
4. `1_Frontend/migrations_to_apply.sql` íŒŒì¼ ë‚´ìš© ë³µì‚¬
5. SQL Editorì— ë¶™ì—¬ë„£ê¸°
6. **Run** ë²„íŠ¼ í´ë¦­
7. ì„±ê³µ ë©”ì‹œì§€ í™•ì¸

### ë°©ë²• 2: Supabase CLI ì‚¬ìš©

```bash
cd 0-4_Database/Supabase
npx supabase link
npx supabase db push
```

---

## í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„ ê°€ì´ë“œ

### 1. ì •ì¹˜ì¸ ì„ íƒ ì»´í¬ë„ŒíŠ¸

```tsx
// components/PoliticianSelector.tsx
'use client';

import { useState } from 'react';

export function PoliticianSelector({ onSelect }: { onSelect: (politician: any) => void }) {
  const [politicians, setPoliticians] = useState([]);

  // ì •ì¹˜ì¸ ëª©ë¡ ë¡œë“œ
  useEffect(() => {
    fetch('/api/politicians')
      .then(res => res.json())
      .then(data => setPoliticians(data));
  }, []);

  return (
    <select onChange={(e) => {
      const politician = politicians.find(p => p.id === e.target.value);
      onSelect(politician);
    }}>
      <option value="">ì •ì¹˜ì¸ ì„ íƒ</option>
      {politicians.map(p => (
        <option key={p.id} value={p.id}>
          {p.name} - {p.position} - {p.party}
        </option>
      ))}
    </select>
  );
}
```

### 2. ì´ë©”ì¼ ì¸ì¦ ì»´í¬ë„ŒíŠ¸

```tsx
// components/PoliticianAuth.tsx
'use client';

export function PoliticianAuth({ politician }: { politician: any }) {
  const [verificationId, setVerificationId] = useState('');
  const [code, setCode] = useState('');

  const sendCode = async () => {
    const res = await fetch('/api/politicians/verify/send-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: politician.name,
        party: politician.party,
        position: politician.position
      })
    });
    const data = await res.json();
    setVerificationId(data.verification_id);
  };

  const checkCode = async () => {
    const res = await fetch('/api/politicians/verify/check-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ verification_id: verificationId, code })
    });
    const data = await res.json();

    if (data.success) {
      // ì„¸ì…˜ í† í° ì €ì¥
      localStorage.setItem('politician_session', JSON.stringify({
        politician_id: data.politician_id,
        session_token: data.session_token,
        expires_at: data.expires_at
      }));

      alert('ì¸ì¦ ì™„ë£Œ! ê¸€ì“°ê¸°ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }
  };

  return (
    <div>
      <button onClick={sendCode}>ì¸ì¦ ì½”ë“œ ë°œì†¡</button>
      <input
        value={code}
        onChange={(e) => setCode(e.target.value)}
        placeholder="6ìë¦¬ ì½”ë“œ ì…ë ¥"
      />
      <button onClick={checkCode}>ì¸ì¦ í™•ì¸</button>
    </div>
  );
}
```

### 3. ê¸€ì“°ê¸° ì»´í¬ë„ŒíŠ¸

```tsx
// components/PoliticianPostForm.tsx
'use client';

export function PoliticianPostForm() {
  const [subject, setSubject] = useState('');
  const [content, setContent] = useState('');

  const submitPost = async () => {
    const session = JSON.parse(localStorage.getItem('politician_session') || '{}');

    // ì„¸ì…˜ ë§Œë£Œ í™•ì¸
    if (new Date(session.expires_at) < new Date()) {
      alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
      return;
    }

    const res = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        politician_id: session.politician_id,
        session_token: session.session_token,
        subject,
        content,
        author_type: 'politician'
      })
    });

    const data = await res.json();
    if (data.success) {
      alert('ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
  };

  return (
    <form onSubmit={(e) => { e.preventDefault(); submitPost(); }}>
      <input
        value={subject}
        onChange={(e) => setSubject(e.target.value)}
        placeholder="ì œëª© (subject)"  {/* title â†’ subject */}
      />
      <textarea
        value={content}
        onChange={(e) => setContent(e.target.value)}
        placeholder="ë‚´ìš©"
      />
      <button type="submit">ê¸€ ì‘ì„±</button>
    </form>
  );
}
```

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. ì„¸ì…˜ í† í° ë³´ì•ˆ

- âœ… 64ìë¦¬ hex (32 bytes random) - ì¶©ë¶„íˆ ì•ˆì „
- âœ… 24ì‹œê°„ ìë™ ë§Œë£Œ
- âœ… IP ì£¼ì†Œ ê¸°ë¡ (ì„ íƒì )
- âœ… User-Agent ê¸°ë¡ (ì„ íƒì )

### 2. XSS ë°©ì§€

```typescript
// í•­ìƒ ì‚¬ìš©ì ì…ë ¥ì„ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
import DOMPurify from 'isomorphic-dompurify';

const sanitizedContent = DOMPurify.sanitize(content);
```

### 3. CSRF ë°©ì§€

- âœ… Next.js API RoutesëŠ” ê¸°ë³¸ì ìœ¼ë¡œ CSRF ë³´í˜¸
- âœ… ì„¸ì…˜ í† í°ì´ ì¶”ê°€ ë³´ì•ˆ ë ˆì´ì–´ ì—­í• 

---

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© í™•ì¸

```bash
cd 1_Frontend
node test_politician_posting.js
```

### 2. ì˜ˆìƒ ê²°ê³¼

```
ğŸš€ ì •ì¹˜ì¸ ê²Œì‹œê¸€ & ëŒ“ê¸€ ì‘ì„± í†µí•© í…ŒìŠ¤íŠ¸

ì •ì¹˜ì¸: ì˜¤ì„¸í›ˆ (êµ­ë¯¼ì˜í˜)
ì§ìœ„: ì„œìš¸íŠ¹ë³„ì‹œì¥
ID: 62e7b453

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ STEP 1: ì •ì¹˜ì¸ ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë°œì†¡

   HTTP Status: 200
   âœ… ì¸ì¦ ì½”ë“œ ë°œì†¡ ì„±ê³µ!
   Verification ID: uuid

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ STEP 2: DBì—ì„œ ì¸ì¦ ì½”ë“œ í™•ì¸

   âœ… ì¸ì¦ ì½”ë“œ: 123456
   âœ… ì •ì¹˜ì¸ ID: 62e7b453
   âœ… ì´ë©”ì¼: wksun999@hanmail.net

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Œ STEP 3: ì¸ì¦ ì½”ë“œ í™•ì¸

   HTTP Status: 200
   âœ… ì¸ì¦ ì™„ë£Œ!
   âœ… ì„¸ì…˜ í† í° ë°œê¸‰ ì„±ê³µ!
   í† í°: a1b2c3d4e5f6g7h8... (64ìë¦¬)
   ë§Œë£Œ: 2025-12-03T10:30:00Z (24ì‹œê°„ ìœ íš¨)

...
```

---

## ìš”ì•½

### í•µì‹¬ ë³€ê²½ ì‚¬í•­

1. âœ… **posts.title â†’ posts.subject** í•„ë“œëª… ë³€ê²½
2. âœ… **posts.user_id â†’ NULLABLE** (ì •ì¹˜ì¸ì€ NULL)
3. âœ… **comments.user_id â†’ NULLABLE** (ì •ì¹˜ì¸ì€ NULL)
4. âœ… **comments.politician_id ì¶”ê°€**
5. âœ… **politician_sessions í…Œì´ë¸” ìƒì„±**
6. âœ… **check-code APIì— ì„¸ì…˜ í† í° ë°œê¸‰ ê¸°ëŠ¥ ì¶”ê°€**

### ì •ì¹˜ì¸ ê¸€ì“°ê¸° í”„ë¡œì„¸ìŠ¤

```
ì •ì¹˜ì¸ ì„ íƒ â†’ ì´ë©”ì¼ ì¸ì¦ â†’ ì„¸ì…˜ í† í° ë°œê¸‰ â†’ 24ì‹œê°„ ë™ì•ˆ ììœ ë¡­ê²Œ ê¸€ì“°ê¸°
```

### ë°ì´í„° êµ¬ì¡°

```
posts (í†µí•© í…Œì´ë¸”)
â”œâ”€ ì •ì¹˜ì¸ ê¸€: user_id=NULL, politician_id='62e7b453'
â””â”€ íšŒì› ê¸€: user_id=UUID, politician_id=NULL

comments (í†µí•© í…Œì´ë¸”)
â”œâ”€ ì •ì¹˜ì¸ ëŒ“ê¸€: user_id=NULL, politician_id='62e7b453'
â””â”€ íšŒì› ëŒ“ê¸€: user_id=UUID, politician_id=NULL
```

### ë³´ì•ˆ

- âœ… ë“±ë¡ëœ ì •ì¹˜ì¸ë§Œ ê¸€ì“°ê¸° ê°€ëŠ¥ (ì´ë©”ì¼ ì¸ì¦)
- âœ… ì„¸ì…˜ í† í°ìœ¼ë¡œ ë³¸ì¸ í™•ì¸
- âœ… 24ì‹œê°„ ìë™ ë§Œë£Œ
- âœ… IP + User-Agent ê¸°ë¡ (ê°ì‚¬ ì¶”ì )
