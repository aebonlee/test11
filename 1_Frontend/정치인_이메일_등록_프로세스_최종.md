# 정치인 이메일 등록 프로세스 (최종 확정)

## 핵심 개념

**기존 문제:**
- ❌ `politicians.email` = 검증 안 된 테스트 데이터
- ❌ 실제로 그 이메일로 받을 수 있는지 확인 불가
- ❌ 쓸모없는 데이터

**해결 방안:**
- ✅ 정치인이 **직접 이메일 입력**
- ✅ **인증 코드로 검증** (실제로 받을 수 있는 이메일)
- ✅ **검증된 이메일만** `verified_email`에 저장
- ✅ `verified_email`을 정치인의 **계정 ID**로 사용

---

## 프로세스 플로우

### 1️⃣ 최초 글쓰기 (이메일 등록)

```
정치인이 "글쓰기" 버튼 클릭
   ↓
정치인 선택 (드롭다운)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   정치인을 선택하세요

   [ 오세훈 - 서울특별시장 - 국민의힘 ]

   [다음]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ↓
이메일 입력 화면
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   본인 확인을 위해 이메일 주소를 입력하세요

   입력하신 이메일로 인증 코드가 발송되며,
   인증 완료 후 이 이메일이 귀하의 계정으로 등록됩니다.

   [____________________] 이메일 입력

   [인증 코드 발송]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ↓
POST /api/politicians/verify/send-code
{
  "politician_id": "62e7b453",
  "email": "sehun.oh@seoul.go.kr"
}
   ↓
✅ 이메일로 6자리 코드 발송
   ↓
코드 입력 화면
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   sehun.oh@seoul.go.kr 으로
   인증 코드를 발송했습니다.

   [_ _ _ _ _ _] 6자리 코드 입력

   [확인]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ↓
POST /api/politicians/verify/check-code
{
  "verification_id": "uuid",
  "code": "A1B2C3"
}
   ↓
✅ 인증 성공
   ↓
1. politicians.verified_email = 'sehun.oh@seoul.go.kr' 저장
2. politicians.email_verified_at = NOW() 저장
3. 세션 토큰 발급 (24시간 유효)
   ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ✅ 본인 인증이 완료되었습니다!

   이제 글쓰기가 가능합니다.
   이 이메일로 24시간 동안 인증 없이
   글을 작성하실 수 있습니다.

   [글쓰기 시작]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 2️⃣ 이후 글쓰기 (이미 등록된 경우)

```
정치인이 "글쓰기" 버튼 클릭
   ↓
정치인 선택 (오세훈)
   ↓
이메일 입력 화면
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   본인 확인을 위해 등록된 이메일을 입력하세요

   [____________________] 이메일 입력

   [인증 코드 발송]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ↓
이메일 입력: sehun.oh@seoul.go.kr
   ↓
POST /api/politicians/verify/send-code
{
  "politician_id": "62e7b453",
  "email": "sehun.oh@seoul.go.kr"
}
   ↓
✅ verified_email과 일치 확인
   ↓
인증 코드 발송
   ↓
코드 입력 및 확인
   ↓
✅ 인증 성공
   ↓
세션 토큰 발급 (24시간)
   ↓
글쓰기 가능
```

### 3️⃣ 잘못된 이메일 입력 (거부)

```
정치인 선택: 오세훈
(verified_email = 'sehun.oh@seoul.go.kr' 이미 등록됨)
   ↓
이메일 입력: wrong@email.com (다른 이메일)
   ↓
POST /api/politicians/verify/send-code
{
  "politician_id": "62e7b453",
  "email": "wrong@email.com"
}
   ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ❌ 등록된 이메일과 일치하지 않습니다

   오세훈 정치인은 다른 이메일로 이미 등록되어 있습니다.

   등록된 이메일: seh***@seoul.go.kr

   [다시 입력]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 데이터베이스 구조

### `politicians` 테이블

```sql
CREATE TABLE politicians (
  id TEXT PRIMARY KEY,  -- '62e7b453' (8-char hex)
  name TEXT NOT NULL,
  party TEXT NOT NULL,
  position TEXT NOT NULL,

  -- 기존 필드 (무시, 테스트용)
  email TEXT,  -- ⚠️ 검증 안 됨, 사용 안 함

  -- 새로운 필드 (실제 사용)
  verified_email TEXT UNIQUE,  -- ✅ 검증된 이메일 (계정 ID)
  email_verified_at TIMESTAMPTZ,  -- 최초 인증 시간

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_politicians_verified_email ON politicians(verified_email);
```

**필드 설명:**
- `email`: 기존 필드, 테스트용, **사용하지 않음**
- `verified_email`: 정치인이 직접 인증한 이메일, **실제 계정 ID로 사용**
- `email_verified_at`: 최초 인증 완료 시간

**규칙:**
- ✅ `verified_email`은 UNIQUE (1개 이메일 = 1명 정치인)
- ✅ 최초 NULL → 첫 글쓰기 시 인증하면 저장
- ✅ 한 번 저장되면 변경 불가 (보안)

### `posts` 테이블

```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY,
  user_id UUID NULL REFERENCES users(id),  -- 일반 회원
  politician_id TEXT NULL REFERENCES politicians(id),  -- 정치인
  subject TEXT NOT NULL,  -- 제목 (title → subject로 변경)
  content TEXT NOT NULL,
  author_type TEXT DEFAULT 'user' CHECK (author_type IN ('user', 'politician')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT posts_author_check CHECK (user_id IS NOT NULL OR politician_id IS NOT NULL)
);
```

### `politician_sessions` 테이블

```sql
CREATE TABLE politician_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
  session_token TEXT UNIQUE NOT NULL,  -- 64자리 hex
  expires_at TIMESTAMPTZ NOT NULL,  -- 발급 시각 + 24시간
  last_used_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  ip_address TEXT,
  user_agent TEXT
);
```

---

## API 명세

### 1. POST /api/politicians/verify/send-code

**Request:**
```json
{
  "politician_id": "62e7b453",
  "email": "sehun.oh@seoul.go.kr"
}
```

**Response (성공):**
```json
{
  "success": true,
  "message": "인증 코드가 이메일로 발송되었습니다.",
  "verification_id": "uuid",
  "email": "seh***@seoul.go.kr",
  "expires_at": "2025-12-02T11:00:00Z",
  "is_first_time": true
}
```

**Response (이메일 불일치):**
```json
{
  "error": "등록된 이메일과 일치하지 않습니다.",
  "message": "오세훈 정치인은 다른 이메일로 이미 등록되어 있습니다.",
  "registered_email": "seh***@seoul.go.kr"
}
```

**프로세스:**
1. `politician_id`로 정치인 조회
2. `verified_email` 확인
   - NULL → 최초 등록 (어떤 이메일이든 OK)
   - 값 있음 → 일치 확인 (불일치 시 403 오류)
3. 6자리 코드 생성 및 발송
4. `email_verifications` 테이블에 저장

### 2. POST /api/politicians/verify/check-code

**Request:**
```json
{
  "verification_id": "uuid",
  "code": "A1B2C3"
}
```

**Response:**
```json
{
  "success": true,
  "message": "본인 인증이 완료되었습니다.",
  "verified": true,
  "politician_id": "62e7b453",
  "email": "sehun.oh@seoul.go.kr",
  "session_token": "a1b2c3d4e5f6... (64자리 hex)",
  "expires_at": "2025-12-03T10:30:00Z",
  "is_first_time": true
}
```

**프로세스:**
1. 인증 코드 확인
2. **최초 인증인 경우:**
   - `politicians.verified_email` = 이메일 저장
   - `politicians.email_verified_at` = NOW() 저장
3. 세션 토큰 발급 (24시간)
4. `politician_sessions` 테이블에 저장

---

## 프론트엔드 구현 예시

### 1. 정치인 선택 + 이메일 입력

```tsx
'use client';

import { useState } from 'react';

export function PoliticianAuthForm() {
  const [politicianId, setPoliticianId] = useState('');
  const [email, setEmail] = useState('');
  const [verificationId, setVerificationId] = useState('');
  const [code, setCode] = useState('');
  const [step, setStep] = useState(1); // 1: 선택, 2: 이메일, 3: 코드

  const politicians = [
    { id: '62e7b453', name: '오세훈', party: '국민의힘', position: '서울특별시장' },
    // ...
  ];

  const sendCode = async () => {
    const res = await fetch('/api/politicians/verify/send-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ politician_id: politicianId, email })
    });

    const data = await res.json();

    if (res.ok) {
      setVerificationId(data.verification_id);
      setStep(3);
      alert(`${data.email} 으로 인증 코드를 발송했습니다.`);
    } else {
      alert(data.error + '\n' + (data.message || ''));
    }
  };

  const checkCode = async () => {
    const res = await fetch('/api/politicians/verify/check-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ verification_id: verificationId, code })
    });

    const data = await res.json();

    if (res.ok) {
      // 세션 토큰 저장
      localStorage.setItem('politician_session', JSON.stringify({
        politician_id: data.politician_id,
        session_token: data.session_token,
        expires_at: data.expires_at
      }));

      if (data.is_first_time) {
        alert('✅ 이메일 등록 및 인증이 완료되었습니다!');
      } else {
        alert('✅ 인증 완료! 글쓰기가 가능합니다.');
      }

      // 글쓰기 페이지로 이동
      window.location.href = '/posts/new';
    } else {
      alert(data.error);
    }
  };

  return (
    <div>
      {step === 1 && (
        <div>
          <h2>정치인 선택</h2>
          <select value={politicianId} onChange={(e) => setPoliticianId(e.target.value)}>
            <option value="">선택하세요</option>
            {politicians.map(p => (
              <option key={p.id} value={p.id}>
                {p.name} - {p.position} - {p.party}
              </option>
            ))}
          </select>
          <button onClick={() => setStep(2)} disabled={!politicianId}>
            다음
          </button>
        </div>
      )}

      {step === 2 && (
        <div>
          <h2>이메일 입력</h2>
          <p>본인 확인을 위해 이메일 주소를 입력하세요.</p>
          <p>입력하신 이메일로 인증 코드가 발송되며,<br />
             인증 완료 후 이 이메일이 귀하의 계정으로 등록됩니다.</p>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="email@example.com"
          />
          <button onClick={sendCode} disabled={!email}>
            인증 코드 발송
          </button>
        </div>
      )}

      {step === 3 && (
        <div>
          <h2>인증 코드 입력</h2>
          <p>{email} 으로 인증 코드를 발송했습니다.</p>
          <input
            value={code}
            onChange={(e) => setCode(e.target.value.toUpperCase())}
            placeholder="A1B2C3"
            maxLength={6}
          />
          <button onClick={checkCode} disabled={code.length !== 6}>
            확인
          </button>
        </div>
      )}
    </div>
  );
}
```

---

## 마이그레이션 적용 방법

### Supabase Dashboard에서 실행

1. Supabase Dashboard 접속
2. SQL Editor 메뉴 클릭
3. `1_Frontend/migrations_to_apply.sql` 내용 복사
4. SQL Editor에 붙여넣기
5. **Run** 버튼 클릭

### 주요 변경 사항

```sql
-- 1. politicians 테이블에 verified_email 추가
ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS verified_email TEXT UNIQUE;

ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS email_verified_at TIMESTAMPTZ;

-- 2. posts.title → subject
ALTER TABLE posts RENAME COLUMN title TO subject;

-- 3. posts.user_id → NULLABLE
ALTER TABLE posts ALTER COLUMN user_id DROP NOT NULL;

-- 4. politician_sessions 테이블 생성
CREATE TABLE politician_sessions (...);
```

---

## 보안 고려사항

### 1. 이메일 중복 방지

```sql
-- verified_email은 UNIQUE 제약
ALTER TABLE politicians
  ADD COLUMN verified_email TEXT UNIQUE;
```

- ✅ 1개 이메일 = 1명 정치인
- ✅ 다른 정치인이 같은 이메일 사용 불가

### 2. 이메일 변경 불가

- ✅ 한 번 등록된 `verified_email`은 변경 불가
- ✅ 변경 필요 시 → 관리자가 DB에서 수동 변경
- ✅ 보안 강화

### 3. 세션 토큰 보안

- ✅ 64자리 hex (32 bytes random)
- ✅ 24시간 자동 만료
- ✅ IP + User-Agent 기록

---

## 테스트 방법

### 1. 최초 등록 테스트

```javascript
// 1. 정치인 선택
const politician_id = '62e7b453';  // 오세훈

// 2. 이메일 입력 및 코드 발송
const sendRes = await fetch('/api/politicians/verify/send-code', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    politician_id: '62e7b453',
    email: 'test@example.com'
  })
});

const sendData = await sendRes.json();
console.log(sendData);
// { success: true, verification_id: 'uuid', is_first_time: true }

// 3. DB에서 코드 확인 (테스트용)
// SELECT * FROM email_verifications WHERE id = 'uuid';

// 4. 코드 입력 및 확인
const checkRes = await fetch('/api/politicians/verify/check-code', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    verification_id: sendData.verification_id,
    code: '코드'
  })
});

const checkData = await checkRes.json();
console.log(checkData);
// { success: true, session_token: '...', is_first_time: true }

// 5. DB 확인
// SELECT verified_email FROM politicians WHERE id = '62e7b453';
// → 'test@example.com'
```

### 2. 이미 등록된 경우 테스트

```javascript
// 같은 이메일로 재인증 → 성공
await fetch('/api/politicians/verify/send-code', {
  method: 'POST',
  body: JSON.stringify({
    politician_id: '62e7b453',
    email: 'test@example.com'  // 등록된 이메일
  })
});
// ✅ 성공

// 다른 이메일로 시도 → 실패
await fetch('/api/politicians/verify/send-code', {
  method: 'POST',
  body: JSON.stringify({
    politician_id: '62e7b453',
    email: 'wrong@example.com'  // 다른 이메일
  })
});
// ❌ 403 오류: "등록된 이메일과 일치하지 않습니다"
```

---

## 요약

### 핵심 변경 사항

1. ✅ **`politicians.verified_email` 추가** (검증된 이메일)
2. ✅ **`politicians.email_verified_at` 추가** (최초 인증 시간)
3. ✅ **`politicians.email` 무시** (테스트용, 사용 안 함)
4. ✅ **send-code API 수정** (politician_id + email 입력받음)
5. ✅ **check-code API 수정** (verified_email 저장)
6. ✅ **posts.title → subject** 필드명 변경

### 프로세스

```
정치인 선택
   ↓
이메일 입력 (정치인이 직접 입력)
   ↓
인증 코드 발송
   ↓
코드 확인
   ↓
✅ verified_email 저장 (최초 1회)
   ↓
24시간 세션 토큰 발급
   ↓
글쓰기 가능
```

### 보안

- ✅ 검증된 이메일만 사용
- ✅ 이메일 중복 불가 (UNIQUE)
- ✅ 이메일 변경 불가
- ✅ 24시간 세션 자동 만료
