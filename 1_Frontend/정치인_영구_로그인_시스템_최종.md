# ì •ì¹˜ì¸ ì˜êµ¬ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ (ìµœì¢… í™•ì •)

## í•µì‹¬ ê°œë…

**í•œë²ˆ ì¸ì¦í•˜ë©´ ì˜êµ¬ ì‚¬ìš©!**
- âœ… ìµœì´ˆ 1íšŒë§Œ ì´ë©”ì¼ ì¸ì¦
- âœ… ì´í›„ë¡œëŠ” ì¬ì¸ì¦ í•„ìš” ì—†ìŒ
- âœ… ê¸€ì“°ê¸°/ëŒ“ê¸€ ì‘ì„± ììœ ë¡­ê²Œ ê°€ëŠ¥
- âœ… ì„¸ì…˜ í† í° ì˜êµ¬ ìœ íš¨ (ë§Œë£Œ ì—†ìŒ)

---

## í”„ë¡œì„¸ìŠ¤ í”Œë¡œìš°

### ğŸ¯ ìµœì´ˆ ê¸€ì“°ê¸° (1íšŒë§Œ)

```
1. ê¸€ì“°ê¸° ë²„íŠ¼ í´ë¦­
   â†“
2. ì •ì¹˜ì¸ ì„ íƒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ëˆ„êµ¬ì˜ ì´ë¦„ìœ¼ë¡œ ê¸€ì„ ì‘ì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?

   [ ì˜¤ì„¸í›ˆ - ì„œìš¸íŠ¹ë³„ì‹œì¥ - êµ­ë¯¼ì˜í˜ â–¼ ]

   [ë‹¤ìŒ]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   â†“
3. ì´ë©”ì¼ ì…ë ¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”

   ğŸ“§ [_________________________]

   â„¹ï¸ ì´ ì´ë©”ì¼ë¡œ í•œë²ˆë§Œ ì¸ì¦í•˜ì‹œë©´
      ì´í›„ ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   [ì¸ì¦ ì½”ë“œ ë°œì†¡]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   â†“
4. ì¸ì¦ ì½”ë“œ ì…ë ¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   seh***@seoul.go.kr ìœ¼ë¡œ
   ì¸ì¦ ì½”ë“œë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.

   [_ _ _ _ _ _]

   [í™•ì¸]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   â†“
5. âœ… ì¸ì¦ ì™„ë£Œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

   ì˜¤ì„¸í›ˆë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.

   ì´ì œ ì–¸ì œë“ ì§€ ììœ ë¡­ê²Œ
   ê¸€ì„ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   [ê¸€ì“°ê¸° ì‹œì‘]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### âš¡ ì´í›„ ê¸€ì“°ê¸° (2íšŒì°¨ë¶€í„°)

```
1. ê¸€ì“°ê¸° ë²„íŠ¼ í´ë¦­
   â†“
2. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¸ì…˜ í™•ì¸
   â†“
3. âœ… ì„¸ì…˜ ìœ íš¨ (ì˜êµ¬)
   â†“
4. **ë°”ë¡œ ê¸€ì“°ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™!**
   (ì¸ì¦ ê³¼ì • ì™„ì „ ìƒëµ)
```

**í™”ë©´:**
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   ê¸€ì“°ê¸° - ì˜¤ì„¸í›ˆ (ì„œìš¸íŠ¹ë³„ì‹œì¥)

   ì œëª©:
   [________________________________]

   ë‚´ìš©:
   [                                ]
   [________________________________]

   [ì‘ì„± ì™„ë£Œ]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### `politicians` í…Œì´ë¸”

```sql
CREATE TABLE politicians (
  id TEXT PRIMARY KEY,  -- '62e7b453'
  name TEXT NOT NULL,
  party TEXT NOT NULL,
  position TEXT NOT NULL,

  -- ê¸°ì¡´ í•„ë“œ (ë¬´ì‹œ)
  email TEXT,  -- í…ŒìŠ¤íŠ¸ìš©, ì‚¬ìš© ì•ˆ í•¨

  -- ì¸ì¦ëœ ì´ë©”ì¼ (ì˜êµ¬ ê³„ì •)
  verified_email TEXT UNIQUE,  -- í•œë²ˆ ì¸ì¦í•œ ì´ë©”ì¼
  email_verified_at TIMESTAMPTZ,  -- ìµœì´ˆ ì¸ì¦ ì‹œê°„

  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### `politician_sessions` í…Œì´ë¸”

```sql
CREATE TABLE politician_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id TEXT NOT NULL REFERENCES politicians(id),
  session_token TEXT UNIQUE NOT NULL,  -- 64ìë¦¬ hex
  expires_at TIMESTAMPTZ NOT NULL,  -- 2099-12-31 (ì˜êµ¬)
  last_used_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**í•µì‹¬:**
- `expires_at = 2099-12-31` â†’ **ì˜êµ¬ ì‚¬ìš©**
- ì„¸ì…˜ í† í°ì€ í•œë²ˆ ë°œê¸‰ë˜ë©´ ë§Œë£Œë˜ì§€ ì•ŠìŒ

---

## API ëª…ì„¸

### POST /api/politicians/verify/send-code

**Request:**
```json
{
  "politician_id": "62e7b453",
  "email": "sehun.oh@seoul.go.kr"
}
```

**Response:**
```json
{
  "success": true,
  "verification_id": "uuid",
  "email": "seh***@seoul.go.kr",
  "is_first_time": true
}
```

### POST /api/politicians/verify/check-code

**Request:**
```json
{
  "verification_id": "uuid",
  "code": "A1B2C3"
}
```

**Response:**
```json
{
  "success": true,
  "politician_id": "62e7b453",
  "email": "sehun.oh@seoul.go.kr",
  "session_token": "a1b2c3d4...",
  "expires_at": "2099-12-31T23:59:59Z",  // ì˜êµ¬!
  "is_first_time": true
}
```

### POST /api/posts (ê¸€ì“°ê¸°)

**Request:**
```json
{
  "politician_id": "62e7b453",
  "session_token": "a1b2c3d4...",
  "subject": "ì œëª©",
  "content": "ë‚´ìš©",
  "author_type": "politician"
}
```

**ì„œë²„ ê²€ì¦:**
```javascript
// ì„¸ì…˜ í† í° í™•ì¸
const { data: session } = await supabase
  .from('politician_sessions')
  .select('*')
  .eq('politician_id', politician_id)
  .eq('session_token', session_token)
  .gt('expires_at', new Date().toISOString())  // 2099ë…„ê¹Œì§€ í•­ìƒ ìœ íš¨
  .single();

if (session) {
  // âœ… ê¸€ì“°ê¸° ì§„í–‰
}
```

---

## í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 1. ìµœì´ˆ ì¸ì¦ (AuthForm.tsx)

```tsx
'use client';

import { useState } from 'react';

export function PoliticianAuthForm() {
  const [politicianId, setPoliticianId] = useState('');
  const [email, setEmail] = useState('');
  const [code, setCode] = useState('');
  const [step, setStep] = useState(1);

  const sendCode = async () => {
    const res = await fetch('/api/politicians/verify/send-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ politician_id: politicianId, email })
    });

    const data = await res.json();
    if (res.ok) {
      setStep(3);
      alert(`${data.email}ìœ¼ë¡œ ì¸ì¦ ì½”ë“œë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.`);
    }
  };

  const checkCode = async () => {
    const res = await fetch('/api/politicians/verify/check-code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ verification_id: verificationId, code })
    });

    const data = await res.json();
    if (res.ok) {
      // ì„¸ì…˜ í† í° ì €ì¥ (ì˜êµ¬)
      localStorage.setItem('politician_session', JSON.stringify({
        politician_id: data.politician_id,
        session_token: data.session_token,
        expires_at: data.expires_at  // 2099-12-31
      }));

      alert('âœ… ì¸ì¦ ì™„ë£Œ! ì´ì œ ì–¸ì œë“  ê¸€ì„ ì‘ì„±í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      window.location.href = '/posts/new';
    }
  };

  return (
    // ... UI
  );
}
```

### 2. ê¸€ì“°ê¸° (PostForm.tsx)

```tsx
'use client';

import { useState, useEffect } from 'react';

export function PostForm() {
  const [session, setSession] = useState(null);
  const [subject, setSubject] = useState('');
  const [content, setContent] = useState('');

  useEffect(() => {
    // ì„¸ì…˜ í™•ì¸
    const savedSession = localStorage.getItem('politician_session');
    if (savedSession) {
      const sessionData = JSON.parse(savedSession);

      // ë§Œë£Œ í™•ì¸ (2099ë…„ì´ë¯€ë¡œ í•­ìƒ ìœ íš¨)
      const expiresAt = new Date(sessionData.expires_at);
      const now = new Date();

      if (now < expiresAt) {
        setSession(sessionData);
      } else {
        // ë§Œë£Œë¨ (ì‹¤ì œë¡œëŠ” 2099ë…„ê¹Œì§€ ë°œìƒ ì•ˆ í•¨)
        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì¸ì¦í•´ì£¼ì„¸ìš”.');
        window.location.href = '/auth';
      }
    } else {
      // ì„¸ì…˜ ì—†ìŒ â†’ ì¸ì¦ í•„ìš”
      alert('ë¨¼ì € ì¸ì¦í•´ì£¼ì„¸ìš”.');
      window.location.href = '/auth';
    }
  }, []);

  const submitPost = async () => {
    if (!session) return;

    const res = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        politician_id: session.politician_id,
        session_token: session.session_token,
        subject,
        content,
        author_type: 'politician'
      })
    });

    const data = await res.json();
    if (res.ok) {
      alert('âœ… ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
      window.location.href = `/posts/${data.post.id}`;
    } else {
      alert('âŒ ' + data.error);
    }
  };

  if (!session) {
    return <div>ë¡œë”© ì¤‘...</div>;
  }

  return (
    <form onSubmit={(e) => { e.preventDefault(); submitPost(); }}>
      <h2>ê¸€ì“°ê¸° - {session.politician_name}</h2>

      <input
        value={subject}
        onChange={(e) => setSubject(e.target.value)}
        placeholder="ì œëª©"
      />

      <textarea
        value={content}
        onChange={(e) => setContent(e.target.value)}
        placeholder="ë‚´ìš©"
      />

      <button type="submit">ì‘ì„± ì™„ë£Œ</button>
    </form>
  );
}
```

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. ì„¸ì…˜ í† í° ë³´ì•ˆ

**ê°•ì :**
- âœ… 64ìë¦¬ hex (32 bytes random) - ë§¤ìš° ê°•ë ¥
- âœ… ì¶”ì¸¡ ë¶ˆê°€ëŠ¥
- âœ… UNIQUE ì œì•½ (ì¤‘ë³µ ë¶ˆê°€)

**ì•½ì :**
- âš ï¸ localStorage íƒˆì·¨ ì‹œ ë¬¸ì œ
- âš ï¸ XSS ê³µê²© ì·¨ì•½

**ëŒ€ì‘:**
- âœ… HTTPS í•„ìˆ˜ ì‚¬ìš©
- âœ… Content Security Policy ì„¤ì •
- âœ… XSS ë°©ì§€ (DOMPurify ë“±)
- âœ… IP ì£¼ì†Œ ê¸°ë¡ (ì˜ì‹¬ í™œë™ ê°ì§€)

### 2. ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥

**êµ¬í˜„:**
```typescript
// POST /api/politicians/logout
export async function POST(request: NextRequest) {
  const { session_token } = await request.json();

  // ì„¸ì…˜ ì‚­ì œ
  await supabase
    .from('politician_sessions')
    .delete()
    .eq('session_token', session_token);

  return NextResponse.json({ success: true });
}
```

**í”„ë¡ íŠ¸ì—”ë“œ:**
```typescript
const logout = async () => {
  const session = JSON.parse(localStorage.getItem('politician_session'));

  await fetch('/api/politicians/logout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_token: session.session_token })
  });

  localStorage.removeItem('politician_session');
  alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
  window.location.href = '/';
};
```

### 3. ì˜ì‹¬ í™œë™ ê°ì§€

**ì˜µì…˜ (ì¶”í›„ ì¶”ê°€ ê°€ëŠ¥):**
- IP ì£¼ì†Œ ë³€ê²½ ê°ì§€
- ë””ë°”ì´ìŠ¤ ë³€ê²½ ê°ì§€
- ë¹„ì •ìƒì ì¸ í™œë™ íŒ¨í„´ ê°ì§€
- ì˜ì‹¬ ì‹œì—ë§Œ ì¬ì¸ì¦ ìš”ì²­

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©

**Supabase Dashboard > SQL Editor:**

```sql
-- 1. politicians í…Œì´ë¸” ìˆ˜ì •
ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS verified_email TEXT UNIQUE;

ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS email_verified_at TIMESTAMPTZ;

-- 2. posts.title â†’ subject
ALTER TABLE posts RENAME COLUMN title TO subject;

-- 3. posts.user_id â†’ NULLABLE
ALTER TABLE posts ALTER COLUMN user_id DROP NOT NULL;

-- 4. politician_sessions í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS politician_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
  session_token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,  -- 2099-12-31 (ì˜êµ¬)
  last_used_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ìµœì´ˆ ì¸ì¦ í…ŒìŠ¤íŠ¸

```javascript
// 1. ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë°œì†¡
const sendRes = await fetch('/api/politicians/verify/send-code', {
  method: 'POST',
  body: JSON.stringify({
    politician_id: '62e7b453',
    email: 'test@example.com'
  })
});

// 2. ì½”ë“œ í™•ì¸
const checkRes = await fetch('/api/politicians/verify/check-code', {
  method: 'POST',
  body: JSON.stringify({
    verification_id: 'uuid',
    code: 'A1B2C3'
  })
});

const data = await checkRes.json();
console.log(data.expires_at);  // "2099-12-31T23:59:59.000Z"

// 3. localStorage í™•ì¸
const session = JSON.parse(localStorage.getItem('politician_session'));
console.log(session);
// {
//   politician_id: '62e7b453',
//   session_token: 'a1b2c3d4...',
//   expires_at: '2099-12-31T23:59:59.000Z'
// }
```

### 2. ê¸€ì“°ê¸° í…ŒìŠ¤íŠ¸

```javascript
// ì„¸ì…˜ í† í°ìœ¼ë¡œ ë°”ë¡œ ê¸€ì“°ê¸°
const postRes = await fetch('/api/posts', {
  method: 'POST',
  body: JSON.stringify({
    politician_id: session.politician_id,
    session_token: session.session_token,
    subject: 'í…ŒìŠ¤íŠ¸ ì œëª©',
    content: 'í…ŒìŠ¤íŠ¸ ë‚´ìš©',
    author_type: 'politician'
  })
});

// âœ… ì„±ê³µ!
```

---

## ìš”ì•½

### í•µì‹¬ ë³€ê²½

1. âœ… **ì„¸ì…˜ ë§Œë£Œ ì‹œê°„: 2099-12-31** (ì˜êµ¬)
2. âœ… **í•œë²ˆ ì¸ì¦ â†’ ì˜êµ¬ ì‚¬ìš©**
3. âœ… **ì¬ì¸ì¦ í•„ìš” ì—†ìŒ**
4. âœ… **ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥** (ì„ íƒì )

### í”„ë¡œì„¸ìŠ¤

```
ìµœì´ˆ:
ì •ì¹˜ì¸ ì„ íƒ â†’ ì´ë©”ì¼ ì¸ì¦ (1íšŒë§Œ) â†’ âœ… ì˜êµ¬ ì„¸ì…˜

ì´í›„:
ê¸€ì“°ê¸° ë²„íŠ¼ í´ë¦­ â†’ ë°”ë¡œ ì‘ì„±! (ì¸ì¦ ìƒëµ)
```

### ë³´ì•ˆ

- âœ… 64ìë¦¬ hex í† í°
- âœ… HTTPS í•„ìˆ˜
- âœ… XSS ë°©ì§€
- âœ… ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
- âœ… IP ê¸°ë¡ (ê°ì‚¬ ì¶”ì )

---

ëª¨ë“  ì‘ì—… ì™„ë£Œ! ğŸ‰
