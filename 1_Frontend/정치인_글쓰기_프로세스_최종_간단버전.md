# ì •ì¹˜ì¸ ê¸€ì“°ê¸° í”„ë¡œì„¸ìŠ¤ (ìµœì¢… - ê°„ë‹¨ ë²„ì „)

## í•µì‹¬ ê°œë…

**ì •ë§ ê°„ë‹¨í•©ë‹ˆë‹¤:**
- âœ… verified_email ìˆìœ¼ë©´ â†’ ë°”ë¡œ ê¸€ì“°ê¸°
- âœ… verified_email ì—†ìœ¼ë©´ â†’ ì´ë©”ì¼ ë“±ë¡ â†’ ê¸€ì“°ê¸°

**ë!**

---

## í”„ë¡œì„¸ìŠ¤

### Case 1: verified_email ìˆëŠ” ê²½ìš° (ì´ë¯¸ ë“±ë¡ëœ ì •ì¹˜ì¸)

```
1. ê¸€ì“°ê¸° ë²„íŠ¼ í´ë¦­
   â†“
2. ì •ì¹˜ì¸ ì„ íƒ: ì˜¤ì„¸í›ˆ
   â†“
3. localStorage í™•ì¸
   â†“
4. âœ… ì„¸ì…˜ ìˆìŒ
   â†“
5. ë°”ë¡œ ê¸€ì“°ê¸° í™”ë©´!
```

### Case 2: verified_email ì—†ëŠ” ê²½ìš° (ìµœì´ˆ ë“±ë¡)

```
1. ê¸€ì“°ê¸° ë²„íŠ¼ í´ë¦­
   â†“
2. ì •ì¹˜ì¸ ì„ íƒ: ì˜¤ì„¸í›ˆ
   â†“
3. localStorage í™•ì¸
   â†“
4. âŒ ì„¸ì…˜ ì—†ìŒ
   â†“
5. ì´ë©”ì¼ ì…ë ¥ í™”ë©´
   â†“
6. ì´ë©”ì¼ ì…ë ¥ (ììœ ë¡­ê²Œ)
   â†“
7. ì¸ì¦ ì½”ë“œ ë°œì†¡ ë° í™•ì¸
   â†“
8. âœ… verified_email ì €ì¥
   â†“
9. ê¸€ì“°ê¸° í™”ë©´!
```

### Case 3: ë‹¤ë¥¸ ì‚¬ëŒì´ ê¸€ì“°ë ¤ê³  í•  ë•Œ (ì´ë¯¸ ë“±ë¡ëœ ì •ì¹˜ì¸)

```
1. ê¸€ì“°ê¸° ë²„íŠ¼ í´ë¦­
   â†“
2. ì •ì¹˜ì¸ ì„ íƒ: ì˜¤ì„¸í›ˆ
   â†“
3. ì´ë©”ì¼ ì…ë ¥: hacker@evil.com
   â†“
4. âŒ DBì˜ verified_emailê³¼ ë¶ˆì¼ì¹˜
   â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
   âŒ ë“±ë¡ëœ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤

   ì˜¤ì„¸í›ˆ ì •ì¹˜ì¸ì€ ì´ë¯¸ ë‹¤ë¥¸ ì´ë©”ì¼ë¡œ
   ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

   ë“±ë¡ëœ ì´ë©”ì¼: seh***@seoul.go.kr

   [í™•ì¸]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## API ë¡œì§ (ê°„ë‹¨!)

### send-code API

```typescript
// 1. ì •ì¹˜ì¸ ì¡°íšŒ
const politician = await supabase
  .from('politicians')
  .select('verified_email')
  .eq('id', politician_id)
  .single();

// 2. verified_email ìˆìœ¼ë©´ â†’ ì¼ì¹˜ í™•ì¸
if (politician.verified_email) {
  if (politician.verified_email !== email) {
    return error('ë“±ë¡ëœ ì´ë©”ì¼ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
  }
}

// 3. verified_email ì—†ìœ¼ë©´ â†’ ììœ ë¡­ê²Œ ì…ë ¥ ê°€ëŠ¥

// 4. ì¸ì¦ ì½”ë“œ ë°œì†¡
```

### check-code API

```typescript
// 1. ì½”ë“œ í™•ì¸

// 2. verified_email ì—†ìœ¼ë©´ â†’ ì €ì¥
if (!politician.verified_email) {
  await supabase
    .from('politicians')
    .update({ verified_email: email })
    .eq('id', politician_id);
}

// 3. ì„¸ì…˜ í† í° ë°œê¸‰ (ì˜êµ¬)
```

---

## ë°ì´í„°ë² ì´ìŠ¤

```sql
CREATE TABLE politicians (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  party TEXT NOT NULL,
  position TEXT NOT NULL,
  verified_email TEXT UNIQUE,  -- NULL ë˜ëŠ” ì´ë©”ì¼
  email_verified_at TIMESTAMPTZ
);
```

**ìƒíƒœ:**
- `verified_email = NULL` â†’ ì•„ì§ ë“±ë¡ ì•ˆ ë¨ (ëˆ„êµ¬ë‚˜ ë“±ë¡ ê°€ëŠ¥)
- `verified_email = 'email@example.com'` â†’ ë“±ë¡ ì™„ë£Œ (ê·¸ ì´ë©”ì¼ë¡œë§Œ ì¸ì¦ ê°€ëŠ¥)

---

## ë³´ì•ˆ

### âœ… ë³´ì•ˆ ìœ ì§€ë˜ëŠ” ì´ìœ :

1. **ìµœì´ˆ ë“±ë¡ (verified_email = NULL)**
   - ëˆ„êµ¬ë‚˜ ì´ë©”ì¼ ì…ë ¥ ê°€ëŠ¥ âœ…
   - í•˜ì§€ë§Œ ì´ë©”ì¼ ì¸ì¦ í•„ìš” âœ…
   - ì¸ì¦ ì™„ë£Œ ì‹œ verified_email ì €ì¥ âœ…

2. **ì´í›„ (verified_email ìˆìŒ)**
   - ë“±ë¡ëœ ì´ë©”ì¼ë¡œë§Œ ì¸ì¦ ê°€ëŠ¥ âœ…
   - ë‹¤ë¥¸ ì´ë©”ì¼ ì…ë ¥ ì‹œ ê±°ë¶€ âœ…

3. **ê²°ê³¼**
   - ë¨¼ì € ë“±ë¡í•œ ì‚¬ëŒì´ "ì£¼ì¸" âœ…
   - ë‚˜ì¤‘ì— ë‹¤ë¥¸ ì‚¬ëŒì´ ê°€ë¡œì±„ê¸° ë¶ˆê°€ëŠ¥ âœ…

### âš ï¸ ì£¼ì˜ì‚¬í•­:

**"ë¨¼ì € ë“±ë¡í•˜ëŠ” ì‚¬ëŒì´ ì£¼ì¸"**
- ì‹¤ì œ ì •ì¹˜ì¸ì´ ë¨¼ì € ë“±ë¡í•´ì•¼ í•¨
- ì•…ì˜ì ì¸ ì‚¬ëŒì´ ë¨¼ì € ë“±ë¡í•˜ë©´ ë¬¸ì œ

**í•´ê²° ë°©ë²•:**
- ê´€ë¦¬ìê°€ ë¯¸ë¦¬ official_email ì„¤ì • (ì„ íƒì )
- ë˜ëŠ” ì •ì¹˜ì¸ì—ê²Œ "ë¹¨ë¦¬ ë“±ë¡í•˜ì„¸ìš”" ì•ˆë‚´

---

## ì½”ë“œ ì˜ˆì‹œ

### í”„ë¡ íŠ¸ì—”ë“œ

```tsx
function NewPostFlow() {
  const [politician, setPolitician] = useState(null);
  const [needsAuth, setNeedsAuth] = useState(false);

  const selectPolitician = async (pol) => {
    setPolitician(pol);

    // ì„¸ì…˜ í™•ì¸
    const sessionKey = `politician_${pol.id}`;
    const session = localStorage.getItem(sessionKey);

    if (session) {
      // âœ… ì„¸ì…˜ ìˆìŒ â†’ ë°”ë¡œ ê¸€ì“°ê¸°
      goToEditor();
    } else {
      // âŒ ì„¸ì…˜ ì—†ìŒ â†’ ì¸ì¦ í•„ìš”
      setNeedsAuth(true);
    }
  };

  if (needsAuth) {
    return <EmailAuth politician={politician} />;
  }

  return <PostEditor />;
}
```

---

## ìµœì¢… ì •ë¦¬

### í”„ë¡œì„¸ìŠ¤ (ì´ˆê°„ë‹¨)

```
ì •ì¹˜ì¸ ì„ íƒ
   â†“
ì„¸ì…˜ ìˆìŒ?
   YES â†’ ê¸€ì“°ê¸° âœ…
   NO â†’ ì´ë©”ì¼ ì¸ì¦ â†’ ê¸€ì“°ê¸° âœ…
```

### ë³´ì•ˆ (ê°„ë‹¨)

```
verified_email ì—†ìŒ â†’ ììœ  ë“±ë¡ (ë¨¼ì € í•˜ëŠ” ì‚¬ëŒì´ ì£¼ì¸)
verified_email ìˆìŒ â†’ ê·¸ ì´ë©”ì¼ë¡œë§Œ ì¸ì¦ ê°€ëŠ¥
```

### ë°ì´í„°ë² ì´ìŠ¤ (ê°„ë‹¨)

```sql
verified_email TEXT UNIQUE  -- NULL ë˜ëŠ” ì´ë©”ì¼
```

**ë!** ğŸ‰
