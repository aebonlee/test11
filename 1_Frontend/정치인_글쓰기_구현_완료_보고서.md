# ì •ì¹˜ì¸ ê¸€ì“°ê¸°/ëŒ“ê¸€ ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼:** 2025-12-02
**ì‘ì„±ì:** Claude Code
**í”„ë¡œì íŠ¸:** PoliticianFinder

---

## ğŸ“‹ ëª©ì°¨

1. [êµ¬í˜„ ê°œìš”](#êµ¬í˜„-ê°œìš”)
2. [ì™„ë£Œëœ ì‘ì—…](#ì™„ë£Œëœ-ì‘ì—…)
3. [ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡](#ìˆ˜ì •ëœ-íŒŒì¼-ëª©ë¡)
4. [ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜](#ë°ì´í„°ë² ì´ìŠ¤-ë§ˆì´ê·¸ë ˆì´ì…˜)
5. [API ë³€ê²½ ì‚¬í•­](#api-ë³€ê²½-ì‚¬í•­)
6. [ë‹¤ìŒ ë‹¨ê³„](#ë‹¤ìŒ-ë‹¨ê³„)
7. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#í…ŒìŠ¤íŠ¸-ë°©ë²•)

---

## êµ¬í˜„ ê°œìš”

ì •ì¹˜ì¸ì´ ë³„ë„ì˜ íšŒì›ê°€ì… ì—†ì´ ì´ë©”ì¼ ì¸ì¦ë§Œìœ¼ë¡œ ê²Œì‹œê¸€ê³¼ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.

### í•µì‹¬ ê¸°ëŠ¥

1. âœ… **ì •ì¹˜ì¸ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ**
   - ìµœì´ˆ 1íšŒ ì´ë©”ì¼ ì¸ì¦
   - ì˜êµ¬ ì„¸ì…˜ í† í° (2099-12-31 ë§Œë£Œ)
   - verified_email ì €ì¥

2. âœ… **ì •ì¹˜ì¸ ê¸€ì“°ê¸° API**
   - session_token ê¸°ë°˜ ì¸ì¦
   - user_id ì—†ì´ politician_idë¡œ ì‘ì„±
   - author_type = 'politician'

3. âœ… **ì •ì¹˜ì¸ ëŒ“ê¸€ API**
   - session_token ê¸°ë°˜ ì¸ì¦
   - user_id ì—†ì´ politician_idë¡œ ì‘ì„±
   - author_type = 'politician'

4. âœ… **í†µí•© í…Œì´ë¸” êµ¬ì¡°**
   - posts í…Œì´ë¸”: íšŒì› + ì •ì¹˜ì¸ ê¸€ í†µí•©
   - comments í…Œì´ë¸”: íšŒì› + ì •ì¹˜ì¸ ëŒ“ê¸€ í†µí•©
   - author_type í•„ë“œë¡œ êµ¬ë¶„

---

## ì™„ë£Œëœ ì‘ì—…

### âœ… Phase 1: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤€ë¹„

**íŒŒì¼:** `migrations_to_apply.sql`

**ë³€ê²½ ì‚¬í•­:**
- âœ… `politicians.verified_email` TEXT UNIQUE ì¶”ê°€
- âœ… `politicians.email_verified_at` TIMESTAMPTZ ì¶”ê°€
- âœ… `posts.title` â†’ `posts.subject` ë³€ê²½
- âœ… `posts.user_id` NULLABLE ë³€ê²½
- âœ… `posts.author_type` TEXT ì¶”ê°€
- âœ… `comments.user_id` NULLABLE ë³€ê²½
- âœ… `comments.politician_id` TEXT ì¶”ê°€
- âœ… `comments.author_type` TEXT ì¶”ê°€
- âœ… `politician_sessions` í…Œì´ë¸” ìƒì„±
- âœ… CHECK ì œì•½ ì¡°ê±´ ì¶”ê°€ (user_id OR politician_id í•„ìˆ˜)
- âœ… ì¸ë±ìŠ¤ ë° RLS ì •ì±… ì¶”ê°€

**ì ìš© ë°©ë²•:**
```
Supabase Dashboard > SQL Editorì—ì„œ migrations_to_apply.sql ì‹¤í–‰
```

---

### âœ… Phase 2: ì¸ì¦ API ìˆ˜ì • (ì´ì „ ì‘ì—…ì—ì„œ ì™„ë£Œ)

**íŒŒì¼:**
- âœ… `src/app/api/politicians/verify/send-code/route.ts`
- âœ… `src/app/api/politicians/verify/check-code/route.ts`

**ì£¼ìš” ë³€ê²½:**
- `send-code`: politician_id + email ë°©ì‹ìœ¼ë¡œ ë³€ê²½
- `send-code`: verified_email ê²€ì¦ ë¡œì§ ì¶”ê°€
- `check-code`: ì˜êµ¬ ì„¸ì…˜ í† í° ë°œê¸‰ (2099-12-31)
- `check-code`: verified_email ì €ì¥ ë¡œì§ ì¶”ê°€

---

### âœ… Phase 3: ê²Œì‹œê¸€ API ìˆ˜ì •

**íŒŒì¼:** `src/app/api/posts/route.ts`

**ì£¼ìš” ë³€ê²½:**

#### 1. ìŠ¤í‚¤ë§ˆ ë³€ê²½
```typescript
// íšŒì› ê¸€ì“°ê¸° ìŠ¤í‚¤ë§ˆ
const createPostSchema = z.object({
  subject: z.string().min(5).max(200),  // â† "title" â†’ "subject"
  content: z.string().min(10).max(10000),
  category: z.enum(["general", "question", "debate", "news"]),
  politician_id: z.string().optional().nullable(),
  tags: z.array(z.string()).max(5).optional(),
});

// ì •ì¹˜ì¸ ê¸€ì“°ê¸° ìŠ¤í‚¤ë§ˆ (ì‹ ê·œ)
const politicianPostSchema = z.object({
  politician_id: z.string().min(8).max(8),
  session_token: z.string().min(64).max(64),
  subject: z.string().min(5).max(200),
  content: z.string().min(10).max(10000),
  category: z.enum(["general", "question", "debate", "news"]),
  tags: z.array(z.string()).max(5).optional(),
  author_type: z.literal('politician'),
});
```

#### 2. author_type ë¶„ê¸° ë¡œì§
```typescript
export async function POST(request: NextRequest) {
  const body = await request.json();

  if (body.author_type === 'politician') {
    return await handlePoliticianPost(request, body);
  } else {
    return await handleUserPost(request, body);
  }
}
```

#### 3. ì •ì¹˜ì¸ ê¸€ì“°ê¸° ì²˜ë¦¬ (ì‹ ê·œ)
```typescript
async function handlePoliticianPost(request: NextRequest, body: any) {
  // 1. ìŠ¤í‚¤ë§ˆ ê²€ì¦
  const validated = politicianPostSchema.parse(body);

  // 2. Admin client ìƒì„± (RLS ìš°íšŒ)
  const supabase = createAdminClient();

  // 3. ì„¸ì…˜ í† í° ê²€ì¦
  const { data: session } = await supabase
    .from('politician_sessions')
    .select('*')
    .eq('politician_id', validated.politician_id)
    .eq('session_token', validated.session_token)
    .gt('expires_at', new Date().toISOString())
    .single();

  if (!session) {
    return NextResponse.json({ error: 'ì¸ì¦ í•„ìš”' }, { status: 401 });
  }

  // 4. ê²Œì‹œê¸€ ì‚½ì…
  const { data: newPost } = await supabase
    .from('posts')
    .insert({
      user_id: null,                      // â† NULL
      politician_id: validated.politician_id,
      subject: validated.subject,         // â† "title" â†’ "subject"
      content: validated.content,
      category: validated.category,
      tags: validated.tags || null,
      author_type: 'politician',          // â† NEW
    })
    .select()
    .single();

  // 5. last_used_at ì—…ë°ì´íŠ¸
  await supabase
    .from('politician_sessions')
    .update({ last_used_at: new Date().toISOString() })
    .eq('id', session.id);

  return NextResponse.json({ success: true, data: newPost });
}
```

#### 4. íšŒì› ê¸€ì“°ê¸° ì²˜ë¦¬ (ìˆ˜ì •)
```typescript
async function handleUserPost(request: NextRequest, body: any) {
  const authResult = await requireAuth();
  const { user } = authResult;

  const validated = createPostSchema.parse(body);

  const { data: newPost } = await supabase
    .from('posts')
    .insert({
      user_id: user.id,
      subject: validated.subject,     // â† "title" â†’ "subject"
      content: validated.content,
      category: validated.category,
      politician_id: validated.politician_id || null,
      tags: validated.tags || null,
      author_type: 'user',            // â† NEW
    })
    .select()
    .single();

  return NextResponse.json({ success: true, data: newPost });
}
```

---

### âœ… Phase 4: ëŒ“ê¸€ API ìˆ˜ì •

**íŒŒì¼:** `src/app/api/comments/route.ts`

**ì£¼ìš” ë³€ê²½:**

#### 1. ìŠ¤í‚¤ë§ˆ ë³€ê²½
```typescript
// íšŒì› ëŒ“ê¸€ ìŠ¤í‚¤ë§ˆ
const createCommentSchema = z.object({
  post_id: z.string().min(1),
  content: z.string().min(1).max(500),
  parent_id: z.string().optional().nullable(),
});

// ì •ì¹˜ì¸ ëŒ“ê¸€ ìŠ¤í‚¤ë§ˆ (ì‹ ê·œ)
const politicianCommentSchema = z.object({
  post_id: z.string().min(1),
  politician_id: z.string().min(8).max(8),
  session_token: z.string().min(64).max(64),
  content: z.string().min(1).max(500),
  parent_id: z.string().optional().nullable(),
  author_type: z.literal('politician'),
});
```

#### 2. author_type ë¶„ê¸° ë¡œì§
```typescript
export async function POST(request: NextRequest) {
  const body = await request.json();

  if (body.author_type === 'politician') {
    return await handlePoliticianComment(request, body);
  } else {
    return await handleUserComment(request, body);
  }
}
```

#### 3. ì •ì¹˜ì¸ ëŒ“ê¸€ ì²˜ë¦¬ (ì‹ ê·œ)
```typescript
async function handlePoliticianComment(request: NextRequest, body: any) {
  // 1. ìŠ¤í‚¤ë§ˆ ê²€ì¦
  const validated = politicianCommentSchema.parse(body);

  // 2. Admin client ìƒì„±
  const supabase = createAdminClient();

  // 3. ì„¸ì…˜ í† í° ê²€ì¦
  const { data: session } = await supabase
    .from('politician_sessions')
    .select('*')
    .eq('politician_id', validated.politician_id)
    .eq('session_token', validated.session_token)
    .gt('expires_at', new Date().toISOString())
    .single();

  if (!session) {
    return NextResponse.json({ error: 'ì¸ì¦ í•„ìš”' }, { status: 401 });
  }

  // 4. ëŒ“ê¸€ ì‚½ì…
  const { data: newComment } = await supabase
    .from('comments')
    .insert({
      post_id: validated.post_id,
      user_id: null,                      // â† NULL
      politician_id: validated.politician_id,
      content: validated.content,
      parent_id: validated.parent_id || null,
      author_type: 'politician',          // â† NEW
    })
    .select()
    .single();

  // 5. last_used_at ì—…ë°ì´íŠ¸
  await supabase
    .from('politician_sessions')
    .update({ last_used_at: new Date().toISOString() })
    .eq('id', session.id);

  return NextResponse.json({ success: true, data: newComment });
}
```

#### 4. GET ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •
```typescript
let queryBuilder = supabase
  .from('comments')
  .select(`
    *,
    users:user_id (
      name,
      email
    ),
    politicians:politician_id (    // â† NEW (ì •ì¹˜ì¸ ì •ë³´ ì¡°ì¸)
      name,
      party,
      position
    ),
    posts:post_id (
      subject                      // â† "title" â†’ "subject"
    )
  `, { count: 'exact' });
```

---

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### ğŸ“ ì‹ ê·œ ìƒì„± íŒŒì¼

| íŒŒì¼ | ìœ„ì¹˜ | ì„¤ëª… |
|------|------|------|
| `migrations_to_apply.sql` | `1_Frontend/` | ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL |
| `apply_migration_api.js` | `1_Frontend/` | ë§ˆì´ê·¸ë ˆì´ì…˜ ì•ˆë‚´ ìŠ¤í¬ë¦½íŠ¸ |
| `ì •ì¹˜ì¸_ê¸€ì“°ê¸°_í”„ë¡œì„¸ìŠ¤_ê°œì„ _ë¶„ì„.md` | `1_Frontend/` | ê°œì„  ë¶„ì„ ë¬¸ì„œ |
| `ì •ì¹˜ì¸_ê¸€ì“°ê¸°_êµ¬í˜„_ì™„ë£Œ_ë³´ê³ ì„œ.md` | `1_Frontend/` | ì´ ë¬¸ì„œ |

### ğŸ“ ìˆ˜ì •ëœ íŒŒì¼

| íŒŒì¼ | ìœ„ì¹˜ | ì£¼ìš” ë³€ê²½ |
|------|------|----------|
| `route.ts` | `src/app/api/posts/` | ì •ì¹˜ì¸ ê¸€ì“°ê¸° ë¡œì§ ì¶”ê°€, title â†’ subject |
| `route.ts` | `src/app/api/comments/` | ì •ì¹˜ì¸ ëŒ“ê¸€ ë¡œì§ ì¶”ê°€, ì •ì¹˜ì¸ ì¡°ì¸ |

### ğŸ“ ë°±ì—… íŒŒì¼

| ì›ë³¸ íŒŒì¼ | ë°±ì—… ìœ„ì¹˜ |
|----------|----------|
| `src/app/api/posts/route.ts` | `route.ts.backup_*` |
| `src/app/api/comments/route.ts` | `route.ts.backup_*` |

---

## ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜

### âš ï¸ ì¤‘ìš”: ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© í•„ìš”

**í˜„ì¬ ìƒíƒœ:** ë§ˆì´ê·¸ë ˆì´ì…˜ SQL íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ (ì•„ì§ ë¯¸ì ìš©)

**ì ìš© ë°©ë²•:**

1. **Supabase Dashboard ì ‘ì†**
   ```
   https://supabase.com/dashboard/project/ooddlafwdpzgxfefgsrx
   ```

2. **SQL Editor ì—´ê¸°**
   - ì™¼ìª½ ì‚¬ì´ë“œë°” > "SQL Editor" í´ë¦­

3. **ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**
   - "New Query" í´ë¦­
   - `1_Frontend/migrations_to_apply.sql` íŒŒì¼ ë‚´ìš© ë³µì‚¬
   - ì—ë””í„°ì— ë¶™ì—¬ë„£ê¸°
   - "Run" í´ë¦­ (ë˜ëŠ” Ctrl+Enter)

4. **ì„±ê³µ í™•ì¸**
   ```
   âœ… Migration 052 + 053 completed successfully!
   ```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ìš© ìš”ì•½

```sql
-- 1. politicians í…Œì´ë¸”
ALTER TABLE politicians
  ADD COLUMN verified_email TEXT UNIQUE,
  ADD COLUMN email_verified_at TIMESTAMPTZ;

-- 2. posts í…Œì´ë¸”
ALTER TABLE posts RENAME COLUMN title TO subject;
ALTER TABLE posts ALTER COLUMN user_id DROP NOT NULL;
ALTER TABLE posts ADD COLUMN author_type TEXT DEFAULT 'user';
ALTER TABLE posts ADD CONSTRAINT posts_author_check ...;

-- 3. comments í…Œì´ë¸”
ALTER TABLE comments ALTER COLUMN user_id DROP NOT NULL;
ALTER TABLE comments ADD COLUMN politician_id TEXT;
ALTER TABLE comments ADD COLUMN author_type TEXT DEFAULT 'user';
ALTER TABLE comments ADD CONSTRAINT comments_author_check ...;

-- 4. politician_sessions í…Œì´ë¸” ìƒì„±
CREATE TABLE politician_sessions (
  id UUID PRIMARY KEY,
  politician_id TEXT NOT NULL,
  session_token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL,  -- 2099-12-31
  ...
);
```

---

## API ë³€ê²½ ì‚¬í•­

### 1. POST /api/posts (ê²Œì‹œê¸€ ì‘ì„±)

#### íšŒì› ê¸€ì“°ê¸° (ê¸°ì¡´ ë°©ì‹)
```bash
POST /api/posts
Authorization: Bearer <user_token>
Content-Type: application/json

{
  "subject": "ì œëª©",
  "content": "ë‚´ìš©",
  "category": "general",
  "tags": ["íƒœê·¸1", "íƒœê·¸2"]
}
```

#### ì •ì¹˜ì¸ ê¸€ì“°ê¸° (NEW)
```bash
POST /api/posts
Content-Type: application/json

{
  "politician_id": "62e7b453",
  "session_token": "a1b2c3d4e5f6...",
  "subject": "ì œëª©",
  "content": "ë‚´ìš©",
  "category": "general",
  "author_type": "politician"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "politician_id": "62e7b453",
    "subject": "ì œëª©",
    "content": "ë‚´ìš©",
    "author_type": "politician",
    "created_at": "2025-12-02T..."
  },
  "message": "ì˜¤ì„¸í›ˆë‹˜ì˜ ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

---

### 2. POST /api/comments (ëŒ“ê¸€ ì‘ì„±)

#### íšŒì› ëŒ“ê¸€ (ê¸°ì¡´ ë°©ì‹)
```bash
POST /api/comments
Authorization: Bearer <user_token>
Content-Type: application/json

{
  "post_id": "post-uuid",
  "content": "ëŒ“ê¸€ ë‚´ìš©"
}
```

#### ì •ì¹˜ì¸ ëŒ“ê¸€ (NEW)
```bash
POST /api/comments
Content-Type: application/json

{
  "post_id": "post-uuid",
  "politician_id": "62e7b453",
  "session_token": "a1b2c3d4e5f6...",
  "content": "ëŒ“ê¸€ ë‚´ìš©",
  "author_type": "politician"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "post_id": "post-uuid",
    "politician_id": "62e7b453",
    "content": "ëŒ“ê¸€ ë‚´ìš©",
    "author_type": "politician",
    "created_at": "2025-12-02T..."
  },
  "message": "ì˜¤ì„¸í›ˆë‹˜ì˜ ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

---

### 3. GET /api/comments (ëŒ“ê¸€ ì¡°íšŒ)

**ë³€ê²½ ì‚¬í•­:**
- `politicians` ì •ë³´ ì¡°ì¸ ì¶”ê°€
- `posts.subject` ì°¸ì¡° (ê¸°ì¡´ `posts.title` â†’ ë³€ê²½)

**Response ì˜ˆì‹œ:**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "content": "ëŒ“ê¸€ ë‚´ìš©",
      "author_type": "politician",
      "politician_id": "62e7b453",
      "politicians": {
        "name": "ì˜¤ì„¸í›ˆ",
        "party": "êµ­ë¯¼ì˜í˜",
        "position": "ì„œìš¸íŠ¹ë³„ì‹œì¥"
      },
      "posts": {
        "subject": "ê²Œì‹œê¸€ ì œëª©"
      }
    }
  ]
}
```

---

## ë‹¤ìŒ ë‹¨ê³„

### ğŸ”´ í•„ìˆ˜ ì‘ì—…

1. **ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©**
   - Supabase Dashboardì—ì„œ `migrations_to_apply.sql` ì‹¤í–‰
   - ì„±ê³µ ë©”ì‹œì§€ í™•ì¸

2. **Vercel ì¬ë°°í¬**
   ```bash
   git add .
   git commit -m "feat: Add politician posting system"
   git push
   ```

3. **Production ë°°í¬ í™•ì¸**
   - https://politicianfinder.comì—ì„œ API ë™ì‘ í™•ì¸

---

### ğŸŸ¡ ê¶Œì¥ ì‘ì—… (í›„ì†)

4. **í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ ê°œë°œ**
   - ì •ì¹˜ì¸ ì„ íƒ ë“œë¡­ë‹¤ìš´
   - ì´ë©”ì¼ ì¸ì¦ í¼
   - ì •ì¹˜ì¸ ê¸€ì“°ê¸° í¼
   - ì •ì¹˜ì¸ ëŒ“ê¸€ í¼

5. **í†µí•© í…ŒìŠ¤íŠ¸ ìˆ˜í–‰**
   - ì •ì¹˜ì¸ ìµœì´ˆ ë“±ë¡ í…ŒìŠ¤íŠ¸
   - ì •ì¹˜ì¸ ê¸€ì“°ê¸° í…ŒìŠ¤íŠ¸
   - ì •ì¹˜ì¸ ëŒ“ê¸€ í…ŒìŠ¤íŠ¸
   - ë‹¤ë¥¸ ì‚¬ëŒ ê°€ë¡œì±„ê¸° ì‹œë„ í…ŒìŠ¤íŠ¸

6. **ë¬¸ì„œ ì—…ë°ì´íŠ¸**
   - API ë¬¸ì„œì— ì •ì¹˜ì¸ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
   - í”„ë¡ íŠ¸ì—”ë“œ ê°€ì´ë“œ ì‘ì„±

---

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© í™•ì¸

```bash
# Supabase SQL Editorì—ì„œ í™•ì¸
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'posts' AND column_name = 'subject';

SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'politician_sessions';
```

**ì˜ˆìƒ ê²°ê³¼:**
```
posts.subject | text
politician_sessions.id | uuid
politician_sessions.session_token | text
```

---

### 2. ì •ì¹˜ì¸ ì„¸ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸

```bash
# 1. ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ ë°œì†¡
curl -X POST http://localhost:3000/api/politicians/verify/send-code \
  -H "Content-Type: application/json" \
  -d '{
    "politician_id": "62e7b453",
    "email": "test@example.com"
  }'

# 2. ì½”ë“œ í™•ì¸ (ì´ë©”ì¼ì—ì„œ ë°›ì€ ì½”ë“œ ì‚¬ìš©)
curl -X POST http://localhost:3000/api/politicians/verify/check-code \
  -H "Content-Type: application/json" \
  -d '{
    "verification_id": "uuid-from-step-1",
    "code": "A1B2C3"
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "success": true,
  "politician_id": "62e7b453",
  "email": "test@example.com",
  "session_token": "a1b2c3d4e5f6...",  // â† ì €ì¥!
  "expires_at": "2099-12-31T23:59:59.000Z"
}
```

---

### 3. ì •ì¹˜ì¸ ê¸€ì“°ê¸° í…ŒìŠ¤íŠ¸

```bash
curl -X POST http://localhost:3000/api/posts \
  -H "Content-Type: application/json" \
  -d '{
    "politician_id": "62e7b453",
    "session_token": "a1b2c3d4e5f6...",
    "subject": "í…ŒìŠ¤íŠ¸ ì œëª©",
    "content": "í…ŒìŠ¤íŠ¸ ë‚´ìš©ì…ë‹ˆë‹¤.",
    "category": "general",
    "author_type": "politician"
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "id": "post-uuid",
    "politician_id": "62e7b453",
    "user_id": null,
    "subject": "í…ŒìŠ¤íŠ¸ ì œëª©",
    "content": "í…ŒìŠ¤íŠ¸ ë‚´ìš©ì…ë‹ˆë‹¤.",
    "author_type": "politician"
  },
  "message": "ì˜¤ì„¸í›ˆë‹˜ì˜ ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

---

### 4. ì •ì¹˜ì¸ ëŒ“ê¸€ í…ŒìŠ¤íŠ¸

```bash
curl -X POST http://localhost:3000/api/comments \
  -H "Content-Type: application/json" \
  -d '{
    "post_id": "post-uuid",
    "politician_id": "62e7b453",
    "session_token": "a1b2c3d4e5f6...",
    "content": "í…ŒìŠ¤íŠ¸ ëŒ“ê¸€ì…ë‹ˆë‹¤.",
    "author_type": "politician"
  }'
```

**ì˜ˆìƒ ì‘ë‹µ:**
```json
{
  "success": true,
  "data": {
    "id": "comment-uuid",
    "post_id": "post-uuid",
    "politician_id": "62e7b453",
    "user_id": null,
    "content": "í…ŒìŠ¤íŠ¸ ëŒ“ê¸€ì…ë‹ˆë‹¤.",
    "author_type": "politician"
  },
  "message": "ì˜¤ì„¸í›ˆë‹˜ì˜ ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

---

### 5. ë°ì´í„° í™•ì¸ í…ŒìŠ¤íŠ¸

```bash
# Supabase SQL Editorì—ì„œ ì‹¤í–‰
SELECT
  id,
  politician_id,
  user_id,
  subject,
  author_type
FROM posts
WHERE author_type = 'politician'
LIMIT 5;

SELECT
  id,
  politician_id,
  user_id,
  content,
  author_type
FROM comments
WHERE author_type = 'politician'
LIMIT 5;
```

**ì˜ˆìƒ ê²°ê³¼:**
- `politician_id`: 62e7b453 (TEXT)
- `user_id`: NULL
- `author_type`: 'politician'

---

## ğŸ“Š êµ¬í˜„ ì™„ë£Œ í˜„í™©

### âœ… ì™„ë£Œëœ ì‘ì—…

- [x] ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„
- [x] ë§ˆì´ê·¸ë ˆì´ì…˜ SQL íŒŒì¼ ì‘ì„±
- [x] `/api/posts` ì •ì¹˜ì¸ ê¸€ì“°ê¸° ë¡œì§ êµ¬í˜„
- [x] `/api/comments` ì •ì¹˜ì¸ ëŒ“ê¸€ ë¡œì§ êµ¬í˜„
- [x] `title` â†’ `subject` í•„ë“œëª… ë³€ê²½
- [x] `author_type` ë¶„ê¸° ë¡œì§ êµ¬í˜„
- [x] ì„¸ì…˜ í† í° ê²€ì¦ ë¡œì§ êµ¬í˜„
- [x] ì •ì¹˜ì¸ ì •ë³´ ì¡°ì¸ (GET ì—”ë“œí¬ì¸íŠ¸)
- [x] ë°±ì—… íŒŒì¼ ìƒì„±
- [x] ë¶„ì„ ë¬¸ì„œ ì‘ì„±
- [x] êµ¬í˜„ ì™„ë£Œ ë³´ê³ ì„œ ì‘ì„±

### ğŸŸ¡ ëŒ€ê¸° ì¤‘ì¸ ì‘ì—… (ì‚¬ìš©ì ìˆ˜í–‰ í•„ìš”)

- [ ] Supabaseì— ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
- [ ] Vercel ì¬ë°°í¬
- [ ] Production ë°°í¬ í™•ì¸

### ğŸ”µ í›„ì† ì‘ì—… (ì„ íƒì )

- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì»´í¬ë„ŒíŠ¸ ê°œë°œ
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
- [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [ ] ì‚¬ìš©ì ê°€ì´ë“œ ì‘ì„±

---

## ğŸ¯ í•µì‹¬ ìš”ì•½

### ë³€ê²½ ì‚¬í•­

1. **posts í…Œì´ë¸”**
   - `title` â†’ `subject`
   - `user_id` NULLABLE
   - `author_type` ì¶”ê°€
   - CHECK ì œì•½: user_id OR politician_id í•„ìˆ˜

2. **comments í…Œì´ë¸”**
   - `user_id` NULLABLE
   - `politician_id` ì¶”ê°€
   - `author_type` ì¶”ê°€
   - CHECK ì œì•½: user_id OR politician_id í•„ìˆ˜

3. **politician_sessions í…Œì´ë¸” (ì‹ ê·œ)**
   - `session_token` TEXT UNIQUE
   - `expires_at` 2099-12-31 (ì˜êµ¬)

4. **API ì—”ë“œí¬ì¸íŠ¸**
   - `POST /api/posts`: author_type ë¶„ê¸° ì¶”ê°€
   - `POST /api/comments`: author_type ë¶„ê¸° ì¶”ê°€
   - `GET /api/comments`: politicians ì¡°ì¸ ì¶”ê°€

### ì‚¬ìš© íë¦„

```
ì •ì¹˜ì¸ ì„ íƒ
   â†“
verified_email í™•ì¸
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ìˆìŒ       â”‚ âŒ ì—†ìŒ       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ë°”ë¡œ ê¸€ì“°ê¸°   â”‚ ì´ë©”ì¼ ì…ë ¥   â”‚
â”‚               â”‚ ì½”ë“œ ë°œì†¡     â”‚
â”‚               â”‚ ì½”ë“œ í™•ì¸     â”‚
â”‚               â”‚ verified_email ì €ì¥
â”‚               â”‚ ì„¸ì…˜ í† í° ë°œê¸‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    ê¸€ì“°ê¸°/ëŒ“ê¸€ ì‘ì„±
         â†“
    ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
    (user_id=NULL, politician_id ìˆìŒ)
```

---

## ğŸ“ ì°¸ê³  ë¬¸ì„œ

1. **ë¶„ì„ ë¬¸ì„œ**
   - `ì •ì¹˜ì¸_ê¸€ì“°ê¸°_í”„ë¡œì„¸ìŠ¤_ê°œì„ _ë¶„ì„.md`
   - í˜„ì¬ ìƒíƒœ vs í•„ìš” êµ¬í˜„ ìƒì„¸ ë¹„êµ

2. **ì„¤ê³„ ë¬¸ì„œ**
   - `ì •ì¹˜ì¸_ê¸€ì“°ê¸°_í”„ë¡œì„¸ìŠ¤_ìµœì¢…_ê°„ë‹¨ë²„ì „.md`
   - `ì •ì¹˜ì¸_ì˜êµ¬_ë¡œê·¸ì¸_ì‹œìŠ¤í…œ_ìµœì¢….md`

3. **ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼**
   - `migrations_to_apply.sql`

4. **ë°±ì—… íŒŒì¼**
   - `src/app/api/posts/route.ts.backup_*`
   - `src/app/api/comments/route.ts.backup_*`

---

## âœ… ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ í•„ìˆ˜ í™•ì¸

- [ ] `migrations_to_apply.sql` Supabaseì— ì ìš©
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ ë©”ì‹œì§€ í™•ì¸
- [ ] `verified_email` ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
- [ ] `posts.subject` ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸
- [ ] `politician_sessions` í…Œì´ë¸” ì¡´ì¬ í™•ì¸
- [ ] Git commit ë° push
- [ ] Vercel ìë™ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
- [ ] Production API ë™ì‘ í™•ì¸

### ë°°í¬ í›„ í™•ì¸

- [ ] POST /api/posts (ì •ì¹˜ì¸) í…ŒìŠ¤íŠ¸
- [ ] POST /api/comments (ì •ì¹˜ì¸) í…ŒìŠ¤íŠ¸
- [ ] GET /api/posts ì •ìƒ ë™ì‘ í™•ì¸
- [ ] GET /api/comments ì •ìƒ ë™ì‘ í™•ì¸
- [ ] ì—ëŸ¬ ë¡œê·¸ í™•ì¸

---

**êµ¬í˜„ ì™„ë£Œì¼:** 2025-12-02
**ë‹¤ìŒ ì‘ì—…:** ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ë° ë°°í¬

ğŸ‰ **ì •ì¹˜ì¸ ê¸€ì“°ê¸°/ëŒ“ê¸€ ì‹œìŠ¤í…œ êµ¬í˜„ ì™„ë£Œ!**
