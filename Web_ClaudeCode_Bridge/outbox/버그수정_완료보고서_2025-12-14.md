# 버그 수정 완료 보고서
**작성일:** 2025-12-14
**작성자:** Claude Code

---

## 수정 내역 요약

| # | 문제 | 원인 | 해결 |
|---|------|------|------|
| 1 | YouTube 광고 로딩 안됨 | CSP에서 iframe 차단 | frame-src에 YouTube 도메인 추가 |
| 2 | 마이페이지 내 댓글 안보임 | like_count 컬럼 없음 | select에서 like_count 제거 |
| 3 | 어드민 작성자 "Unknown" 표시 | author_type 미확인 | 정치인/회원 분기 처리 |
| 4 | 커뮤니티 게시글 등록 안됨 | API 호출 누락 | 실제 API 호출 추가 |
| 5 | 커뮤니티 페이지네이션 없음 | UI 코드 누락 | 페이지네이션 UI 복구 |
| 6 | 타입스크립트 빌드 오류 | Supabase 타입 추론 실패 | 명시적 타입 캐스팅 |
| 7 | 팔로워=0인데 "기사" 표시 | DB 값 읽기 오류 | 팔로워 수 기반 동적 계산 |
| 8 | 어드민 삭제 후 로그인 가능 | auth.users 삭제 무시 | auth.users 먼저 삭제 |

---

## 상세 수정 내용

### 1. YouTube 광고 로딩 문제 해결

**파일:** `src/middleware.ts`

**문제:** 홈페이지 우측 사이드바에 YouTube 영상 광고 추가했으나 로딩 안됨

**원인:** Content Security Policy(CSP)에서 `frame-src` 지시문이 없어 외부 iframe 차단

**해결:**
```javascript
// CSP에 YouTube 허용 추가
frame-src 'self' https://www.youtube.com https://www.youtube-nocookie.com;
media-src 'self' https://www.youtube.com https://www.youtube-nocookie.com;
```

**커밋:** `a9e4ae5` - fix: CSP에 YouTube iframe 허용 추가

---

### 2. 마이페이지 내 댓글 표시 문제 해결

**파일:** `src/app/api/community/comments/route.ts`

**문제:** 마이페이지 "내 댓글" 탭에서 댓글이 표시되지 않음 (stats에는 9개로 표시)

**원인:** API에서 `like_count` 컬럼을 select하는데 실제 DB에 해당 컬럼 없음

**해결:**
```javascript
// Before
.select('id, content, created_at, like_count, post_id')

// After
.select('id, content, created_at, post_id')
```

**커밋:** `da88f5c` - fix: 마이페이지 내 댓글 API like_count 컬럼 오류 수정

---

### 3. 어드민 콘텐츠 관리 작성자 표시 문제 해결

**파일:**
- `src/app/admin/posts/page.tsx`
- `src/app/api/comments/route.ts`

**문제:** 어드민 게시글/댓글 관리에서 모든 작성자가 "Unknown"으로 표시

**원인:**
- `author_type = 'politician'`인 경우 politicians 테이블에서 이름 조회 필요
- 기존 코드는 users 테이블만 확인

**해결:**
```javascript
// author_type에 따라 작성자 결정
let author = 'Unknown';
if (post.author_type === 'politician' && post.politicians?.name) {
  author = `${post.politicians.name} (정치인)`;
} else if (post.users) {
  author = post.users.nickname || post.users.name || post.users.email?.split('@')[0] || 'Unknown';
}
```

**커밋:** `5b2a9d0` - fix: 어드민 콘텐츠 관리 - 정치인 작성자 표시 수정

---

### 4. 커뮤니티 게시글 등록 문제 해결

**파일:** `src/app/community/posts/create/page.tsx`

**문제:** 커뮤니티에서 게시글 작성 후 "등록 완료" 메시지만 뜨고 실제 저장 안됨

**원인:** handleSubmit 함수에 실제 API 호출 코드가 없었음 (성공 메시지만 표시)

**해결:**
```javascript
const response = await fetch('/api/posts', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    subject: title.trim(),
    content: content.trim(),
    category: 'general',
    tags: tagList.length > 0 ? tagList : null,
    politician_id: null,
  }),
});
```

**커밋:** `5817f93` - fix: 커뮤니티 게시글 등록/조회 문제 수정 및 페이지네이션 추가

---

### 5. 커뮤니티 페이지네이션 복구

**파일:** `src/app/community/page.tsx`

**문제:** 커뮤니티 페이지에 페이지네이션이 사라짐

**해결:** 페이지네이션 상태 및 UI 컴포넌트 추가
- currentPage, totalPages 상태 추가
- 처음/이전/숫자/다음/마지막 버튼 UI

**커밋:** `5817f93` (위와 동일)

---

### 6. TypeScript 빌드 오류 수정

**파일:** `src/app/api/community/comments/route.ts`

**문제:** Supabase 쿼리 결과 타입이 `never`로 추론되어 빌드 실패

**해결:** 명시적 타입 캐스팅 추가
```typescript
const { data: comments, error } = await supabase
  .from('comments')
  .select('id, content, created_at, post_id')
  // ...
  .limit(limit) as { data: Array<{ id: string; content: string; created_at: string; post_id: number }> | null; error: any };
```

**커밋:** `422e920` - fix: community comments API 타입 오류 수정

---

### 7. 영향력 그레이드 동적 계산 수정

**파일:** `src/app/api/users/[id]/stats/route.ts`

**문제:** 팔로워가 0명인데 "기사" 등급으로 표시됨 (방랑자여야 함)

**원인:** DB에 저장된 `influence_grade` 값을 그대로 읽어서 표시 (업데이트 안됨)

**해결:** 팔로워 수 기반으로 동적 계산
```javascript
// 영향력 그레이드 동적 계산 (팔로워 수 기반)
const followerCount = user.follower_count || 0;
let gradeKey = 'Wanderer';  // 기본값: 방랑자

if (followerCount >= 500) gradeKey = 'Monarch';      // 군주
else if (followerCount >= 200) gradeKey = 'Duke';    // 공작
else if (followerCount >= 50) gradeKey = 'Lord';     // 영주
else if (followerCount >= 10) gradeKey = 'Knight';   // 기사
// 10명 미만: Wanderer (방랑자)
```

**커밋:** `0440077` - fix: 영향력 그레이드 팔로워 수 기반 동적 계산

---

### 8. 어드민 사용자 삭제 auth.users 문제 해결

**파일:** `src/app/api/admin/users/route.ts`

**문제:** 어드민에서 사용자 삭제해도 Supabase Auth에서 삭제 안됨 → 다시 로그인 가능

**원인:**
- 기존: public.users 먼저 삭제 → auth.users 삭제 실패해도 무시
- auth.users 삭제 오류가 발생해도 계속 진행

**해결:**
```javascript
// 1. auth.users 먼저 삭제 (필수!)
const { error: authDeleteError } = await supabase.auth.admin.deleteUser(user_id);

if (authDeleteError) {
  // "User not found"는 이미 삭제된 경우이므로 허용
  if (!authDeleteError.message?.includes('User not found')) {
    return NextResponse.json({ error: 'auth.users 삭제 실패' }, { status: 500 });
  }
}

// 2. public.users 삭제 (auth.users 삭제 성공 후에만)
```

**커밋:** `fded8fa` - fix: 어드민 사용자 삭제 시 auth.users 먼저 삭제하도록 순서 변경

---

### 추가 작업: 테스트 사용자 삭제

- **삭제된 사용자:** `w2center@naver.com` (ID: `a57e290f-c10f-4147-8d74-668e7cb921bb`)
- **삭제 결과:** auth.users에서 완전 삭제 완료
- **현재 auth.users 수:** 12명

---

## 배포 정보

- **배포 플랫폼:** Vercel
- **최종 배포 시간:** 2025-12-14
- **배포 상태:** ✅ 성공

---

## 관련 커밋 목록

```
fded8fa fix: 어드민 사용자 삭제 시 auth.users 먼저 삭제하도록 순서 변경
0440077 fix: 영향력 그레이드 팔로워 수 기반 동적 계산
5b2a9d0 fix: 어드민 콘텐츠 관리 - 정치인 작성자 표시 수정
da88f5c fix: 마이페이지 내 댓글 API like_count 컬럼 오류 수정
a9e4ae5 fix: CSP에 YouTube iframe 허용 추가
2d1994e fix: YouTube iframe 로딩 문제 수정
422e920 fix: community comments API 타입 오류 수정
a2619e8 feat: 홈페이지 우측 사이드바에 YouTube 광고 추가
5817f93 fix: 커뮤니티 게시글 등록/조회 문제 수정 및 페이지네이션 추가
9ab3022 fix: 마이페이지 중복 표시 제거 및 통계 필터 수정
```

---

## 테스트 확인 항목

- [x] YouTube 광고 정상 로딩
- [x] 마이페이지 내 댓글 표시
- [x] 어드민 작성자 "오세훈 (정치인)" 형식 표시
- [x] 커뮤니티 게시글 등록 및 조회
- [x] 커뮤니티 페이지네이션 동작
- [x] 빌드 성공 (타입 오류 없음)
- [x] 팔로워=0일 때 "방랑자" 표시
- [x] 테스트 사용자 w2center@naver.com 삭제 완료
- [x] 어드민 삭제 시 auth.users에서도 삭제 (수정 완료)

---

**보고서 끝**
