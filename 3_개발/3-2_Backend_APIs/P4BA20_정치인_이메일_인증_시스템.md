# P4BA20 정치인 통합 이메일 인증 시스템

## 개요
정치인 본인 확인을 위한 이메일 기반 인증 시스템입니다.
일반 회원과 분리된 별도의 인증 체계로, 정치인 전용 기능(댓글, 게시글, 보고서 구매)에 사용됩니다.

## 인증 플로우

```
1. 정치인 선택 + 이메일 입력
        ↓
2. POST /api/politicians/auth/send-code
   → 6자리 숫자 코드 발송 (Resend API)
   → verification_id 반환
        ↓
3. 이메일에서 코드 확인 (10분 유효)
        ↓
4. POST /api/politicians/auth/verify-code
   → 코드 검증
   → 세션 토큰 발급 (1년 유효)
        ↓
5. 세션 토큰으로 정치인 활동
   - 댓글 작성
   - 게시글 작성
   - 상세평가 보고서 구매
```

## API 명세

### 1. 인증 코드 발송
```
POST /api/politicians/auth/send-code

Request:
{
  "politician_id": "62e7b453",  // 8자리 hex
  "email": "example@domain.com"
}

Response (200):
{
  "success": true,
  "verification_id": "uuid",
  "email": "ex***@domain.com",  // 마스킹
  "expires_at": "2025-12-13T06:10:00Z",
  "politician": {
    "id": "62e7b453",
    "name": "오세훈",
    "party": "국민의힘",
    "position": "서울특별시장"
  }
}
```

### 2. 인증 코드 검증
```
POST /api/politicians/auth/verify-code

Request:
{
  "verification_id": "uuid",
  "code": "123456"  // 6자리 숫자
}

Response (200):
{
  "success": true,
  "message": "오세훈님 본인 인증이 완료되었습니다.",
  "session": {
    "politician_id": "62e7b453",
    "session_token": "64자리 hex 문자열",
    "expires_at": "2026-12-13T06:00:00Z"  // 1년 후
  },
  "politician": {
    "id": "62e7b453",
    "name": "오세훈",
    "party": "국민의힘",
    "position": "서울특별시장",
    "verified_email": "example@domain.com"
  }
}
```

### 3. 세션 확인
```
GET /api/politicians/auth/session?politician_id=xxx&session_token=xxx

Response (200):
{
  "success": true,
  "valid": true,
  "politician": { ... }
}
```

## 세션 토큰 사용

### 정치인 댓글 작성
```
POST /api/comments/politician

{
  "post_id": "uuid",
  "politician_id": "62e7b453",
  "content": "댓글 내용",
  "session_token": "64자리 hex"
}
```

### 정치인 게시글 작성
```
POST /api/posts

{
  "subject": "게시글 제목",
  "content": "게시글 내용",
  "category": "general",
  "politician_id": "62e7b453",
  "session_token": "64자리 hex",
  "author_type": "politician"
}
```

### 상세평가 보고서 구매 (정치인 전용)
```
POST /api/reports/generate

{
  "politician_id": "62e7b453",
  "evaluation_id": "uuid",
  "session_token": "64자리 hex"
}

⚠️ 일반 회원은 구매 불가
   세션 토큰 없이 요청 시: "정치인 인증이 필요합니다. 일반 회원은 구매할 수 없습니다."
```

## 데이터베이스 테이블

### politician_email_verifications
| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| politician_id | TEXT | FK → politicians.id |
| email | TEXT | 인증 이메일 |
| verification_code | TEXT | 6자리 숫자 코드 |
| expires_at | TIMESTAMPTZ | 만료 시간 (10분) |
| verified | BOOLEAN | 인증 완료 여부 |
| verified_at | TIMESTAMPTZ | 인증 완료 시간 |
| created_at | TIMESTAMPTZ | 생성 시간 |

### politician_sessions
| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | UUID | PK |
| politician_id | TEXT | FK → politicians.id |
| session_token | TEXT | 64자리 hex 토큰 |
| expires_at | TIMESTAMPTZ | 만료 시간 (1년) |
| created_at | TIMESTAMPTZ | 생성 시간 |

## 프론트엔드 컴포넌트

### PoliticianAuthModal
- 경로: `src/components/PoliticianAuthModal.tsx`
- 용도: 정치인 인증 UI (정치인 선택 → 이메일 입력 → 코드 입력)
- 세션 저장: localStorage `politician_session`

## 환경 변수

```env
RESEND_API_KEY=re_xxxxxxxx
RESEND_FROM_EMAIL=noreply@politicianfinder.ai.kr
```

## 파일 목록

### 생성된 파일
- `0-4_Database/Supabase/migrations/062_politician_unified_auth.sql`
- `1_Frontend/src/app/api/politicians/auth/send-code/route.ts`
- `1_Frontend/src/app/api/politicians/auth/verify-code/route.ts`
- `1_Frontend/src/app/api/politicians/auth/session/route.ts`
- `1_Frontend/src/components/PoliticianAuthModal.tsx`
- `1_Frontend/src/lib/auth/politicianSession.ts`

### 수정된 파일
- `1_Frontend/src/app/api/comments/politician/route.ts`
- `1_Frontend/src/app/api/posts/route.ts`
- `1_Frontend/src/app/api/reports/generate/route.ts`
- `1_Frontend/src/app/community/posts/[id]/politician/page.tsx`

## 테스트 결과

| 기능 | 결과 |
|------|------|
| 인증 코드 발송 | ✅ 성공 |
| 인증 코드 검증 | ✅ 성공 |
| 정치인 댓글 작성 | ✅ 성공 |
| 정치인 게시글 작성 | ✅ 성공 |
| 보고서 구매 (정치인) | ✅ 정치인 전용 |
| 보고서 구매 (일반회원) | ❌ 차단됨 |

---
완료일: 2025-12-13
