# ì‘ì—…ì§€ì‹œì„œ: P4BA18

## ğŸ“‹ ê¸°ë³¸ ì •ë³´

- **ì‘ì—… ID**: P4BA18
- **ì—…ë¬´ëª…**: ì •ì¹˜ì¸ ê²€ì¦ API
- **Phase**: Phase 4
- **Area**: Backend APIs (BA)
- **ì„œë¸Œ ì—ì´ì „íŠ¸**: backend-developer
- **ì‘ì—… ë°©ì‹**: AI-Only

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

ì •ì¹˜ì¸ ë³¸ì¸ ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ - ê³µì§ìê°€ ìì‹ ì˜ í”„ë¡œí•„ì„ ì¸ì¦í•˜ê³  "Verified" ë°°ì§€ë¥¼ íšë“

---

## ğŸ”§ ì‚¬ìš© ë„êµ¬

```
[Claude ë„êµ¬]
Read, Edit, Write, Grep, Glob, Bash

[ê¸°ìˆ  ìŠ¤íƒ]
TypeScript, Next.js, Supabase, Zod, Nodemailer

[npm íŒ¨í‚¤ì§€]
- nodemailer (ì´ë©”ì¼ ì¸ì¦)

[ì „ë¬¸ ìŠ¤í‚¬]
api-builder, api-test
```

## ğŸ”— ì˜ì¡´ì„± ì •ë³´

**ì˜ì¡´ì„± ì²´ì¸**: P3BA1, P3BA2

ì´ ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‹¤ìŒ ì‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
- P3BA1: ì¸ì¦ API (ì‚¬ìš©ì ì¸ì¦)
- P3BA2: ì •ì¹˜ì¸ API (ì •ì¹˜ì¸ ë°ì´í„°)

---

## ğŸ“¦ ê¸°ëŒ€ ê²°ê³¼ë¬¼

- `src/app/api/politicians/verification/request/route.ts` (ê²€ì¦ ìš”ì²­ API)
- `src/app/api/politicians/verification/verify/route.ts` (ê²€ì¦ ìŠ¹ì¸ API)
- `src/app/api/politicians/verification/status/[politicianId]/route.ts` (ê²€ì¦ ìƒíƒœ ì¡°íšŒ)
- `src/lib/verification/email-sender.ts` (ê²€ì¦ ì´ë©”ì¼ ë°œì†¡)
- `0-4_Database/Supabase/migrations/016_create_verification_requests.sql` (ê²€ì¦ ìš”ì²­ í…Œì´ë¸”)

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. **ê²€ì¦ ìš”ì²­ ì‹œìŠ¤í…œ**
   - ì •ì¹˜ì¸ ë³¸ì¸ì´ ê²€ì¦ ìš”ì²­
   - ê³µì§ ì´ë©”ì¼ ì£¼ì†Œ ì œì¶œ (*.go.kr, *.assembly.go.kr)
   - ì¸ì¦ ì½”ë“œ ë°œì†¡

2. **ì´ë©”ì¼ ì¸ì¦**
   - 6ìë¦¬ ì¸ì¦ ì½”ë“œ ìƒì„±
   - ê³µì§ ì´ë©”ì¼ë¡œ ë°œì†¡
   - 15ë¶„ ìœ íš¨ ì‹œê°„

3. **ê²€ì¦ ìŠ¹ì¸**
   - ì¸ì¦ ì½”ë“œ í™•ì¸
   - `politicians.verified` = true ì—…ë°ì´íŠ¸
   - ê²€ì¦ ë°°ì§€ ë¶€ì—¬

4. **ê²€ì¦ ìƒíƒœ ì¡°íšŒ**
   - ê²€ì¦ ìš”ì²­ ì´ë ¥
   - ê²€ì¦ ìƒíƒœ (pending, verified, rejected)

5. **ê´€ë¦¬ì ìˆ˜ë™ ê²€ì¦**
   - ì„œë¥˜ ì‹¬ì‚¬ ê¸°ëŠ¥
   - ê²€ì¦ ê±°ë¶€ ì‚¬ìœ  ê¸°ë¡

---

## ğŸ“ ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì¤€ë¹„ ë‹¨ê³„

- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (`.env.local`):
  ```
  SMTP_HOST=smtp.gmail.com
  SMTP_PORT=587
  SMTP_USER=noreply@example.com
  SMTP_PASS=...
  ```
- npm íŒ¨í‚¤ì§€ ì„¤ì¹˜:
  ```bash
  npm install nodemailer
  npm install --save-dev @types/nodemailer
  ```

### 2. êµ¬í˜„ ë‹¨ê³„

**2.1 ê²€ì¦ ìš”ì²­ í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜**

```sql
-- 0-4_Database/Supabase/migrations/016_create_verification_requests.sql
CREATE TABLE verification_requests (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  politician_id UUID NOT NULL REFERENCES politicians(id),
  user_id UUID NOT NULL REFERENCES auth.users(id),

  -- ê²€ì¦ ì •ë³´
  official_email TEXT NOT NULL, -- *.go.kr, *.assembly.go.kr
  verification_code TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending', -- 'pending', 'verified', 'rejected'

  -- ì¶”ê°€ ì„œë¥˜ (ì„ íƒ)
  documents JSONB, -- ê³µì§ì¦ëª…ì„œ, ì¬ì§ì¦ëª…ì„œ ë“±

  -- ê´€ë¦¬ì ê²€í† 
  reviewed_by UUID REFERENCES auth.users(id),
  reviewed_at TIMESTAMP WITH TIME ZONE,
  rejection_reason TEXT,

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  code_expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_verification_requests_politician_id ON verification_requests(politician_id);
CREATE INDEX idx_verification_requests_user_id ON verification_requests(user_id);
CREATE INDEX idx_verification_requests_status ON verification_requests(status);

-- RLS ì •ì±…
ALTER TABLE verification_requests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own verification requests"
  ON verification_requests FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create verification requests"
  ON verification_requests FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- politicians í…Œì´ë¸”ì— verified ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE politicians ADD COLUMN verified BOOLEAN DEFAULT FALSE;
ALTER TABLE politicians ADD COLUMN verified_at TIMESTAMP WITH TIME ZONE;
```

**2.2 ì´ë©”ì¼ ë°œì†¡ ë¼ì´ë¸ŒëŸ¬ë¦¬**

```typescript
// src/lib/verification/email-sender.ts
import nodemailer from 'nodemailer'

export class VerificationEmailSender {
  private transporter: nodemailer.Transporter

  constructor() {
    this.transporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST,
      port: parseInt(process.env.SMTP_PORT || '587'),
      secure: false,
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASS
      }
    })
  }

  async sendVerificationEmail(
    email: string,
    politicianName: string,
    verificationCode: string
  ): Promise<void> {
    const mailOptions = {
      from: process.env.SMTP_USER,
      to: email,
      subject: `[ì •ì¹˜ì¸íŒŒì¸ë”] ${politicianName}ë‹˜ ë³¸ì¸ ì¸ì¦ ìš”ì²­`,
      html: `
        <h2>ì •ì¹˜ì¸ ë³¸ì¸ ì¸ì¦</h2>
        <p>${politicianName}ë‹˜ ì•ˆë…•í•˜ì„¸ìš”.</p>
        <p>ì •ì¹˜ì¸íŒŒì¸ë”ì—ì„œ ë³¸ì¸ ì¸ì¦ì„ ìš”ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
        <p>ì•„ë˜ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:</p>
        <h1 style="color: #3b82f6; letter-spacing: 4px;">${verificationCode}</h1>
        <p>ì´ ì½”ë“œëŠ” 15ë¶„ê°„ ìœ íš¨í•©ë‹ˆë‹¤.</p>
        <p>ë³¸ì¸ì´ ìš”ì²­í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´ ì´ë©”ì¼ì„ ë¬´ì‹œí•˜ì„¸ìš”.</p>
      `
    }

    await this.transporter.sendMail(mailOptions)
  }
}
```

**2.3 ê²€ì¦ ìš”ì²­ API**

```typescript
// src/app/api/politicians/verification/request/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { VerificationEmailSender } from '@/lib/verification/email-sender'
import { nanoid } from 'nanoid'

export async function POST(request: NextRequest) {
  const supabase = createClient()

  // 1. ì‚¬ìš©ì ì¸ì¦ í™•ì¸
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // 2. ìš”ì²­ ë°ì´í„° íŒŒì‹±
  const body = await request.json()
  const { politician_id, official_email } = body

  // 3. ê³µì§ ì´ë©”ì¼ ê²€ì¦
  const allowedDomains = ['go.kr', 'assembly.go.kr', 'korea.kr']
  const emailDomain = official_email.split('@')[1]
  const isOfficialEmail = allowedDomains.some(domain => emailDomain.endsWith(domain))

  if (!isOfficialEmail) {
    return NextResponse.json(
      { error: 'Invalid email', message: 'ê³µì§ ì´ë©”ì¼ ì£¼ì†Œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.' },
      { status: 400 }
    )
  }

  // 4. ì •ì¹˜ì¸ ì •ë³´ ì¡°íšŒ
  const { data: politician } = await supabase
    .from('politicians')
    .select('name, verified')
    .eq('id', politician_id)
    .single()

  if (!politician) {
    return NextResponse.json({ error: 'Politician not found' }, { status: 404 })
  }

  if (politician.verified) {
    return NextResponse.json(
      { error: 'Already verified', message: 'ì´ë¯¸ ê²€ì¦ëœ ì •ì¹˜ì¸ì…ë‹ˆë‹¤.' },
      { status: 400 }
    )
  }

  // 5. ì¸ì¦ ì½”ë“œ ìƒì„± (6ìë¦¬)
  const verificationCode = nanoid(6).toUpperCase()

  // 6. ë§Œë£Œ ì‹œê°„ ì„¤ì • (15ë¶„)
  const expiresAt = new Date()
  expiresAt.setMinutes(expiresAt.getMinutes() + 15)

  // 7. verification_requests í…Œì´ë¸”ì— ì €ì¥
  const { data: request, error } = await supabase
    .from('verification_requests')
    .insert({
      politician_id,
      user_id: user.id,
      official_email,
      verification_code: verificationCode,
      status: 'pending',
      code_expires_at: expiresAt.toISOString()
    })
    .select()
    .single()

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  // 8. ì´ë©”ì¼ ë°œì†¡
  const emailSender = new VerificationEmailSender()
  await emailSender.sendVerificationEmail(
    official_email,
    politician.name,
    verificationCode
  )

  return NextResponse.json({
    success: true,
    message: 'ì¸ì¦ ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
    request_id: request.id
  })
}
```

**2.4 ê²€ì¦ ìŠ¹ì¸ API**

```typescript
// src/app/api/politicians/verification/verify/route.ts
export async function POST(request: NextRequest) {
  const supabase = createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const body = await request.json()
  const { request_id, verification_code } = body

  // 1. ê²€ì¦ ìš”ì²­ ì¡°íšŒ
  const { data: verificationRequest } = await supabase
    .from('verification_requests')
    .select('*')
    .eq('id', request_id)
    .eq('user_id', user.id)
    .single()

  if (!verificationRequest) {
    return NextResponse.json({ error: 'Request not found' }, { status: 404 })
  }

  // 2. ì¸ì¦ ì½”ë“œ í™•ì¸
  if (verificationRequest.verification_code !== verification_code.toUpperCase()) {
    return NextResponse.json(
      { error: 'Invalid code', message: 'ì¸ì¦ ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' },
      { status: 400 }
    )
  }

  // 3. ë§Œë£Œ ì‹œê°„ í™•ì¸
  if (new Date() > new Date(verificationRequest.code_expires_at)) {
    return NextResponse.json(
      { error: 'Code expired', message: 'ì¸ì¦ ì½”ë“œê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' },
      { status: 400 }
    )
  }

  // 4. íŠ¸ëœì­ì…˜: politicians.verified = true, verification_requests.status = 'verified'
  const now = new Date().toISOString()

  const { error: updatePoliticianError } = await supabase
    .from('politicians')
    .update({
      verified: true,
      verified_at: now
    })
    .eq('id', verificationRequest.politician_id)

  if (updatePoliticianError) {
    return NextResponse.json({ error: updatePoliticianError.message }, { status: 500 })
  }

  const { error: updateRequestError } = await supabase
    .from('verification_requests')
    .update({
      status: 'verified',
      updated_at: now
    })
    .eq('id', request_id)

  if (updateRequestError) {
    return NextResponse.json({ error: updateRequestError.message }, { status: 500 })
  }

  return NextResponse.json({
    success: true,
    message: 'ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. "Verified" ë°°ì§€ê°€ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.'
  })
}
```

**2.5 ê²€ì¦ ìƒíƒœ ì¡°íšŒ API**

```typescript
// src/app/api/politicians/verification/status/[politicianId]/route.ts
export async function GET(
  request: NextRequest,
  { params }: { params: { politicianId: string } }
) {
  const supabase = createClient()

  const { data: politician } = await supabase
    .from('politicians')
    .select('verified, verified_at')
    .eq('id', params.politicianId)
    .single()

  if (!politician) {
    return NextResponse.json({ error: 'Politician not found' }, { status: 404 })
  }

  return NextResponse.json({
    success: true,
    verified: politician.verified,
    verified_at: politician.verified_at
  })
}
```

### 3. ê²€ì¦ ë‹¨ê³„

- íƒ€ì… ì²´í¬: `npm run type-check`
- ë¹Œë“œ: `npm run build`
- API í…ŒìŠ¤íŠ¸:
  - ê²€ì¦ ìš”ì²­ (ê³µì§ ì´ë©”ì¼)
  - ì´ë©”ì¼ ìˆ˜ì‹  í™•ì¸
  - ì¸ì¦ ì½”ë“œ ê²€ì¦
  - ê²€ì¦ ìƒíƒœ ì¡°íšŒ
- ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

### 4. ì™„ë£Œ ë‹¨ê³„

- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
- PROJECT GRID ì—…ë°ì´íŠ¸
- í™˜ê²½ ë³€ìˆ˜ ë¬¸ì„œí™”

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] ê²€ì¦ ìš”ì²­ API êµ¬í˜„
- [ ] ê³µì§ ì´ë©”ì¼ ê²€ì¦ êµ¬í˜„
- [ ] ì¸ì¦ ì½”ë“œ ìƒì„± ë° ë°œì†¡
- [ ] ì´ë©”ì¼ ë°œì†¡ êµ¬í˜„
- [ ] ê²€ì¦ ìŠ¹ì¸ API êµ¬í˜„
- [ ] ê²€ì¦ ìƒíƒœ ì¡°íšŒ API êµ¬í˜„
- [ ] `verification_requests` í…Œì´ë¸” ìƒì„±
- [ ] `politicians.verified` ì»¬ëŸ¼ ì¶”ê°€
- [ ] TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- [ ] Next.js ë¹Œë“œ ì„±ê³µ
- [ ] ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] RLS ì •ì±… ì ìš© í™•ì¸
- [ ] PROJECT GRID ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ

---

**ì‘ì—…ì§€ì‹œì„œ ìƒì„±ì¼**: 2025-11-09
**PROJECT GRID Version**: v4.2
