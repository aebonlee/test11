# ì‘ì—…ì§€ì‹œì„œ: P4BA16

## ğŸ“‹ ê¸°ë³¸ ì •ë³´

- **ì‘ì—… ID**: P4BA16
- **ì—…ë¬´ëª…**: ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ API
- **Phase**: Phase 4
- **Area**: Backend APIs (BA)
- **ì„œë¸Œ ì—ì´ì „íŠ¸**: backend-developer
- **ì‘ì—… ë°©ì‹**: AI-Only

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

ìœ ë£Œ êµ¬ë§¤ìê°€ AI í‰ê°€ ë¦¬í¬íŠ¸ PDFë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆëŠ” API êµ¬í˜„ (ê²°ì œ ê²€ì¦ í¬í•¨)

---

## ğŸ”§ ì‚¬ìš© ë„êµ¬

```
[Claude ë„êµ¬]
Read, Edit, Write, Grep, Glob, Bash

[ê¸°ìˆ  ìŠ¤íƒ]
TypeScript, Next.js, Supabase, Zod

[ì „ë¬¸ ìŠ¤í‚¬]
api-builder, api-test
```

## ğŸ”— ì˜ì¡´ì„± ì •ë³´

**ì˜ì¡´ì„± ì²´ì¸**: P3BA1, P4BA15, P4BA17

ì´ ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‹¤ìŒ ì‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
- P3BA1: ì¸ì¦ API (ì‚¬ìš©ì ì¸ì¦)
- P4BA15: PDF ë¦¬í¬íŠ¸ ìƒì„± API (PDF íŒŒì¼)
- P4BA17: ê²°ì œ ì‹œìŠ¤í…œ í†µí•© (ê²°ì œ ê²€ì¦)

---

## ğŸ“¦ ê¸°ëŒ€ ê²°ê³¼ë¬¼

- `src/app/api/reports/download/[evaluationId]/route.ts` (ë‹¤ìš´ë¡œë“œ API)
- `src/lib/auth/payment-verification.ts` (ê²°ì œ ê²€ì¦)
- `src/lib/storage/signed-url.ts` (ì„œëª…ëœ URL ìƒì„±)

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. **ì‚¬ìš©ì ì¸ì¦ í™•ì¸**
   - ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
   - JWT í† í° ê²€ì¦

2. **ê²°ì œ ê²€ì¦**
   - `payments` í…Œì´ë¸” ì¡°íšŒ
   - êµ¬ë§¤ ì´ë ¥ í™•ì¸
   - AI ëª¨ë¸ë³„ ê°œë³„ êµ¬ë§¤ ë˜ëŠ” ì „ì²´ êµ¬ë§¤ í™•ì¸

3. **PDF ë‹¤ìš´ë¡œë“œ**
   - Supabase Storage ì„œëª…ëœ URL ìƒì„± (1ì‹œê°„ ìœ íš¨)
   - ìŠ¤íŠ¸ë¦¬ë° ë‹¤ìš´ë¡œë“œ ì§€ì›
   - Content-Disposition í—¤ë” ì„¤ì •

4. **ë‹¤ìš´ë¡œë“œ ì´ë ¥ ê¸°ë¡**
   - `download_history` í…Œì´ë¸” ìƒì„±
   - ë‹¤ìš´ë¡œë“œ íšŸìˆ˜ ì œí•œ (êµ¬ë§¤ë‹¹ 10íšŒ)

5. **ì—ëŸ¬ ì²˜ë¦¬**
   - ë¯¸ê²°ì œ ì‚¬ìš©ì 403 ì—ëŸ¬
   - ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë¦¬í¬íŠ¸ 404 ì—ëŸ¬
   - ë‹¤ìš´ë¡œë“œ íšŸìˆ˜ ì´ˆê³¼ 429 ì—ëŸ¬

---

## ğŸ“ ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì¤€ë¹„ ë‹¨ê³„

- í”„ë¡œì íŠ¸ ë£¨íŠ¸: `Developement_Real_PoliticianFinder/1_Frontend`
- DB ìŠ¤í‚¤ë§ˆ í™•ì¸:
  - `payments` í…Œì´ë¸”
  - `ai_evaluations` í…Œì´ë¸”
- ì˜ì¡´ì„± ì‘ì—… ì™„ë£Œ í™•ì¸: P3BA1, P4BA15, P4BA17

### 2. êµ¬í˜„ ë‹¨ê³„

**2.1 ê²°ì œ ê²€ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬**

```typescript
// src/lib/auth/payment-verification.ts
import { createClient } from '@/lib/supabase/server'

export async function verifyPayment(
  userId: string,
  evaluationId: string
): Promise<{ verified: boolean; paymentId?: string }> {
  const supabase = createClient()

  // 1. í‰ê°€ ì •ë³´ ì¡°íšŒ
  const { data: evaluation } = await supabase
    .from('ai_evaluations')
    .select('politician_id, evaluator')
    .eq('id', evaluationId)
    .single()

  if (!evaluation) {
    return { verified: false }
  }

  // 2. ê²°ì œ ì´ë ¥ í™•ì¸
  const { data: payment } = await supabase
    .from('payments')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'completed')
    .or(`metadata->>politician_id.eq.${evaluation.politician_id}`)
    .order('created_at', { ascending: false })
    .limit(1)

  if (!payment) {
    return { verified: false }
  }

  // 3. êµ¬ë§¤ ë²”ìœ„ í™•ì¸
  const metadata = payment.metadata as any
  const purchasedAll = metadata.purchased_all === true
  const purchasedEvaluator = metadata.evaluators?.includes(evaluation.evaluator)

  if (purchasedAll || purchasedEvaluator) {
    return { verified: true, paymentId: payment.id }
  }

  return { verified: false }
}
```

**2.2 ì„œëª…ëœ URL ìƒì„±**

```typescript
// src/lib/storage/signed-url.ts
import { createClient } from '@/lib/supabase/server'

export async function createSignedDownloadUrl(
  reportUrl: string,
  expiresIn: number = 3600 // 1ì‹œê°„
): Promise<string> {
  const supabase = createClient()

  // reportUrlì—ì„œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
  const url = new URL(reportUrl)
  const filePath = url.pathname.replace('/storage/v1/object/public/reports/', '')

  const { data, error } = await supabase.storage
    .from('reports')
    .createSignedUrl(filePath, expiresIn)

  if (error) throw error

  return data.signedUrl
}
```

**2.3 ë‹¤ìš´ë¡œë“œ API**

```typescript
// src/app/api/reports/download/[evaluationId]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { verifyPayment } from '@/lib/auth/payment-verification'
import { createSignedDownloadUrl } from '@/lib/storage/signed-url'
import { createClient } from '@/lib/supabase/server'

export async function GET(
  request: NextRequest,
  { params }: { params: { evaluationId: string } }
) {
  const supabase = createClient()

  // 1. ì‚¬ìš©ì ì¸ì¦ í™•ì¸
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // 2. ê²°ì œ ê²€ì¦
  const { verified, paymentId } = await verifyPayment(user.id, params.evaluationId)
  if (!verified) {
    return NextResponse.json(
      { error: 'Payment required', message: 'ë¦¬í¬íŠ¸ë¥¼ êµ¬ë§¤í•œ ì‚¬ìš©ìë§Œ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.' },
      { status: 403 }
    )
  }

  // 3. ë‹¤ìš´ë¡œë“œ íšŸìˆ˜ í™•ì¸
  const { count } = await supabase
    .from('download_history')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', user.id)
    .eq('evaluation_id', params.evaluationId)

  if (count && count >= 10) {
    return NextResponse.json(
      { error: 'Download limit exceeded', message: 'ë‹¤ìš´ë¡œë“œ íšŸìˆ˜ ì´ˆê³¼ (ìµœëŒ€ 10íšŒ)' },
      { status: 429 }
    )
  }

  // 4. ë¦¬í¬íŠ¸ URL ì¡°íšŒ
  const { data: evaluation } = await supabase
    .from('ai_evaluations')
    .select('report_url')
    .eq('id', params.evaluationId)
    .single()

  if (!evaluation || !evaluation.report_url) {
    return NextResponse.json({ error: 'Report not found' }, { status: 404 })
  }

  // 5. ì„œëª…ëœ URL ìƒì„±
  const signedUrl = await createSignedDownloadUrl(evaluation.report_url)

  // 6. ë‹¤ìš´ë¡œë“œ ì´ë ¥ ê¸°ë¡
  await supabase.from('download_history').insert({
    user_id: user.id,
    evaluation_id: params.evaluationId,
    payment_id: paymentId,
    ip_address: request.headers.get('x-forwarded-for') || request.ip,
    user_agent: request.headers.get('user-agent')
  })

  // 7. ë¦¬ë‹¤ì´ë ‰íŠ¸
  return NextResponse.redirect(signedUrl)
}
```

**2.4 ë‹¤ìš´ë¡œë“œ ì´ë ¥ í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜**

```sql
-- 0-4_Database/Supabase/migrations/015_create_download_history.sql
CREATE TABLE download_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  evaluation_id UUID NOT NULL REFERENCES ai_evaluations(id),
  payment_id UUID NOT NULL REFERENCES payments(id),
  ip_address TEXT,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_download_history_user_id ON download_history(user_id);
CREATE INDEX idx_download_history_evaluation_id ON download_history(evaluation_id);

-- RLS ì •ì±…
ALTER TABLE download_history ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own download history"
  ON download_history FOR SELECT
  USING (auth.uid() = user_id);
```

### 3. ê²€ì¦ ë‹¨ê³„

- íƒ€ì… ì²´í¬: `npm run type-check`
- ë¹Œë“œ: `npm run build`
- API í…ŒìŠ¤íŠ¸:
  - ì¸ì¦ëœ ì‚¬ìš©ì + ê²°ì œ ì™„ë£Œ â†’ 200 OK
  - ì¸ì¦ëœ ì‚¬ìš©ì + ë¯¸ê²°ì œ â†’ 403 Forbidden
  - ë¯¸ì¸ì¦ ì‚¬ìš©ì â†’ 401 Unauthorized
  - ë‹¤ìš´ë¡œë“œ 10íšŒ ì´ˆê³¼ â†’ 429 Too Many Requests
- ì‹¤ì œ PDF ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸

### 4. ì™„ë£Œ ë‹¨ê³„

- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
- PROJECT GRID ì—…ë°ì´íŠ¸
- ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] ì‚¬ìš©ì ì¸ì¦ í™•ì¸ êµ¬í˜„
- [ ] ê²°ì œ ê²€ì¦ êµ¬í˜„
- [ ] ì„œëª…ëœ URL ìƒì„± êµ¬í˜„
- [ ] ë‹¤ìš´ë¡œë“œ API êµ¬í˜„
- [ ] ë‹¤ìš´ë¡œë“œ ì´ë ¥ ê¸°ë¡ êµ¬í˜„
- [ ] ë‹¤ìš´ë¡œë“œ íšŸìˆ˜ ì œí•œ (10íšŒ)
- [ ] `download_history` í…Œì´ë¸” ìƒì„±
- [ ] TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- [ ] Next.js ë¹Œë“œ ì„±ê³µ
- [ ] ì‹¤ì œ ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] RLS ì •ì±… ì ìš© í™•ì¸
- [ ] PROJECT GRID ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ

---

**ì‘ì—…ì§€ì‹œì„œ ìƒì„±ì¼**: 2025-11-09
**PROJECT GRID Version**: v4.2
