# P3F4: 정치인 데이터 스키마 완성 및 필드 매핑 작업

## 작업 개요
정치인 상세 페이지에서 표시하는 모든 정보가 데이터베이스에 저장될 수 있도록 스키마를 완성하고, snake_case(DB) ↔ camelCase(Frontend) 필드명 불일치를 API 레이어에서 자동 변환하도록 구현

## 작업 배경 및 필요성

### 문제점 분석 (2025-11-14)
`check_politician_schema.py` 스크립트 실행 결과:

1. **필드명 불일치 (Snake Case ↔ Camel Case)**: 5개 필드
   - DB: `birth_date` ↔ Frontend: `birthDate`
   - DB: `ai_score` ↔ Frontend: `claudeScore`
   - DB: `evaluation_score` ↔ Frontend: `totalScore`
   - DB: `evaluation_grade` ↔ Frontend: `grade`
   - DB: `updated_at` ↔ Frontend: `lastUpdated`

2. **완전히 누락된 필드 (추가 필요)**: 11개 필드
   - `name_kanji` (한자 이름)
   - **선관위 공식 정보 (9개)**:
     - `career` (경력 - JSONB 배열)
     - `election_history` (당선 이력 - JSONB 배열)
     - `military_service` (병역 - VARCHAR)
     - `assets` (재산 공개 - JSONB 객체)
     - `tax_arrears` (세금 체납 - VARCHAR)
     - `criminal_record` (범죄 경력 - VARCHAR)
     - `military_service_issue` (병역 의혹 - VARCHAR)
     - `residency_fraud` (위장전입 - VARCHAR)
     - `pledges` (주요 공약 - JSONB 배열)
     - `legislative_activity` (의정 활동 - JSONB 객체)

3. **계산 필드 (API에서 실시간 계산)**: 4개 필드
   - `age` ← `birth_date`로부터 계산
   - `postCount` ← `community_posts` 테이블에서 COUNT
   - `likeCount` ← 작성한 게시글의 `like_count` 합계
   - `taggedCount` ← 태깅된 게시글 수

### 해결 방안
1. **데이터베이스**: 누락된 11개 필드 추가
2. **API 레이어**: 필드 매핑 유틸리티 생성 (snake_case → camelCase)
3. **프론트엔드**: 통일된 TypeScript 인터페이스 정의

## 작업 범위

### 1. 데이터베이스 스키마 추가
- [ ] SQL 마이그레이션 스크립트 작성 (`add_politician_official_info_fields.sql`)
- [ ] 11개 필드 추가 실행
- [ ] 샘플 데이터로 검증

**추가할 필드**:
```sql
ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS name_kanji VARCHAR(200),
  ADD COLUMN IF NOT EXISTS career JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS election_history JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS military_service VARCHAR(500),
  ADD COLUMN IF NOT EXISTS assets JSONB DEFAULT '{}'::jsonb,
  ADD COLUMN IF NOT EXISTS tax_arrears VARCHAR(500) DEFAULT '없음',
  ADD COLUMN IF NOT EXISTS criminal_record VARCHAR(500) DEFAULT '없음',
  ADD COLUMN IF NOT EXISTS military_service_issue VARCHAR(500) DEFAULT '없음',
  ADD COLUMN IF NOT EXISTS residency_fraud VARCHAR(500) DEFAULT '없음',
  ADD COLUMN IF NOT EXISTS pledges JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS legislative_activity JSONB DEFAULT '{}'::jsonb;
```

### 2. 필드 매핑 유틸리티 생성
- [ ] `1_Frontend/src/utils/fieldMapper.ts` 생성
- [ ] snake_case → camelCase 변환 함수 작성
- [ ] 계산 필드 추가 로직 (age, postCount 등)

**핵심 함수**:
```typescript
export function mapPoliticianFields(dbRecord: any) {
  // Calculate age from birth_date
  const age = dbRecord.birth_date
    ? new Date().getFullYear() - new Date(dbRecord.birth_date).getFullYear()
    : 0;

  return {
    // Basic info (snake_case → camelCase)
    id: dbRecord.id,
    name: dbRecord.name,
    nameKanji: dbRecord.name_kanji || '',
    identity: dbRecord.identity,
    title: dbRecord.title,
    // ... (계속)

    // AI evaluation
    claudeScore: dbRecord.ai_score,
    totalScore: dbRecord.evaluation_score,
    grade: dbRecord.evaluation_grade,
    lastUpdated: dbRecord.updated_at,

    // Community activity (computed fields)
    postCount: dbRecord.post_count || 0,
    likeCount: dbRecord.like_count || 0,
    taggedCount: dbRecord.tagged_count || 0,

    // Election Commission info
    education: dbRecord.education || [],
    career: dbRecord.career || [],
    electionHistory: dbRecord.election_history || [],
    // ... (계속)
  };
}
```

### 3. API 수정 (커뮤니티 통계 계산 포함)
**수정할 파일 (2개)**:
- [ ] `1_Frontend/src/app/api/politicians/[id]/route.ts` - 상세 조회
- [ ] `1_Frontend/src/app/api/politicians/route.ts` - 목록 조회

**수정 내용**:
1. `mapPoliticianFields` 함수 임포트
2. 커뮤니티 통계 계산 (postCount, likeCount, taggedCount)
3. Response에 매핑된 데이터 반환

**예시 코드**:
```typescript
import { mapPoliticianFields } from '@/utils/fieldMapper';

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  // Fetch politician data
  const { data: politician } = await supabase
    .from('politicians')
    .select('*')
    .eq('id', id)
    .single();

  // Calculate community statistics
  const { data: posts } = await supabase
    .from('community_posts')
    .select('like_count')
    .eq('author_id', id)
    .eq('author_type', 'politician');

  const postCount = posts?.length || 0;
  const likeCount = posts?.reduce((sum, post) => sum + (post.like_count || 0), 0) || 0;

  // Count tagged posts
  const { count: taggedCount } = await supabase
    .from('community_posts')
    .select('*', { count: 'exact', head: true })
    .contains('tagged_politicians', [politician.name]);

  // Map fields and add computed values
  const mappedData = mapPoliticianFields({
    ...politician,
    post_count: postCount,
    like_count: likeCount,
    tagged_count: taggedCount || 0,
  });

  return NextResponse.json({ success: true, data: mappedData });
}
```

### 4. TypeScript 타입 정의
- [ ] `1_Frontend/src/types/politician.ts` 생성
- [ ] 모든 정치인 관련 컴포넌트에서 임포트
- [ ] TypeScript 에러 수정

**인터페이스 정의**:
```typescript
export interface Politician {
  // Basic info
  id: string;
  name: string;
  nameKanji: string;
  nameEn?: string;
  identity: string;
  title?: string;
  position: string;
  party: string;
  region: string;
  district?: string;
  birthDate: string;
  age: number;
  gender: string;

  // AI evaluation
  claudeScore: number;
  totalScore: number;
  grade: string;
  lastUpdated: string;

  // Community activity
  postCount: number;
  likeCount: number;
  taggedCount: number;

  // Election Commission info
  education: string[];
  career: string[];
  electionHistory: string[];
  militaryService: string;
  assets: {
    total?: string;
    real_estate?: string;
    financial?: string;
  };
  taxArrears: string;
  criminalRecord: string;
  militaryServiceIssue: string;
  residencyFraud: string;
  pledges: string[];
  legislativeActivity: {
    attendance_rate?: string;
    bills_proposed?: number;
    bills_passed?: number;
  };

  // Other fields
  profileImageUrl?: string;
  websiteUrl?: string;
  // ... (기타 필드)
}
```

### 5. 프론트엔드 컴포넌트 수정
**수정할 파일 (최소 2개)**:
- [ ] `1_Frontend/src/app/politicians/[id]/page.tsx` - 타입 임포트 및 적용
- [ ] `1_Frontend/src/app/politicians/page.tsx` - 타입 임포트 및 적용

**수정 내용**:
```typescript
import { Politician } from '@/types/politician';

// 기존 interface 제거, import한 타입 사용
const [politician, setPolitician] = useState<Politician>(SAMPLE_POLITICIAN);
```

## 작업 순서

### Phase 1: 데이터베이스 마이그레이션 (우선순위: 최상)
1. SQL 스크립트 검증 (`add_politician_official_info_fields.sql`)
2. 로컬 데이터베이스 적용
3. 샘플 데이터 업데이트 확인
4. Vercel Postgres 적용

### Phase 2: 필드 매핑 유틸리티 작성 (우선순위: 상)
1. `utils/fieldMapper.ts` 생성
2. snake_case → camelCase 변환 로직 작성
3. 계산 필드 로직 작성 (age, postCount 등)
4. 단위 테스트 작성 (선택)

### Phase 3: API 수정 (우선순위: 상)
1. GET /api/politicians/[id] - 커뮤니티 통계 계산 추가
2. GET /api/politicians - 목록 조회 시에도 적용
3. 모든 응답에 `mapPoliticianFields` 적용
4. Postman/Thunder Client로 API 테스트

### Phase 4: 타입 정의 및 프론트엔드 수정 (우선순위: 상)
1. `types/politician.ts` 생성
2. 정치인 상세 페이지 수정
3. 정치인 목록 페이지 수정
4. TypeScript 에러 수정

### Phase 5: 테스트 및 검증 (우선순위: 상)
1. 정치인 상세 페이지 확인 (모든 필드 표시 검증)
2. 정치인 목록 페이지 확인
3. `npm run build` 테스트
4. TypeScript 타입 에러 확인

## 예상 소요 시간
- Phase 1 (DB 마이그레이션): 30분
- Phase 2 (필드 매핑 유틸리티): 30분
- Phase 3 (API 수정): 1시간
- Phase 4 (타입 정의 및 프론트엔드): 1시간
- Phase 5 (테스트 및 검증): 30분
- **총 예상 시간**: 3.5시간

## 위험 요소 및 대응 방안

### 위험 1: JSONB 필드 타입 불일치
- **위험도**: 중
- **대응**: API에서 배열/객체 타입 검증 추가
- **Rollback 계획**: 기본값(빈 배열/빈 객체) 사용

### 위험 2: 계산 필드 성능 문제
- **위험도**: 중
- **대응**: 커뮤니티 통계는 캐싱 고려 (postCount는 실시간 계산)
- **Rollback 계획**: DB에 통계 컬럼 추가 후 주기적 업데이트

### 위험 3: 필드명 매핑 누락
- **위험도**: 하
- **대응**: `check_politician_schema.py` 스크립트로 검증
- **Rollback 계획**: 누락 필드는 기본값 반환

## 성공 기준
1. ✅ 모든 필드가 데이터베이스에 저장 가능
2. ✅ API Response가 프론트엔드 인터페이스와 완전히 일치
3. ✅ camelCase 필드명으로 통일
4. ✅ 커뮤니티 통계가 실시간으로 계산됨
5. ✅ TypeScript 타입 에러 없음
6. ✅ `npm run build` 성공
7. ✅ 정치인 상세 페이지에서 모든 정보 표시 확인

## 관련 파일 목록
- **Database**: `politicians` 테이블
- **Migration**: `add_politician_official_info_fields.sql`
- **Utils**: `1_Frontend/src/utils/fieldMapper.ts` (신규 생성)
- **Types**: `1_Frontend/src/types/politician.ts` (신규 생성)
- **API (2개)**:
  - `1_Frontend/src/app/api/politicians/[id]/route.ts`
  - `1_Frontend/src/app/api/politicians/route.ts`
- **Frontend (2개+)**:
  - `1_Frontend/src/app/politicians/[id]/page.tsx`
  - `1_Frontend/src/app/politicians/page.tsx`
- **Validation**: `check_politician_schema.py`

## 의존성
- **선행 작업**: 없음 (P3F3과 병렬 진행 가능)
- **후속 작업**: P4BA20 (정치인 데이터 자동 수집) - 스키마가 완성되어야 데이터 수집 가능

## 참고사항
- 이 작업은 **데이터 구조의 완성**이므로 신중하게 진행
- snake_case ↔ camelCase 변환을 API 레이어에서 처리하여 DB와 Frontend 간 일관성 유지
- 계산 필드는 캐싱 전략 고려 필요 (향후 성능 최적화 시)
- P3F3 (status 필드 제거)와 P3F4 (스키마 완성)는 병렬 진행 가능하지만, P3F4를 먼저 완료하면 P3F3에서 전체 타입 시스템을 활용할 수 있음
