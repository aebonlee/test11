# 관리자 페이지: 상세 평가 보고서 판매 관리 기능 기획

## 📋 개요

### 현황
- **상세 평가 보고서**: 정치인들에게 자신에 대한 AI 평가 보고서를 판매
- **현재 상태**: 결제 시스템(`payments` 테이블)은 존재하지만 관리자 페이지 없음
- **문제점**: 보고서 판매 현황, 입금 여부, 발송 여부를 관리할 수단이 없음

### 목적
정치인들이 구매하는 상세 평가 보고서의 입금/발송을 체계적으로 관리

---

## 🎯 핵심 기능 요구사항

### 1. 보고서 구매 내역 관리
**필요한 정보**:
- 구매자 (정치인 이름, 연락처)
- 구매한 보고서 종류
- 결제 금액
- **입금 여부** (대기, 확인완료)
- **입금 일시**
- **보고서 발송 여부** (미발송, 발송완료)
- **발송 일시**

### 2. 보고서 발송 관리
**필요한 기능**:
- 입금 확인 체크
- 보고서 이메일 발송 체크
- 발송 대기 목록
- 발송 완료 처리
- 발송한 관리자 기록

---

## 🗄️ 데이터베이스 설계

### 새로운 테이블: `report_purchases`

```sql
CREATE TABLE IF NOT EXISTS public.report_purchases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- 구매자 정보 (정치인)
    politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
    buyer_name VARCHAR(100) NOT NULL,  -- politicians.name에서 자동 입력
    buyer_email VARCHAR(255) NOT NULL  -- politicians.email에서 자동 입력 (이메일 발송용)
    -- 전화번호는 저장 안 함 (필요시 politicians.phone 참조)

    -- 결제 정보
    payment_id UUID REFERENCES payments(id) ON DELETE CASCADE,
    amount DECIMAL(10, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'KRW',

    -- ✅ 입금 여부 (심플하게)
    payment_confirmed BOOLEAN DEFAULT FALSE,
    payment_confirmed_at TIMESTAMPTZ,
    payment_confirmed_by UUID REFERENCES users(user_id),

    -- 보고서 정보
    report_type VARCHAR(50) NOT NULL
        CHECK (report_type IN ('basic', 'standard', 'premium', 'custom')),
    report_period VARCHAR(50),  -- '2025-Q1', '2025-01' 등

    -- ✅ 발송 여부 (심플하게)
    sent BOOLEAN DEFAULT FALSE,
    sent_at TIMESTAMPTZ,
    sent_by UUID REFERENCES users(user_id),
    sent_email TEXT,  -- 실제 발송한 이메일 주소

    -- 관리자 메모
    notes TEXT,

    -- 타임스탬프
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_report_purchases_politician_id ON report_purchases(politician_id);
CREATE INDEX idx_report_purchases_payment_confirmed ON report_purchases(payment_confirmed);
CREATE INDEX idx_report_purchases_sent ON report_purchases(sent);
CREATE INDEX idx_report_purchases_created_at ON report_purchases(created_at DESC);

-- 복합 인덱스 (발송 대기 목록용)
CREATE INDEX idx_report_purchases_pending_send
    ON report_purchases(payment_confirmed, sent)
    WHERE payment_confirmed = TRUE AND sent = FALSE;
```

### 새로운 테이블: `email_verifications` (이메일 인증용)

```sql
CREATE TABLE IF NOT EXISTS public.email_verifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
    email VARCHAR(255) NOT NULL,
    verification_code VARCHAR(6) NOT NULL,  -- 6자리 숫자 (예: "123456")
    purpose VARCHAR(50) NOT NULL DEFAULT 'report_purchase',
    verified BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMPTZ NOT NULL,  -- NOW() + 10분
    verified_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_email_verifications_code ON email_verifications(verification_code, expires_at);
CREATE INDEX idx_email_verifications_politician ON email_verifications(politician_id);
```

### 기존 테이블 활용: `payments`
- 이미 존재하는 `payments` 테이블과 연동
- `purpose` 필드에 `'detailed_report'` 값 사용
- `metadata`에 보고서 종류 등 저장

---

## 🎨 관리자 UI 설계

### 메인 페이지: `/admin/report-sales`

**단일 페이지 (탭 없음, 심플하게)**

### 필터 옵션
- 기간 선택 (오늘, 7일, 30일, 전체)
- 입금 상태 (전체, 미확인, 확인완료)
- 발송 상태 (전체, 미발송, 발송완료)
- 보고서 종류 (전체, 기본, 스탠다드, 프리미엄)
- 검색 (정치인 이름, 이메일, 전화번호)

### 테이블 컬럼
```
구매ID | 정치인명 | 이메일 | 보고서종류 | 금액 | 입금확인 | 입금일시 | 발송완료 | 발송일시 | 구매일시 | 작업
```

### 상태 표시
**입금 확인**:
- ⏳ 미확인 (회색)
- ✅ 확인완료 (초록색) + 입금일시 + 확인한 관리자

**발송 완료**:
- ⏳ 미발송 (회색)
- ✅ 발송완료 (파란색) + 발송일시 + 발송한 관리자

### 작업 버튼
각 행마다:
1. **[입금확인]** 버튼
   - 미확인 상태일 때만 표시
   - 클릭 시 → 확인 완료 처리
   - 확인 일시와 관리자 자동 기록

2. **[보고서 발송]** 버튼
   - 입금 확인된 것만 활성화
   - 클릭 시 → 이메일 발송 확인 모달
   - 발송 완료 처리
   - 발송 일시와 관리자 자동 기록

3. **[상세보기]** 버튼
   - 메모 확인/수정
   - 전체 이력 조회

### 페이지네이션
- 20개/페이지

---

## 📊 상단 통계 카드 (간단하게)

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│  이번 달 매출│  입금 대기   │  발송 대기   │  총 판매     │
│  ₩3,450,000 │  5건         │  3건         │  304건       │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

---

## 🔐 이메일 인증 프로세스 (구매 전 본인 확인)

### 인증 프로세스 흐름

```
1. 정치인이 보고서 구매 시도
   ↓
2. 본인 인증 폼 입력
   - 이름 (필수)
   - 소속 정당 (필수)
   - 출마직종 (필수)
   ↓
3. [인증 코드 발송] 버튼 클릭
   ↓
4. DB에서 정치인 정보 조회
   - politicians 테이블 검색
   - 이름 + 정당 + 직위 일치 확인
   ↓
5. 이메일로 6자리 인증 코드 발송
   📧 해당 정치인 이메일로 전송
   예: "AB12CD" (10분 유효)
   ↓
6. 정치인이 이메일 확인 후 코드 입력
   ↓
7. 코드 검증
   - 일치 여부 확인
   - 유효 시간 확인 (10분 이내)
   ↓
8-A. 인증 성공 → 결제 페이지로 이동
8-B. 인증 실패 → 오류 메시지 표시
```

### 인증 코드 이메일 템플릿

**제목**:
```
[PoliticianFinder] 보고서 구매 인증 코드
```

**본문 (HTML)**:
```html
<!DOCTYPE html>
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
  <h2 style="color: #064E3B;">안녕하세요, {정치인명}님</h2>

  <p>PoliticianFinder 상세 평가 보고서 구매를 위한 이메일 인증 코드입니다.</p>

  <div style="background: #f3f4f6; padding: 20px; margin: 20px 0; text-align: center; border-radius: 8px;">
    <h1 style="color: #064E3B; font-size: 36px; letter-spacing: 8px; margin: 0;">
      {인증코드}
    </h1>
  </div>

  <p><strong>유효 시간:</strong> 10분</p>

  <p style="color: #999; font-size: 14px; margin-top: 30px;">
    본인이 요청하지 않았다면 이 메일을 무시하셔도 됩니다.
  </p>

  <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
  <p style="color: #666; font-size: 12px;">
    PoliticianFinder 팀<br>
    https://www.politicianfinder.ai.kr
  </p>
</body>
</html>
```

### 보안 원리

**이메일 소유권 = 본인 증명**

```
정치인 정보 (이름/정당/직위) → 누구나 알 수 있음
         +
이메일 소유권 (6자리 코드 확인) → 본인만 알 수 있음
         =
본인 인증 완료 ✅
```

**보안 체계:**
1. 1단계 필터: 이름/정당/직위로 정치인 식별
2. 2단계 필터: 해당 정치인 이메일로 코드 발송
3. 3단계 필터: 코드 입력으로 이메일 소유권 확인
4. 시간 제한: 10분 내 인증 필요

### 예외 상황 처리

**1. DB에 이메일이 없는 경우:**
```
"이메일 정보가 등록되어 있지 않습니다.
관리자에게 문의해주세요.

📧 고객센터: support@politicianfinder.ai.kr"
```

**2. 이메일 발송 실패:**
```
"이메일 발송에 실패했습니다.
잠시 후 다시 시도해주세요."
```

**3. 코드 재발송:**
```
"인증 코드를 받지 못하셨나요?

[코드 재발송] 버튼 클릭
→ 새로운 코드 발송
→ 이전 코드는 자동 무효화"
```

---

## 📧 이메일 발송 (Resend 사용)

### ✅ 사용 가능한 이메일 시스템
- **Resend**: 이미 설정되어 있음
- **API Key**: `re_8hjt3JJR_5GD6Q8twLftC1LficQqkH9E7`
- **발신 이메일**: `noreply@politicianfinder.ai.kr`

### 보고서 이메일 내용

**제목**:
```
[PoliticianFinder] {정치인명}님의 상세 평가 보고서
```

**본문 (HTML)**:
```html
<!DOCTYPE html>
<html>
<body>
  <h2>안녕하세요, {정치인명}님</h2>

  <p>PoliticianFinder 상세 평가 보고서를 보내드립니다.</p>

  <table style="border: 1px solid #ddd; padding: 10px;">
    <tr><td><strong>보고서 종류:</strong></td><td>{기본/스탠다드/프리미엄}</td></tr>
    <tr><td><strong>평가 기간:</strong></td><td>{기간}</td></tr>
    <tr><td><strong>발급 일시:</strong></td><td>{발급일시}</td></tr>
  </table>

  <p>보고서는 첨부 파일을 확인해주세요.</p>

  <hr>
  <p style="color: #666; font-size: 12px;">
    PoliticianFinder 팀<br>
    https://www.politicianfinder.ai.kr
  </p>
</body>
</html>
```

**첨부**:
- PDF 보고서 파일 (나중에 구현)
- 현재는 첨부 없이 본문만 발송

### 발송 프로세스
1. 관리자가 [보고서 발송] 버튼 클릭
2. API 호출: `POST /api/admin/report-sales/:id/send-report`
3. Resend API로 이메일 발송
4. 발송 성공 시:
   - `sent = TRUE`
   - `sent_at = NOW()`
   - `sent_by = admin_id`
   - `sent_email = 실제 발송된 이메일 주소`
5. 관리자에게 성공 메시지 표시

---

## 🚀 구현 단계

### Phase 1 (MVP - 완전 기능)
1. ✅ `email_verifications` 테이블 생성 (이메일 인증용)
2. ✅ 이메일 인증 API (인증 코드 발송/확인)
3. ✅ 결제 페이지 이메일 인증 UI 추가
4. ✅ `report_purchases` 테이블 생성
5. ✅ 관리자 페이지 생성 (`/admin/report-sales`)
6. ✅ 구매 내역 목록 (필터, 검색, 페이지네이션)
7. ✅ 입금 확인 버튼 및 처리
8. ✅ **보고서 이메일 발송 기능 (Resend 사용)** ⭐
9. ✅ 상단 통계 카드 (4개)

### Phase 2 (추후 고도화)
- ⏳ PDF 보고서 자동 생성
- ⏳ 이메일 첨부 파일 기능
- ⏳ 매출 상세 통계 및 그래프
- ⏳ 자동 이메일 스케줄링

---

## 💡 참고사항

### 1. 보고서 종류 및 가격 (예시)
```
┌─────────────┬──────────┬─────────────────────────────────┐
│ 보고서 종류 │  가격    │  포함 내용                       │
├─────────────┼──────────┼─────────────────────────────────┤
│ 기본        │ ₩50,000  │ 10개 평가 항목 기본 분석        │
│ 스탠다드    │ ₩150,000 │ 기본 + 상세 분석 + 개선 제안    │
│ 프리미엄    │ ₩300,000 │ 스탠다드 + 비교 분석 + 컨설팅   │
│ 맞춤형      │ 협의     │ 고객 요청에 따른 맞춤 보고서    │
└─────────────┴──────────┴─────────────────────────────────┘
```

### 2. 입금 방식
- 계좌이체 (주로 사용)
- 관리자가 수동으로 입금 확인
- 입금자명과 정치인명 대조

---

## 📝 API 엔드포인트

### 이메일 인증 API
```
POST   /api/politicians/verify/send-code    // 인증 코드 발송
POST   /api/politicians/verify/check-code   // 인증 코드 확인
```

### 보고서 판매 관리 API
```
GET    /api/admin/report-sales                     // 구매 목록 (필터, 검색, 페이지네이션)
GET    /api/admin/report-sales/:id                 // 상세 조회
POST   /api/admin/report-sales                     // 수동 등록
PATCH  /api/admin/report-sales/:id/confirm-payment // 입금 확인
POST   /api/admin/report-sales/:id/send-report     // 보고서 발송
PATCH  /api/admin/report-sales/:id                 // 메모 수정
GET    /api/admin/report-sales/statistics          // 통계 (4개 카드용)
```

---

## 📋 화면 예시

```
관리자 > 보고서 판매 관리
┌────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  ┌──────────┬───────────┬───────────┬────────────┐                │
│  │이번 달   │입금 대기  │발송 대기  │총 판매     │                │
│  │₩3.4M    │5건        │3건        │304건       │                │
│  └──────────┴───────────┴───────────┴────────────┘                │
│                                                                      │
│  필터: [기간▼] [입금▼] [발송▼] [종류▼]  검색: [________][🔍]     │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │ID  정치인  연락처  종류  금액  입금  입금일  발송  발송일  작업││
│  ├──────────────────────────────────────────────────────────────┤ │
│  │001 김철수 010-xxx  프리 300K ✅완료 11/28  ✅완료 11/29 [보기]││
│  │002 이영희 lee@... 스탠 150K ✅완료 11/27  ⏳미발송 - [발송]  ││
│  │003 박민수 010-yyy 기본  50K ⏳미확인 -   ⏳미발송 - [입금]  ││
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  [◀ 이전]  1 2 3 4 5  [다음 ▶]                    20개/페이지     │
└────────────────────────────────────────────────────────────────────┘
```

---

**작성일**: 2025-12-01
**작성자**: Claude Code
**버전**: 2.0 (이메일 인증 추가)
**상태**: 최종 (사용자 승인 완료)

---

## 📌 핵심 요약

1. **🔐 이메일 인증**: 6자리 코드로 정치인 본인 확인 (구매 전 필수)
2. **입금 확인**: 정치인이 돈을 보냈는지 체크 → [입금확인] 버튼
3. **보고서 발송**: ⭐ **Resend로 실제 이메일 발송** → [보고서 발송] 버튼
4. **간단한 목록**: 누가 샀는지, 얼마 샀는지, 입금/발송 상태
5. **환불 없음**: 환불 기능 제외
6. **전화번호 불필요**: 이메일만 있으면 됨
7. **20개/페이지**: 페이지네이션

### 🎯 이메일 발송 기능 (Resend)

**[보고서 발송]** 버튼 클릭 시:
```javascript
// API에서 Resend로 이메일 발송
await resend.emails.send({
  from: 'noreply@politicianfinder.ai.kr',
  to: buyer_email,
  subject: `[PoliticianFinder] ${buyer_name}님의 상세 평가 보고서`,
  html: `보고서 내용...`
});

// 발송 성공 시 DB 업데이트
UPDATE report_purchases SET
  sent = TRUE,
  sent_at = NOW(),
  sent_by = admin_id,
  sent_email = buyer_email
WHERE id = purchase_id;
```

**장점**:
- ✅ 관리자 페이지에서 바로 발송
- ✅ 정치인 이메일로 직접 전송
- ✅ 발송 이력 자동 기록
- ✅ 추가 비용 없음 (Resend 무료 플랜)
