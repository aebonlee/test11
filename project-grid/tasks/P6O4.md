# 작업지시서: P6O4

## 📋 기본 정보

- **작업 ID**: P6O4
- **업무명**: 보안 설정
- **Phase**: Phase 6
- **Area**: Operations (O)
- **서브 에이전트**: devops-engineer
- **작업 방식**: AI-Only

---

## 🎯 작업 목표

Rate Limiting + CORS + CSP 설정

---

## 🔧 사용 도구

```
[Claude 도구]
Read, Edit, Write, Grep, Glob, Bash

[기술 스택]
GitHub Actions, Vercel, Sentry

[전문 스킬]
ci-cd, deployment
```

**도구 설명**:
- **Claude 도구**: Claude Code의 기본 기능 (Read, Write, Edit, Bash, Glob, Grep 등)
- **기술 스택**: 프로젝트에 사용되는 프레임워크 및 라이브러리
- **전문 스킬**: Anthropic 빌트인 스킬 (.claude/skills/*.md 참조)

## 🔗 의존성 정보

**의존성 체인**: P6O2

이 작업을 시작하기 전에 다음 작업이 완료되어야 합니다: P6O2

---

## 📦 기대 결과물

**생성할 파일:**
1. `middleware.ts` - Rate Limiting, CORS, CSP 미들웨어
2. `lib/security/rate-limit.ts` - Rate Limiting 헬퍼

**설치 필요 패키지:**
```bash
npm install @upstash/redis @upstash/ratelimit
```

**Rate Limiting 설정:**
- API 엔드포인트: 100 req/min per IP
- 로그인: 5 req/min per IP
- 회원가입: 3 req/hour per IP

**CORS 설정:**
```typescript
{
  origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  credentials: true
}
```

**CSP 헤더:**
```
default-src 'self';
script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.googletagmanager.com;
style-src 'self' 'unsafe-inline';
img-src 'self' data: https:;
connect-src 'self' https://*.supabase.co;
```

**환경 변수:**
- `UPSTASH_REDIS_REST_URL`
- `UPSTASH_REDIS_REST_TOKEN`
- `ALLOWED_ORIGINS`

**구현해야 할 세부 항목**:

1. Rate Limiting 미들웨어 (Upstash Redis 사용)
2. CORS 설정 (허용 도메인 제한)
3. CSP (Content Security Policy) 설정
4. 환경 변수 보안 점검 (.env 파일 gitignore 확인)
5. API Key 관리 (Vercel 환경 변수 사용)
6. 보안 헤더 추가 (HSTS, X-Content-Type-Options)

각 항목을 체계적으로 구현하고 테스트하세요.

---

## 💾 구현 파일 저장 위치

**루트 폴더**: `5_DevOps/`

**파일 경로**:
```
5_DevOps/
└── middleware.ts
```

**절대 경로 별칭**: 해당 없음 (프로젝트 루트의 middleware 파일)

**참고**: Next.js middleware는 프로젝트 루트에 위치하지만, 관리 목적상 5_DevOps 폴더에서 관리합니다.

---

## 📝 작업 지시사항

### 1. 준비 단계

- 프로젝트 루트 디렉토리에서 작업 시작
- 필요한 도구 확인: GitHub Actions/Vercel/Sentry
- 의존성 작업 완료 확인 (P6O2)

### 2. 구현 단계

**구현해야 할 세부 항목**:

1. Rate Limiting 미들웨어 (Upstash Redis)
2. CORS 설정
3. CSP (Content Security Policy) 설정
4. 환경 변수 보안 점검
5. API Key 관리

각 항목을 체계적으로 구현하고 테스트하세요.

### 3. 검증 단계

- 작성한 코드의 정상 동작 확인
- 타입 체크 및 린트 통과
- 필요한 경우 단위 테스트 작성
- 코드 리뷰 준비

### 4. 완료 단계

- 생성된 파일 목록 확인
- PROJECT GRID 상태 업데이트
- 다음 의존 작업에 영향 확인

---

## ✅ 완료 기준

- [ ] 보안 설정 기능이 정상적으로 구현됨
- [ ] 기대 결과물이 모두 생성됨
- [ ] 코드가 정상적으로 빌드/실행됨
- [ ] 타입 체크 및 린트 통과
- [ ] PROJECT GRID 상태 업데이트 완료
- [ ] Rate Limiting 작동 확인
- [ ] 보안 헤더 설정 확인

---

**작업지시서 생성일**: 2025-11-06
**PROJECT GRID Version**: v4.0
