# ì‘ì—…ì§€ì‹œì„œ: P4BA17

## ğŸ“‹ ê¸°ë³¸ ì •ë³´

- **ì‘ì—… ID**: P4BA17
- **ì—…ë¬´ëª…**: ê²°ì œ ì‹œìŠ¤í…œ í†µí•© (í† ìŠ¤í˜ì´ë¨¼ì¸ )
- **Phase**: Phase 4
- **Area**: Backend APIs (BA)
- **ì„œë¸Œ ì—ì´ì „íŠ¸**: backend-developer
- **ì‘ì—… ë°©ì‹**: AI-Only

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

í† ìŠ¤í˜ì´ë¨¼ì¸  APIë¥¼ í†µí•©í•˜ì—¬ AI í‰ê°€ ë¦¬í¬íŠ¸ êµ¬ë§¤ ê²°ì œ ì‹œìŠ¤í…œ êµ¬í˜„

---

## ğŸ”§ ì‚¬ìš© ë„êµ¬

```
[Claude ë„êµ¬]
Read, Edit, Write, Grep, Glob, Bash

[ê¸°ìˆ  ìŠ¤íƒ]
TypeScript, Next.js, Supabase, Zod

[ì™¸ë¶€ API]
- í† ìŠ¤í˜ì´ë¨¼ì¸  API (https://toss.im)

[npm íŒ¨í‚¤ì§€]
- @tosspayments/payment-sdk

[ì „ë¬¸ ìŠ¤í‚¬]
api-builder, api-test
```

## ğŸ”— ì˜ì¡´ì„± ì •ë³´

**ì˜ì¡´ì„± ì²´ì¸**: P3BA1, P3BA2, P3BA11

ì´ ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‹¤ìŒ ì‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
- P3BA1: ì¸ì¦ API (ì‚¬ìš©ì ì¸ì¦)
- P3BA2: ì •ì¹˜ì¸ API (ì •ì¹˜ì¸ ë°ì´í„°)
- P3BA11: AI í‰ê°€ ì¡°íšŒ API (í‰ê°€ ë°ì´í„°)

---

## ğŸ“¦ ê¸°ëŒ€ ê²°ê³¼ë¬¼

- `src/lib/payment/toss-client.ts` (í† ìŠ¤í˜ì´ë¨¼ì¸  í´ë¼ì´ì–¸íŠ¸)
- `src/app/api/payments/checkout/route.ts` (ê²°ì œ ìš”ì²­ API)
- `src/app/api/payments/confirm/route.ts` (ê²°ì œ ìŠ¹ì¸ API)
- `src/app/api/payments/webhook/route.ts` (ì›¹í›… ì²˜ë¦¬)
- `src/app/api/payments/history/route.ts` (ê²°ì œ ì´ë ¥ ì¡°íšŒ)

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. **í† ìŠ¤í˜ì´ë¨¼ì¸  SDK í†µí•©**
   - í´ë¼ì´ì–¸íŠ¸ í‚¤, ì‹œí¬ë¦¿ í‚¤ ì„¤ì •
   - ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™”

2. **ê²°ì œ ìš”ì²­ API**
   - ì£¼ë¬¸ ID ìƒì„±
   - ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
     - AI ëª¨ë¸ë³„ ê°œë³„ êµ¬ë§¤: â‚©500,000
     - 5ê°œ AI ëª¨ë¸ ì „ì²´ êµ¬ë§¤: â‚©2,500,000
   - ê²°ì œ URL ìƒì„±

3. **ê²°ì œ ìŠ¹ì¸ API**
   - í† ìŠ¤í˜ì´ë¨¼ì¸  ìŠ¹ì¸ API í˜¸ì¶œ
   - `payments` í…Œì´ë¸” ì—…ë°ì´íŠ¸
   - íŠ¸ëœì­ì…˜ ì²˜ë¦¬

4. **ì›¹í›… ì²˜ë¦¬**
   - ê²°ì œ ì„±ê³µ ì•Œë¦¼
   - ê²°ì œ ì·¨ì†Œ ì•Œë¦¼
   - í™˜ë¶ˆ ì²˜ë¦¬

5. **ê²°ì œ ì´ë ¥ ì¡°íšŒ API**
   - ì‚¬ìš©ìë³„ ê²°ì œ ì´ë ¥
   - ì •ì¹˜ì¸ë³„ êµ¬ë§¤ ë‚´ì—­

---

## ğŸ“ ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì¤€ë¹„ ë‹¨ê³„

- í† ìŠ¤í˜ì´ë¨¼ì¸  ê°€ì…: https://toss.im
- í´ë¼ì´ì–¸íŠ¸ í‚¤, ì‹œí¬ë¦¿ í‚¤ ë°œê¸‰
- í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (`.env.local`):
  ```
  NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_...
  TOSS_SECRET_KEY=test_sk_...
  ```
- npm íŒ¨í‚¤ì§€ ì„¤ì¹˜:
  ```bash
  npm install @tosspayments/payment-sdk
  ```

### 2. êµ¬í˜„ ë‹¨ê³„

**2.1 í† ìŠ¤í˜ì´ë¨¼ì¸  í´ë¼ì´ì–¸íŠ¸**

```typescript
// src/lib/payment/toss-client.ts
export class TossPaymentClient {
  private clientKey: string
  private secretKey: string
  private baseURL: string = 'https://api.tosspayments.com/v1'

  constructor() {
    this.clientKey = process.env.NEXT_PUBLIC_TOSS_CLIENT_KEY!
    this.secretKey = process.env.TOSS_SECRET_KEY!
  }

  async requestPayment(orderId: string, amount: number, orderName: string) {
    // ê²°ì œ ìš”ì²­ êµ¬í˜„
  }

  async confirmPayment(paymentKey: string, orderId: string, amount: number) {
    const response = await fetch(`${this.baseURL}/payments/confirm`, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${Buffer.from(this.secretKey + ':').toString('base64')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        paymentKey,
        orderId,
        amount
      })
    })

    if (!response.ok) {
      const error = await response.json()
      throw new Error(error.message)
    }

    return await response.json()
  }

  async cancelPayment(paymentKey: string, cancelReason: string) {
    // ê²°ì œ ì·¨ì†Œ êµ¬í˜„
  }
}
```

**2.2 ê²°ì œ ìš”ì²­ API**

```typescript
// src/app/api/payments/checkout/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { nanoid } from 'nanoid'

export async function POST(request: NextRequest) {
  const supabase = createClient()

  // 1. ì‚¬ìš©ì ì¸ì¦ í™•ì¸
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // 2. ìš”ì²­ ë°ì´í„° íŒŒì‹±
  const body = await request.json()
  const { politician_id, evaluators } = body // evaluators: ['claude'] or ['all']

  // 3. ì •ì¹˜ì¸ ì •ë³´ ì¡°íšŒ
  const { data: politician } = await supabase
    .from('politicians')
    .select('name')
    .eq('id', politician_id)
    .single()

  if (!politician) {
    return NextResponse.json({ error: 'Politician not found' }, { status: 404 })
  }

  // 4. ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
  const purchaseAll = evaluators.includes('all')
  const amount = purchaseAll ? 2500000 : evaluators.length * 500000

  // 5. ì£¼ë¬¸ ID ìƒì„±
  const orderId = `ORDER_${nanoid()}`

  // 6. payments í…Œì´ë¸”ì— ì„ì‹œ ì €ì¥
  await supabase.from('payments').insert({
    id: orderId,
    user_id: user.id,
    amount,
    status: 'pending',
    metadata: {
      politician_id,
      politician_name: politician.name,
      evaluators,
      purchased_all: purchaseAll
    }
  })

  // 7. ì‘ë‹µ
  return NextResponse.json({
    success: true,
    order_id: orderId,
    amount,
    order_name: `${politician.name} AI í‰ê°€ ë¦¬í¬íŠ¸`,
    customer_email: user.email,
    customer_name: user.user_metadata?.name || user.email
  })
}
```

**2.3 ê²°ì œ ìŠ¹ì¸ API**

```typescript
// src/app/api/payments/confirm/route.ts
import { TossPaymentClient } from '@/lib/payment/toss-client'

export async function POST(request: NextRequest) {
  const supabase = createClient()
  const { paymentKey, orderId, amount } = await request.json()

  try {
    // 1. í† ìŠ¤í˜ì´ë¨¼ì¸  ìŠ¹ì¸ API í˜¸ì¶œ
    const tossClient = new TossPaymentClient()
    const payment = await tossClient.confirmPayment(paymentKey, orderId, amount)

    // 2. payments í…Œì´ë¸” ì—…ë°ì´íŠ¸
    const { error } = await supabase
      .from('payments')
      .update({
        status: 'completed',
        payment_key: paymentKey,
        approved_at: new Date().toISOString(),
        toss_data: payment
      })
      .eq('id', orderId)

    if (error) throw error

    return NextResponse.json({
      success: true,
      message: 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error: any) {
    // 3. ì—ëŸ¬ ì²˜ë¦¬
    await supabase
      .from('payments')
      .update({
        status: 'failed',
        error_message: error.message
      })
      .eq('id', orderId)

    return NextResponse.json(
      { error: error.message },
      { status: 400 }
    )
  }
}
```

**2.4 ì›¹í›… ì²˜ë¦¬**

```typescript
// src/app/api/payments/webhook/route.ts
export async function POST(request: NextRequest) {
  const body = await request.json()
  const { eventType, data } = body

  // ì›¹í›… ì„œëª… ê²€ì¦ (ë³´ì•ˆ)
  const signature = request.headers.get('toss-signature')
  // ... ì„œëª… ê²€ì¦ ë¡œì§

  switch (eventType) {
    case 'PAYMENT_COMPLETED':
      // ê²°ì œ ì™„ë£Œ ì²˜ë¦¬
      break
    case 'PAYMENT_CANCELED':
      // ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬
      break
    default:
      break
  }

  return NextResponse.json({ success: true })
}
```

**2.5 ê²°ì œ ì´ë ¥ ì¡°íšŒ API**

```typescript
// src/app/api/payments/history/route.ts
export async function GET(request: NextRequest) {
  const supabase = createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { data: payments } = await supabase
    .from('payments')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })

  return NextResponse.json({ success: true, data: payments })
}
```

### 3. ê²€ì¦ ë‹¨ê³„

- íƒ€ì… ì²´í¬: `npm run type-check`
- ë¹Œë“œ: `npm run build`
- API í…ŒìŠ¤íŠ¸:
  - ê²°ì œ ìš”ì²­ í…ŒìŠ¤íŠ¸
  - ê²°ì œ ìŠ¹ì¸ í…ŒìŠ¤íŠ¸ (í† ìŠ¤í˜ì´ë¨¼ì¸  í…ŒìŠ¤íŠ¸ í‚¤ ì‚¬ìš©)
  - ì›¹í›… í…ŒìŠ¤íŠ¸
  - ê²°ì œ ì´ë ¥ ì¡°íšŒ
- ì‹¤ì œ ê²°ì œ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

### 4. ì™„ë£Œ ë‹¨ê³„

- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
- PROJECT GRID ì—…ë°ì´íŠ¸
- í™˜ê²½ ë³€ìˆ˜ ë¬¸ì„œí™”

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] í† ìŠ¤í˜ì´ë¨¼ì¸  SDK í†µí•© ì™„ë£Œ
- [ ] ê²°ì œ ìš”ì²­ API êµ¬í˜„
- [ ] ê²°ì œ ìŠ¹ì¸ API êµ¬í˜„
- [ ] ì›¹í›… ì²˜ë¦¬ êµ¬í˜„
- [ ] ê²°ì œ ì´ë ¥ ì¡°íšŒ API êµ¬í˜„
- [ ] ê¸ˆì•¡ ê³„ì‚° ì •í™•ì„± í™•ì¸
- [ ] íŠ¸ëœì­ì…˜ ì²˜ë¦¬ êµ¬í˜„
- [ ] TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- [ ] Next.js ë¹Œë“œ ì„±ê³µ
- [ ] ì‹¤ì œ ê²°ì œ í…ŒìŠ¤íŠ¸ ì„±ê³µ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
- [ ] ì›¹í›… ì„œëª… ê²€ì¦ êµ¬í˜„
- [ ] PROJECT GRID ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ

---

## ğŸ’° ê²°ì œ ê¸ˆì•¡ ì •ì±…

- **AI ëª¨ë¸ë³„ ê°œë³„ êµ¬ë§¤**: â‚©500,000 / 1ê°œ
- **5ê°œ AI ëª¨ë¸ ì „ì²´ êµ¬ë§¤**: â‚©2,500,000 (í• ì¸ ì—†ìŒ)

**êµ¬ë§¤ ì˜µì…˜**:
1. Claude í‰ê°€ë§Œ: â‚©500,000
2. ChatGPT í‰ê°€ë§Œ: â‚©500,000
3. Gemini í‰ê°€ë§Œ: â‚©500,000
4. Grok í‰ê°€ë§Œ: â‚©500,000
5. Perplexity í‰ê°€ë§Œ: â‚©500,000
6. ì „ì²´ (5ê°œ): â‚©2,500,000

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

- **ì›¹í›… ì„œëª… ê²€ì¦**: í† ìŠ¤í˜ì´ë¨¼ì¸ ì—ì„œ ë³´ë‚¸ ìš”ì²­ì¸ì§€ í™•ì¸
- **ê²°ì œ ê¸ˆì•¡ ê²€ì¦**: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ ê¸ˆì•¡ê³¼ ì„œë²„ì—ì„œ ê³„ì‚°í•œ ê¸ˆì•¡ ì¼ì¹˜ í™•ì¸
- **ì¤‘ë³µ ê²°ì œ ë°©ì§€**: ë™ì¼ orderId ì¬ì‚¬ìš© ê¸ˆì§€
- **í™˜ë¶ˆ ì •ì±…**: ë‹¤ìš´ë¡œë“œ ì „ì—ë§Œ í™˜ë¶ˆ ê°€ëŠ¥

---

**ì‘ì—…ì§€ì‹œì„œ ìƒì„±ì¼**: 2025-11-09
**PROJECT GRID Version**: v4.2
