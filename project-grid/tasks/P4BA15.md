# ì‘ì—…ì§€ì‹œì„œ: P4BA15

## ğŸ“‹ ê¸°ë³¸ ì •ë³´

- **ì‘ì—… ID**: P4BA15
- **ì—…ë¬´ëª…**: PDF ë¦¬í¬íŠ¸ ìƒì„± API (Puppeteer)
- **Phase**: Phase 4
- **Area**: Backend APIs (BA)
- **ì„œë¸Œ ì—ì´ì „íŠ¸**: backend-developer
- **ì‘ì—… ë°©ì‹**: AI-Only

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

Puppeteerë¥¼ ì‚¬ìš©í•˜ì—¬ 30,000ì AI í‰ê°€ ë¦¬í¬íŠ¸ë¥¼ PDFë¡œ ë³€í™˜í•˜ê³ , Supabase Storageì— ì—…ë¡œë“œ

---

## ğŸ”§ ì‚¬ìš© ë„êµ¬

```
[Claude ë„êµ¬]
Read, Edit, Write, Grep, Glob, Bash

[ê¸°ìˆ  ìŠ¤íƒ]
TypeScript, Next.js, Puppeteer, React, Tailwind CSS, Supabase Storage

[npm íŒ¨í‚¤ì§€]
- puppeteer
- @supabase/storage-js

[ì „ë¬¸ ìŠ¤í‚¬]
api-builder, api-test
```

## ğŸ”— ì˜ì¡´ì„± ì •ë³´

**ì˜ì¡´ì„± ì²´ì¸**: P3BA11, P4BA14

ì´ ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‹¤ìŒ ì‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
- P3BA11: AI í‰ê°€ ì¡°íšŒ API
- P4BA14: AI í‰ê°€ ìƒì„± ì—”ì§„ (ì‹¤ì œ í‰ê°€ ë°ì´í„°)

---

## ğŸ“¦ ê¸°ëŒ€ ê²°ê³¼ë¬¼

- `src/lib/pdf/report-generator.ts` (PDF ìƒì„± ì—”ì§„)
- `src/lib/pdf/templates/evaluation-report.tsx` (ë¦¬í¬íŠ¸ í…œí”Œë¦¿)
- `src/app/api/reports/generate/route.ts` (PDF ìƒì„± API)
- `src/lib/storage/upload.ts` (Supabase Storage ì—…ë¡œë“œ)

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. **PDF ë¦¬í¬íŠ¸ í…œí”Œë¦¿ ë””ìì¸**
   - í‘œì§€ (ì •ì¹˜ì¸ ì‚¬ì§„, ì´ë¦„, ë“±ê¸‰)
   - ì¢…í•© í‰ê°€ (5ê°œ AI ëª¨ë¸ ì ìˆ˜)
   - 10ê°œ ê¸°ì¤€ë³„ ìƒì„¸ í‰ê°€ (ì ìˆ˜ + 3,000ì ê·¼ê±°)
   - ì‹œê³„ì—´ ì°¨íŠ¸ (ì ìˆ˜ ë³€í™” ì¶”ì´)
   - ì´ 30,000ì ì´ìƒ

2. **Puppeteer PDF ìƒì„±**
   - HTML â†’ PDF ë³€í™˜
   - A4 ì‚¬ì´ì¦ˆ, ì„¸ë¡œ ë°©í–¥
   - í˜ì´ì§€ ë²ˆí˜¸, í—¤ë”/í‘¸í„°
   - í•œê¸€ í°íŠ¸ ì§€ì›

3. **Supabase Storage ì—…ë¡œë“œ**
   - `reports/{politician_id}/{evaluation_id}.pdf`
   - ê³µê°œ URL ìƒì„±
   - `ai_evaluations.report_url` ì—…ë°ì´íŠ¸

4. **ì„±ëŠ¥ ìµœì í™”**
   - ë¹„ë™ê¸° ì‘ì—… í
   - ìºì‹± (7ì¼)
   - ì¤‘ë³µ ìƒì„± ë°©ì§€

---

## ğŸ“ ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì¤€ë¹„ ë‹¨ê³„

- npm íŒ¨í‚¤ì§€ ì„¤ì¹˜:
  ```bash
  npm install puppeteer @supabase/storage-js
  ```
- Supabase Storage ë²„í‚· ìƒì„±: `reports` (public)

### 2. êµ¬í˜„ ë‹¨ê³„

**2.1 PDF ë¦¬í¬íŠ¸ í…œí”Œë¦¿**

```typescript
// src/lib/pdf/templates/evaluation-report.tsx
import React from 'react'

interface ReportProps {
  politician: Politician
  evaluation: Evaluation
  history: EvaluationHistory[]
}

export const EvaluationReportTemplate: React.FC<ReportProps> = ({
  politician,
  evaluation,
  history
}) => {
  return (
    <html>
      <head>
        <meta charSet="utf-8" />
        <title>AI í‰ê°€ ë¦¬í¬íŠ¸ - {politician.name}</title>
        <style>{`
          @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

          body {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 40px;
            line-height: 1.8;
          }

          .cover {
            text-align: center;
            page-break-after: always;
          }

          .section {
            page-break-inside: avoid;
            margin-bottom: 40px;
          }

          .criteria-detail {
            border-left: 4px solid #3b82f6;
            padding-left: 20px;
            margin-bottom: 30px;
          }
        `}</style>
      </head>
      <body>
        {/* í‘œì§€ */}
        <div className="cover">
          <h1>{politician.name} ì˜ì›</h1>
          <h2>AI ì¢…í•© í‰ê°€ ë¦¬í¬íŠ¸</h2>
          <p>ë“±ê¸‰: {evaluation.grade}</p>
          <p>ì¢…í•© ì ìˆ˜: {evaluation.overall_score}ì </p>
        </div>

        {/* ì¢…í•© í‰ê°€ */}
        <div className="section">
          <h2>ì¢…í•© í‰ê°€</h2>
          {/* 5ê°œ AI ëª¨ë¸ ì ìˆ˜ */}
        </div>

        {/* 10ê°œ ê¸°ì¤€ë³„ ìƒì„¸ í‰ê°€ */}
        <div className="section">
          <h2>ìƒì„¸ í‰ê°€</h2>
          {Object.entries(evaluation.criteria).map(([key, value]) => (
            <div key={key} className="criteria-detail">
              <h3>{key}</h3>
              <p>ì ìˆ˜: {value.score}</p>
              <p>{value.evidence}</p>
            </div>
          ))}
        </div>

        {/* ì‹œê³„ì—´ ì°¨íŠ¸ */}
        <div className="section">
          <h2>ì ìˆ˜ ë³€í™” ì¶”ì´</h2>
          {/* ì°¨íŠ¸ ì´ë¯¸ì§€ */}
        </div>
      </body>
    </html>
  )
}
```

**2.2 PDF ìƒì„± ì—”ì§„**

```typescript
// src/lib/pdf/report-generator.ts
import puppeteer from 'puppeteer'
import { renderToString } from 'react-dom/server'
import { EvaluationReportTemplate } from './templates/evaluation-report'

export class ReportGenerator {
  async generatePDF(
    politician: Politician,
    evaluation: Evaluation,
    history: EvaluationHistory[]
  ): Promise<Buffer> {
    // 1. React ì»´í¬ë„ŒíŠ¸ â†’ HTML
    const html = renderToString(
      <EvaluationReportTemplate
        politician={politician}
        evaluation={evaluation}
        history={history}
      />
    )

    // 2. Puppeteerë¡œ PDF ìƒì„±
    const browser = await puppeteer.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    })

    const page = await browser.newPage()
    await page.setContent(html, { waitUntil: 'networkidle0' })

    const pdf = await page.pdf({
      format: 'A4',
      printBackground: true,
      margin: {
        top: '20mm',
        right: '15mm',
        bottom: '20mm',
        left: '15mm'
      },
      displayHeaderFooter: true,
      headerTemplate: '<div></div>',
      footerTemplate: `
        <div style="font-size: 10px; text-align: center; width: 100%;">
          í˜ì´ì§€ <span class="pageNumber"></span> / <span class="totalPages"></span>
        </div>
      `
    })

    await browser.close()

    return Buffer.from(pdf)
  }
}
```

**2.3 Supabase Storage ì—…ë¡œë“œ**

```typescript
// src/lib/storage/upload.ts
import { createClient } from '@/lib/supabase/server'

export async function uploadReportPDF(
  politicianId: string,
  evaluationId: string,
  pdfBuffer: Buffer
): Promise<string> {
  const supabase = createClient()

  const fileName = `${politicianId}/${evaluationId}.pdf`
  const { data, error } = await supabase.storage
    .from('reports')
    .upload(fileName, pdfBuffer, {
      contentType: 'application/pdf',
      upsert: true
    })

  if (error) throw error

  // ê³µê°œ URL ìƒì„±
  const { data: { publicUrl } } = supabase.storage
    .from('reports')
    .getPublicUrl(fileName)

  // ai_evaluations.report_url ì—…ë°ì´íŠ¸
  await supabase
    .from('ai_evaluations')
    .update({ report_url: publicUrl })
    .eq('id', evaluationId)

  return publicUrl
}
```

**2.4 API ì—”ë“œí¬ì¸íŠ¸**

```typescript
// src/app/api/reports/generate/route.ts
import { ReportGenerator } from '@/lib/pdf/report-generator'
import { uploadReportPDF } from '@/lib/storage/upload'

export async function POST(request: NextRequest) {
  const { politician_id, evaluation_id } = await request.json()

  // 1. ë°ì´í„° ì¡°íšŒ
  const politician = await fetchPolitician(politician_id)
  const evaluation = await fetchEvaluation(evaluation_id)
  const history = await fetchHistory(politician_id)

  // 2. PDF ìƒì„±
  const generator = new ReportGenerator()
  const pdfBuffer = await generator.generatePDF(politician, evaluation, history)

  // 3. Supabase Storage ì—…ë¡œë“œ
  const reportUrl = await uploadReportPDF(politician_id, evaluation_id, pdfBuffer)

  return NextResponse.json({ success: true, report_url: reportUrl })
}
```

### 3. ê²€ì¦ ë‹¨ê³„

- íƒ€ì… ì²´í¬: `npm run type-check`
- ë¹Œë“œ: `npm run build`
- PDF ìƒì„± í…ŒìŠ¤íŠ¸: ì‹¤ì œ PDF íŒŒì¼ í™•ì¸
- í•œê¸€ í°íŠ¸ í™•ì¸
- 30,000ì ì´ìƒ í™•ì¸
- Supabase Storage ì—…ë¡œë“œ í™•ì¸

### 4. ì™„ë£Œ ë‹¨ê³„

- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
- PROJECT GRID ì—…ë°ì´íŠ¸
- ìƒ˜í”Œ PDF ìƒì„±

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] PDF ë¦¬í¬íŠ¸ í…œí”Œë¦¿ êµ¬í˜„ ì™„ë£Œ
- [ ] Puppeteer PDF ìƒì„± ì—”ì§„ êµ¬í˜„
- [ ] í•œê¸€ í°íŠ¸ ì •ìƒ ë Œë”ë§
- [ ] 30,000ì ì´ìƒ ë¦¬í¬íŠ¸ ìƒì„±
- [ ] Supabase Storage ì—…ë¡œë“œ ì„±ê³µ
- [ ] ê³µê°œ URL ìƒì„± í™•ì¸
- [ ] `ai_evaluations.report_url` ì—…ë°ì´íŠ¸
- [ ] TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- [ ] Next.js ë¹Œë“œ ì„±ê³µ
- [ ] ì‹¤ì œ PDF ìƒì„± í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] PROJECT GRID ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ

---

## ğŸ“Š ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

- **PDF ìƒì„± ì‹œê°„**: 10-30ì´ˆ (ë³µì¡ë„ì— ë”°ë¼)
- **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰**: 200-500MB (Puppeteer)
- **íŒŒì¼ í¬ê¸°**: 5-10MB (30,000ì + ì´ë¯¸ì§€)
- **ë™ì‹œ ì²˜ë¦¬**: ìµœëŒ€ 5ê°œ (ë©”ëª¨ë¦¬ ì œì•½)

**ê¶Œì¥ì‚¬í•­**:
- ë¹„ë™ê¸° ì‘ì—… í ì‚¬ìš© (BullMQ, Inngest)
- ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œëŠ” ë³„ë„ PDF ìƒì„± ì„œë¹„ìŠ¤ ê³ ë ¤
- ìºì‹±ìœ¼ë¡œ ì¤‘ë³µ ìƒì„± ë°©ì§€

---

**ì‘ì—…ì§€ì‹œì„œ ìƒì„±ì¼**: 2025-11-09
**PROJECT GRID Version**: v4.2
