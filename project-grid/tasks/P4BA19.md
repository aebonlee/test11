# ì‘ì—…ì§€ì‹œì„œ: P4BA19

## ğŸ“‹ ê¸°ë³¸ ì •ë³´

- **ì‘ì—… ID**: P4BA19
- **ì—…ë¬´ëª…**: í‰ê°€ ì´ë ¥ ê´€ë¦¬ API
- **Phase**: Phase 4
- **Area**: Backend APIs (BA)
- **ì„œë¸Œ ì—ì´ì „íŠ¸**: backend-developer
- **ì‘ì—… ë°©ì‹**: AI-Only

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

ì‹œê³„ì—´ AI í‰ê°€ ë°ì´í„°ë¥¼ ê´€ë¦¬í•˜ê³ , ì ìˆ˜ ë³€í™” ì¶”ì´ë¥¼ ì¡°íšŒ/ë¶„ì„í•˜ëŠ” API êµ¬í˜„

---

## ğŸ”§ ì‚¬ìš© ë„êµ¬

```
[Claude ë„êµ¬]
Read, Edit, Write, Grep, Glob, Bash

[ê¸°ìˆ  ìŠ¤íƒ]
TypeScript, Next.js, Supabase, Zod

[ì „ë¬¸ ìŠ¤í‚¬]
api-builder, api-test
```

## ğŸ”— ì˜ì¡´ì„± ì •ë³´

**ì˜ì¡´ì„± ì²´ì¸**: P3BA11, P4BA14

ì´ ì‘ì—…ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‹¤ìŒ ì‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼ í•©ë‹ˆë‹¤:
- P3BA11: AI í‰ê°€ ì¡°íšŒ API (í‰ê°€ ë°ì´í„°)
- P4BA14: AI í‰ê°€ ìƒì„± ì—”ì§„ (í‰ê°€ ìƒì„±)

---

## ğŸ“¦ ê¸°ëŒ€ ê²°ê³¼ë¬¼

- `src/app/api/evaluations/history/[politicianId]/route.ts` (í‰ê°€ ì´ë ¥ ì¡°íšŒ)
- `src/app/api/evaluations/trends/route.ts` (ì ìˆ˜ ë³€í™” ì¶”ì´)
- `src/app/api/evaluations/compare/route.ts` (ì •ì¹˜ì¸ ê°„ ë¹„êµ)
- `src/app/api/evaluations/archive/route.ts` (í‰ê°€ ì•„ì¹´ì´ë¸Œ)
- `0-4_Database/Supabase/migrations/017_create_evaluation_snapshots.sql` (ìŠ¤ëƒ…ìƒ· í…Œì´ë¸”)

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. **í‰ê°€ ì´ë ¥ ì¡°íšŒ API**
   - ì •ì¹˜ì¸ë³„ ì „ì²´ í‰ê°€ ì´ë ¥
   - ë‚ ì§œ ë²”ìœ„ í•„í„° (ìµœê·¼ 30ì¼, 90ì¼, 1ë…„)
   - AI ëª¨ë¸ë³„ í•„í„°

2. **ì ìˆ˜ ë³€í™” ì¶”ì´ ë¶„ì„**
   - ì‹œê³„ì—´ ì°¨íŠ¸ ë°ì´í„°
   - ì¦ê°ë¥  ê³„ì‚°
   - í‰ê· , ìµœê³ , ìµœì € ì ìˆ˜

3. **ì •ì¹˜ì¸ ê°„ ë¹„êµ API**
   - 2~5ëª… ì •ì¹˜ì¸ ë™ì‹œ ë¹„êµ
   - 10ê°œ ê¸°ì¤€ë³„ ë ˆì´ë” ì°¨íŠ¸ ë°ì´í„°
   - ìˆœìœ„ ê³„ì‚°

4. **í‰ê°€ ì•„ì¹´ì´ë¸Œ**
   - ìŠ¤ëƒ…ìƒ· ì €ì¥ (ì›” 1íšŒ)
   - íˆìŠ¤í† ë¦¬ ë°ì´í„° ë³´ì¡´
   - ë°ì´í„° ì••ì¶•

5. **í†µê³„ ë° ì¸ì‚¬ì´íŠ¸**
   - í‰ê°€ íšŸìˆ˜ ì§‘ê³„
   - AI ëª¨ë¸ë³„ í‰ê·  ì ìˆ˜
   - ê¸°ì¤€ë³„ í‰ê·  ì ìˆ˜

---

## ğŸ“ ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì¤€ë¹„ ë‹¨ê³„

- í”„ë¡œì íŠ¸ ë£¨íŠ¸: `Developement_Real_PoliticianFinder/1_Frontend`
- DB ìŠ¤í‚¤ë§ˆ í™•ì¸: `ai_evaluations` í…Œì´ë¸”
- ì˜ì¡´ì„± ì‘ì—… ì™„ë£Œ í™•ì¸: P3BA11, P4BA14

### 2. êµ¬í˜„ ë‹¨ê³„

**2.1 í‰ê°€ ìŠ¤ëƒ…ìƒ· í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜**

```sql
-- 0-4_Database/Supabase/migrations/017_create_evaluation_snapshots.sql
CREATE TABLE evaluation_snapshots (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  politician_id TEXT (8-char hex) NOT NULL REFERENCES politicians(id),
  snapshot_date DATE NOT NULL,

  -- ì¢…í•© ì ìˆ˜ (5ê°œ AI í‰ê· )
  overall_score_avg NUMERIC(5,2),
  overall_score_max INTEGER,
  overall_score_min INTEGER,

  -- AI ëª¨ë¸ë³„ ì ìˆ˜
  claude_score INTEGER,
  chatgpt_score INTEGER,
  gemini_score INTEGER,
  grok_score INTEGER,
  perplexity_score INTEGER,

  -- 10ê°œ ê¸°ì¤€ë³„ í‰ê·  ì ìˆ˜
  integrity_avg NUMERIC(5,2),
  expertise_avg NUMERIC(5,2),
  communication_avg NUMERIC(5,2),
  leadership_avg NUMERIC(5,2),
  transparency_avg NUMERIC(5,2),
  responsiveness_avg NUMERIC(5,2),
  innovation_avg NUMERIC(5,2),
  collaboration_avg NUMERIC(5,2),
  constituency_service_avg NUMERIC(5,2),
  policy_impact_avg NUMERIC(5,2),

  -- í‰ê°€ íšŸìˆ˜
  evaluation_count INTEGER DEFAULT 0,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_evaluation_snapshots_politician_id ON evaluation_snapshots(politician_id);
CREATE INDEX idx_evaluation_snapshots_snapshot_date ON evaluation_snapshots(snapshot_date);
CREATE UNIQUE INDEX idx_evaluation_snapshots_unique ON evaluation_snapshots(politician_id, snapshot_date);

-- RLS ì •ì±…
ALTER TABLE evaluation_snapshots ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Evaluation snapshots are publicly readable"
  ON evaluation_snapshots FOR SELECT
  USING (true);
```

**2.2 í‰ê°€ ì´ë ¥ ì¡°íšŒ API**

```typescript
// src/app/api/evaluations/history/[politicianId]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET(
  request: NextRequest,
  { params }: { params: { politicianId: string } }
) {
  const supabase = createClient()
  const { searchParams } = new URL(request.url)

  // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°
  const days = parseInt(searchParams.get('days') || '30') // ê¸°ë³¸ 30ì¼
  const evaluator = searchParams.get('evaluator') // 'claude', 'chatgpt', etc.

  // ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
  const startDate = new Date()
  startDate.setDate(startDate.getDate() - days)

  // ì¿¼ë¦¬ ë¹Œë”
  let query = supabase
    .from('ai_evaluations')
    .select('*')
    .eq('politician_id', params.politicianId)
    .gte('created_at', startDate.toISOString())
    .order('created_at', { ascending: false })

  if (evaluator) {
    query = query.eq('evaluator', evaluator)
  }

  const { data: evaluations, error } = await query

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 })
  }

  // í†µê³„ ê³„ì‚°
  const stats = calculateStats(evaluations)

  return NextResponse.json({
    success: true,
    data: evaluations,
    stats
  })
}

function calculateStats(evaluations: any[]) {
  if (evaluations.length === 0) {
    return null
  }

  const scores = evaluations.map(e => e.overall_score)

  return {
    count: evaluations.length,
    avg: scores.reduce((a, b) => a + b, 0) / scores.length,
    max: Math.max(...scores),
    min: Math.min(...scores),
    latest: scores[0],
    change: scores.length > 1 ? scores[0] - scores[scores.length - 1] : 0
  }
}
```

**2.3 ì ìˆ˜ ë³€í™” ì¶”ì´ API**

```typescript
// src/app/api/evaluations/trends/route.ts
export async function GET(request: NextRequest) {
  const supabase = createClient()
  const { searchParams } = new URL(request.url)

  const politicianId = searchParams.get('politician_id')
  const days = parseInt(searchParams.get('days') || '90')

  if (!politicianId) {
    return NextResponse.json({ error: 'politician_id required' }, { status: 400 })
  }

  // ìŠ¤ëƒ…ìƒ· ë°ì´í„° ì¡°íšŒ
  const startDate = new Date()
  startDate.setDate(startDate.getDate() - days)

  const { data: snapshots } = await supabase
    .from('evaluation_snapshots')
    .select('*')
    .eq('politician_id', politicianId)
    .gte('snapshot_date', startDate.toISOString().split('T')[0])
    .order('snapshot_date', { ascending: true })

  // ì°¨íŠ¸ ë°ì´í„° í¬ë§·
  const chartData = snapshots?.map(s => ({
    date: s.snapshot_date,
    overall: s.overall_score_avg,
    claude: s.claude_score,
    chatgpt: s.chatgpt_score,
    gemini: s.gemini_score,
    grok: s.grok_score,
    perplexity: s.perplexity_score
  }))

  return NextResponse.json({
    success: true,
    data: chartData
  })
}
```

**2.4 ì •ì¹˜ì¸ ê°„ ë¹„êµ API**

```typescript
// src/app/api/evaluations/compare/route.ts
export async function POST(request: NextRequest) {
  const supabase = createClient()
  const body = await request.json()
  const { politician_ids } = body // ['uuid1', 'uuid2', ...]

  if (!politician_ids || politician_ids.length < 2 || politician_ids.length > 5) {
    return NextResponse.json(
      { error: 'politician_id TEXT (8-char hex)s' },
      { status: 400 }
    )
  }

  // ê° ì •ì¹˜ì¸ì˜ ìµœì‹  í‰ê°€ ì¡°íšŒ
  const comparisons = await Promise.all(
    politician_ids.map(async (id: string) => {
      const { data: politician } = await supabase
        .from('politicians')
        .select('id, name, party, position')
        .eq('id', id)
        .single()

      const { data: evaluations } = await supabase
        .from('ai_evaluations')
        .select('*')
        .eq('politician_id', id)
        .order('created_at', { ascending: false })
        .limit(5)

      // 5ê°œ AI í‰ê·  ê³„ì‚°
      const avgScores = {
        overall: calculateAverage(evaluations, 'overall_score'),
        integrity: calculateAverage(evaluations, 'integrity_score'),
        expertise: calculateAverage(evaluations, 'expertise_score'),
        communication: calculateAverage(evaluations, 'communication_score'),
        leadership: calculateAverage(evaluations, 'leadership_score'),
        transparency: calculateAverage(evaluations, 'transparency_score'),
        responsiveness: calculateAverage(evaluations, 'responsiveness_score'),
        innovation: calculateAverage(evaluations, 'innovation_score'),
        collaboration: calculateAverage(evaluations, 'collaboration_score'),
        constituency_service: calculateAverage(evaluations, 'constituency_service_score'),
        policy_impact: calculateAverage(evaluations, 'policy_impact_score')
      }

      return {
        politician,
        scores: avgScores
      }
    })
  )

  return NextResponse.json({
    success: true,
    data: comparisons
  })
}

function calculateAverage(evaluations: any[], field: string): number {
  if (!evaluations || evaluations.length === 0) return 0
  const sum = evaluations.reduce((acc, e) => acc + (e[field] || 0), 0)
  return Math.round(sum / evaluations.length)
}
```

**2.5 í‰ê°€ ì•„ì¹´ì´ë¸Œ (ìŠ¤ëƒ…ìƒ· ìƒì„±)**

```typescript
// src/app/api/evaluations/archive/route.ts
// í¬ë¡ ì¡ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ìš©
export async function POST(request: NextRequest) {
  const supabase = createClient()

  // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // ëª¨ë“  ì •ì¹˜ì¸ ì¡°íšŒ
  const { data: politicians } = await supabase
    .from('politicians')
    .select('id')

  if (!politicians) {
    return NextResponse.json({ error: 'No politicians found' }, { status: 404 })
  }

  const today = new Date().toISOString().split('T')[0]
  let successCount = 0

  // ê° ì •ì¹˜ì¸ì˜ ìŠ¤ëƒ…ìƒ· ìƒì„±
  for (const politician of politicians) {
    // ìµœê·¼ í‰ê°€ ë°ì´í„° ì¡°íšŒ (30ì¼)
    const { data: evaluations } = await supabase
      .from('ai_evaluations')
      .select('*')
      .eq('politician_id', politician.id)
      .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString())

    if (!evaluations || evaluations.length === 0) continue

    // í†µê³„ ê³„ì‚°
    const snapshot = {
      politician_id: politician.id,
      snapshot_date: today,
      overall_score_avg: calculateAverage(evaluations, 'overall_score'),
      overall_score_max: Math.max(...evaluations.map(e => e.overall_score)),
      overall_score_min: Math.min(...evaluations.map(e => e.overall_score)),
      claude_score: evaluations.find(e => e.evaluator === 'claude')?.overall_score || null,
      chatgpt_score: evaluations.find(e => e.evaluator === 'chatgpt')?.overall_score || null,
      gemini_score: evaluations.find(e => e.evaluator === 'gemini')?.overall_score || null,
      grok_score: evaluations.find(e => e.evaluator === 'grok')?.overall_score || null,
      perplexity_score: evaluations.find(e => e.evaluator === 'perplexity')?.overall_score || null,
      integrity_avg: calculateAverage(evaluations, 'integrity_score'),
      expertise_avg: calculateAverage(evaluations, 'expertise_score'),
      communication_avg: calculateAverage(evaluations, 'communication_score'),
      leadership_avg: calculateAverage(evaluations, 'leadership_score'),
      transparency_avg: calculateAverage(evaluations, 'transparency_score'),
      responsiveness_avg: calculateAverage(evaluations, 'responsiveness_score'),
      innovation_avg: calculateAverage(evaluations, 'innovation_score'),
      collaboration_avg: calculateAverage(evaluations, 'collaboration_score'),
      constituency_service_avg: calculateAverage(evaluations, 'constituency_service_score'),
      policy_impact_avg: calculateAverage(evaluations, 'policy_impact_score'),
      evaluation_count: evaluations.length
    }

    // Upsert (ì¤‘ë³µ ë°©ì§€)
    const { error } = await supabase
      .from('evaluation_snapshots')
      .upsert(snapshot, {
        onConflict: 'politician_id,snapshot_date'
      })

    if (!error) successCount++
  }

  return NextResponse.json({
    success: true,
    message: `${successCount}/${politicians.length} snapshots created`
  })
}
```

### 3. ê²€ì¦ ë‹¨ê³„

- íƒ€ì… ì²´í¬: `npm run type-check`
- ë¹Œë“œ: `npm run build`
- API í…ŒìŠ¤íŠ¸:
  - í‰ê°€ ì´ë ¥ ì¡°íšŒ
  - ì ìˆ˜ ë³€í™” ì¶”ì´ ì¡°íšŒ
  - ì •ì¹˜ì¸ ê°„ ë¹„êµ
  - ìŠ¤ëƒ…ìƒ· ìƒì„±
- ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

### 4. ì™„ë£Œ ë‹¨ê³„

- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
- PROJECT GRID ì—…ë°ì´íŠ¸
- í¬ë¡ ì¡ ì„¤ì • (ì›” 1íšŒ ìŠ¤ëƒ…ìƒ· ìƒì„±)

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] í‰ê°€ ì´ë ¥ ì¡°íšŒ API êµ¬í˜„
- [ ] ì ìˆ˜ ë³€í™” ì¶”ì´ API êµ¬í˜„
- [ ] ì •ì¹˜ì¸ ê°„ ë¹„êµ API êµ¬í˜„
- [ ] í‰ê°€ ì•„ì¹´ì´ë¸Œ API êµ¬í˜„
- [ ] `evaluation_snapshots` í…Œì´ë¸” ìƒì„±
- [ ] í†µê³„ ê³„ì‚° ë¡œì§ êµ¬í˜„
- [ ] ì°¨íŠ¸ ë°ì´í„° í¬ë§· êµ¬í˜„
- [ ] TypeScript íƒ€ì… ì²´í¬ í†µê³¼
- [ ] Next.js ë¹Œë“œ ì„±ê³µ
- [ ] ì‹¤ì œ API í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] RLS ì •ì±… ì ìš© í™•ì¸
- [ ] PROJECT GRID ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ

---

## ğŸ“Š ì°¨íŠ¸ ë°ì´í„° í¬ë§· ì˜ˆì‹œ

**ì‹œê³„ì—´ ì°¨íŠ¸ ë°ì´í„°**:
```json
{
  "success": true,
  "data": [
    { "date": "2025-10-01", "overall": 85, "claude": 87, "chatgpt": 83, ... },
    { "date": "2025-10-02", "overall": 86, "claude": 88, "chatgpt": 84, ... },
    { "date": "2025-10-03", "overall": 84, "claude": 86, "chatgpt": 82, ... }
  ]
}
```

**ë ˆì´ë” ì°¨íŠ¸ ë°ì´í„° (ë¹„êµ)**:
```json
{
  "success": true,
  "data": [
    {
      "politician": { "id": "uuid1", "name": "í™ê¸¸ë™" },
      "scores": {
        "integrity": 90,
        "expertise": 85,
        "communication": 88,
        ...
      }
    },
    {
      "politician": { "id": "uuid2", "name": "ê¹€ì² ìˆ˜" },
      "scores": {
        "integrity": 87,
        "expertise": 92,
        "communication": 85,
        ...
      }
    }
  ]
}
```

---

**ì‘ì—…ì§€ì‹œì„œ ìƒì„±ì¼**: 2025-11-09
**PROJECT GRID Version**: v4.2
