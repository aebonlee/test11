# ì‘ì—…ì§€ì‹œì„œ: P2D1

## ğŸ“‹ ê¸°ë³¸ ì •ë³´

- **ì‘ì—… ID**: P2D1
- **ì—…ë¬´ëª…**: ì „ì²´ Database ìŠ¤í‚¤ë§ˆ (í†µí•©)
- **Phase**: Phase 2
- **Area**: Database (D)
- **ì„œë¸Œ ì—ì´ì „íŠ¸**: database-developer
- **ì‘ì—… ë°©ì‹**: AI-Only

---

## ğŸ¯ ì‘ì—… ëª©í‘œ

ëª¨ë“  í…Œì´ë¸” + íŠ¸ë¦¬ê±° + íƒ€ì… + Storage + ìµœì í™”

---

## ğŸ”§ ì‚¬ìš© ë„êµ¬

```
[Claude ë„êµ¬]
Read, Edit, Write, Grep, Glob, Bash

[ê¸°ìˆ  ìŠ¤íƒ]
PostgreSQL, Supabase

[ì „ë¬¸ ìŠ¤í‚¬]
database-schema, database-migration
```

**ë„êµ¬ ì„¤ëª…**:
- **Claude ë„êµ¬**: Claude Codeì˜ ê¸°ë³¸ ê¸°ëŠ¥ (Read, Write, Edit, Bash, Glob, Grep ë“±)
- **ê¸°ìˆ  ìŠ¤íƒ**: í”„ë¡œì íŠ¸ì— ì‚¬ìš©ë˜ëŠ” í”„ë ˆì„ì›Œí¬ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬
- **ì „ë¬¸ ìŠ¤í‚¬**: Anthropic ë¹ŒíŠ¸ì¸ ìŠ¤í‚¬ (.claude/skills/*.md ì°¸ì¡°)

## ğŸ”— ì˜ì¡´ì„± ì •ë³´

**ì˜ì¡´ì„± ì²´ì¸**: ì—†ìŒ

ì´ ì‘ì—…ì€ ë…ë¦½ì ìœ¼ë¡œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“¦ ê¸°ëŒ€ ê²°ê³¼ë¬¼

- supabase/migrations/001_create_users_table.sql
- supabase/migrations/002_create_politicians_table.sql
- supabase/migrations/003_create_posts_table.sql
- supabase/migrations/004_create_comments_table.sql
- supabase/migrations/005_create_notifications_table.sql
- supabase/migrations/006_create_triggers.sql
- supabase/migrations/007_create_storage_buckets.sql
- ... (ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ)

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. users í…Œì´ë¸” (ì‚¬ìš©ì ì •ë³´)
2. politicians í…Œì´ë¸” (ì •ì¹˜ì¸ ì •ë³´)
3. careers í…Œì´ë¸” (ê²½ë ¥)
4. pledges í…Œì´ë¸” (ê³µì•½)
5. posts í…Œì´ë¸” (ê²Œì‹œê¸€)
6. comments í…Œì´ë¸” (ëŒ“ê¸€)
7. votes, votes í…Œì´ë¸”
8. follows í…Œì´ë¸” (íŒ”ë¡œìš° ê´€ê³„)
9. notifications í…Œì´ë¸” (ì•Œë¦¼)
10. user_favorites í…Œì´ë¸” (ê´€ì‹¬ ì •ì¹˜ì¸)
11. ai_evaluations í…Œì´ë¸” (AI í‰ê°€)
12. reports í…Œì´ë¸” (ì‹ ê³ )
13. shares í…Œì´ë¸” (ê³µìœ )
14. politician_verification í…Œì´ë¸” (ë³¸ì¸ ì¸ì¦)
15. **audit_logs í…Œì´ë¸” (ê°ì‚¬ ë¡œê·¸)** - P4BA8ì—ì„œ í•„ìš”
16. **advertisements í…Œì´ë¸” (ê´‘ê³ )** - P4BA9ì—ì„œ í•„ìš”
17. **policies í…Œì´ë¸” (ì •ì±…)** - P4BA10ì—ì„œ í•„ìš”
18. **notification_templates í…Œì´ë¸” (ì•Œë¦¼ í…œí”Œë¦¿)** - P4BA11ì—ì„œ í•„ìš”
19. **system_settings í…Œì´ë¸” (ì‹œìŠ¤í…œ ì„¤ì •)** - P4BA12ì—ì„œ í•„ìš”
20. **admin_actions í…Œì´ë¸” (ê´€ë¦¬ì ì•¡ì…˜ ë¡œê·¸)** - P4BA13ì—ì„œ í•„ìš”
21. Storage Buckets (avatars, attachments, politician-images)
22. ì¸ë±ìŠ¤ ìµœì í™”
23. íŠ¸ë¦¬ê±° ì„¤ì • (ìë™ íƒ€ì„ìŠ¤íƒ¬í”„, ì•Œë¦¼ ìƒì„±)
24. RLS (Row Level Security) ì •ì±…
25. Database Functions (ì§‘ê³„, ìˆœìœ„ ê³„ì‚°)

ê° í•­ëª©ì„ ì²´ê³„ì ìœ¼ë¡œ êµ¬í˜„í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.

---

## ğŸ’¾ êµ¬í˜„ íŒŒì¼ ì €ì¥ ìœ„ì¹˜

**ë£¨íŠ¸ í´ë”**: `4_Database/supabase/migrations/`

**íŒŒì¼ ê²½ë¡œ**:
```
4_Database/
â””â”€â”€ supabase/
    â””â”€â”€ migrations/
        â”œâ”€â”€ 001_create_users_table.sql
        â”œâ”€â”€ 002_create_politicians_table.sql
        â”œâ”€â”€ 003_create_posts_table.sql
        â”œâ”€â”€ 004_create_comments_table.sql
        â”œâ”€â”€ 005_create_notifications_table.sql
        â”œâ”€â”€ 006_create_reports_table.sql
        â”œâ”€â”€ 007_create_audit_logs_table.sql
        â”œâ”€â”€ 008_create_advertisements_table.sql
        â”œâ”€â”€ 009_create_policies_table.sql
        â”œâ”€â”€ 010_create_notification_templates_table.sql
        â”œâ”€â”€ 011_create_system_settings_table.sql
        â”œâ”€â”€ 012_create_admin_actions_table.sql
        â”œâ”€â”€ 020_create_triggers.sql
        â”œâ”€â”€ 021_create_functions.sql
        â”œâ”€â”€ 030_create_storage_buckets.sql
        â””â”€â”€ 040_create_rls_policies.sql
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**:
```bash
cd 4_Database
npx supabase db push
```

---

## ğŸ“ ì‘ì—… ì§€ì‹œì‚¬í•­

### 1. ì¤€ë¹„ ë‹¨ê³„

#### 1.1 Supabase í”„ë¡œì íŠ¸ í™•ì¸
- Project ID: `ooddlafwdpzgxfefgsrx`
- Supabase Dashboard ì ‘ì†: https://supabase.com/dashboard/project/ooddlafwdpzgxfefgsrx

#### 1.2 ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ êµ¬ì¡° ìƒì„±
```bash
cd 4_Database
mkdir -p supabase/migrations
```

#### 1.3 ì˜ì¡´ì„± í™•ì¸
- ì˜ì¡´ì„± ì—†ìŒ, ë°”ë¡œ ì‹œì‘ ê°€ëŠ¥

---

### 2. êµ¬í˜„ ë‹¨ê³„

#### 2.1 í•µì‹¬ í…Œì´ë¸” SQL ì˜ˆì‹œ

**001_create_users_table.sql**
```sql
-- ì‚¬ìš©ì í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  avatar_url TEXT,
  role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin', 'moderator')),
  points INTEGER DEFAULT 0,
  level INTEGER DEFAULT 1,
  bio TEXT,
  location TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_created_at ON users(created_at DESC);

-- RLS í™œì„±í™”
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- RLS ì •ì±…: ì‚¬ìš©ìëŠ” ìì‹ ì˜ ì •ë³´ë§Œ ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can view own profile"
  ON users FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON users FOR UPDATE
  USING (auth.uid() = id);

-- ê´€ë¦¬ìëŠ” ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Admins can view all users"
  ON users FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

**002_create_politicians_table.sql**
```sql
-- ì •ì¹˜ì¸ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS politicians (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  name_en TEXT,
  party TEXT NOT NULL,
  position TEXT NOT NULL,
  region TEXT,
  district TEXT,
  profile_image_url TEXT,
  birth_date DATE,
  education TEXT[],
  website_url TEXT,
  facebook_url TEXT,
  twitter_url TEXT,
  instagram_url TEXT,
  youtube_url TEXT,
  phone TEXT,
  email TEXT,
  office_address TEXT,
  is_verified BOOLEAN DEFAULT FALSE,
  verification_token TEXT,
  verified_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0,
  favorite_count INTEGER DEFAULT 0,
  evaluation_score INTEGER DEFAULT 0,
  evaluation_grade TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_politicians_name ON politicians(name);
CREATE INDEX idx_politicians_party ON politicians(party);
CREATE INDEX idx_politicians_position ON politicians(position);
CREATE INDEX idx_politicians_region ON politicians(region);
CREATE INDEX idx_politicians_evaluation_score ON politicians(evaluation_score DESC);
CREATE INDEX idx_politicians_view_count ON politicians(view_count DESC);

-- ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì¸ë±ìŠ¤
CREATE INDEX idx_politicians_search ON politicians USING gin(to_tsvector('korean', name || ' ' || COALESCE(party, '') || ' ' || COALESCE(region, '')));

-- RLS í™œì„±í™”
ALTER TABLE politicians ENABLE ROW LEVEL SECURITY;

-- RLS ì •ì±…: ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Anyone can view politicians"
  ON politicians FOR SELECT
  USING (true);

-- ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Admins can update politicians"
  ON politicians FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

**003_create_posts_table.sql**
```sql
-- ê²Œì‹œê¸€ í…Œì´ë¸”
CREATE TABLE IF NOT EXISTS posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  politician_id TEXT (8-char hex) REFERENCES politicians(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT CHECK (category IN ('general', 'question', 'debate', 'news')),
  tags TEXT[],
  is_pinned BOOLEAN DEFAULT FALSE,
  is_locked BOOLEAN DEFAULT FALSE,
  view_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  comment_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  moderation_status TEXT DEFAULT 'pending' CHECK (moderation_status IN ('pending', 'approved', 'rejected', 'flagged')),
  moderation_reason TEXT,
  moderated_at TIMESTAMPTZ,
  moderated_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_politician_id ON posts(politician_id);
CREATE INDEX idx_posts_category ON posts(category);
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
CREATE INDEX idx_posts_moderation_status ON posts(moderation_status);
CREATE INDEX idx_posts_view_count ON posts(view_count DESC);

-- ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰
CREATE INDEX idx_posts_search ON posts USING gin(to_tsvector('korean', title || ' ' || content));

-- RLS
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view approved posts"
  ON posts FOR SELECT
  USING (moderation_status = 'approved');

CREATE POLICY "Users can view own posts"
  ON posts FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create posts"
  ON posts FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own posts"
  ON posts FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own posts"
  ON posts FOR DELETE
  USING (auth.uid() = user_id);
```

**020_create_triggers.sql**
```sql
-- ìë™ updated_at ì—…ë°ì´íŠ¸ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- users í…Œì´ë¸” íŠ¸ë¦¬ê±°
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- politicians í…Œì´ë¸” íŠ¸ë¦¬ê±°
CREATE TRIGGER update_politicians_updated_at
  BEFORE UPDATE ON politicians
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- posts í…Œì´ë¸” íŠ¸ë¦¬ê±°
CREATE TRIGGER update_posts_updated_at
  BEFORE UPDATE ON posts
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- ê³µê° ìˆ˜ ìë™ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_post_like_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE posts SET like_count = like_count + 1 WHERE id = NEW.post_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE posts SET like_count = like_count - 1 WHERE id = OLD.post_id;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER post_like_count_trigger
  AFTER INSERT OR DELETE ON votes
  FOR EACH ROW
  EXECUTE FUNCTION update_post_like_count();
```

**030_create_storage_buckets.sql**
```sql
-- Storage Buckets ìƒì„± (Supabase Dashboard ë˜ëŠ” SQLë¡œ)
-- ì‹¤ì œë¡œëŠ” Supabase Dashboardì—ì„œ ìƒì„±í•˜ëŠ” ê²ƒì´ ë” í¸ë¦¬í•¨

-- ì˜ˆì‹œ (SQLë¡œ ìƒì„±í•˜ëŠ” ê²½ìš°)
INSERT INTO storage.buckets (id, name, public)
VALUES
  ('avatars', 'avatars', true),
  ('attachments', 'attachments', false),
  ('politician-images', 'politician-images', true)
ON CONFLICT (id) DO NOTHING;

-- Storage RLS ì •ì±…
CREATE POLICY "Avatar images are publicly accessible"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'avatars');

CREATE POLICY "Users can upload own avatar"
  ON storage.objects FOR INSERT
  WITH CHECK (
    bucket_id = 'avatars' AND
    auth.uid()::text = (storage.foldername(name))[1]
  );

CREATE POLICY "Politician images are publicly accessible"
  ON storage.objects FOR SELECT
  USING (bucket_id = 'politician-images');
```

---

### 2.2 êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©

**êµ¬í˜„í•´ì•¼ í•  ì„¸ë¶€ í•­ëª©**:

1. users í…Œì´ë¸” (ì‚¬ìš©ì ì •ë³´)
2. politicians í…Œì´ë¸” (ì •ì¹˜ì¸ ì •ë³´)
3. careers í…Œì´ë¸” (ê²½ë ¥)
4. pledges í…Œì´ë¸” (ê³µì•½)
5. posts í…Œì´ë¸” (ê²Œì‹œê¸€)
6. comments í…Œì´ë¸” (ëŒ“ê¸€)
7. votes, votes í…Œì´ë¸”
8. follows í…Œì´ë¸” (íŒ”ë¡œìš° ê´€ê³„)
9. notifications í…Œì´ë¸” (ì•Œë¦¼)
10. user_favorites í…Œì´ë¸” (ê´€ì‹¬ ì •ì¹˜ì¸)
11. ai_evaluations í…Œì´ë¸” (AI í‰ê°€)
12. reports í…Œì´ë¸” (ì‹ ê³ )
13. shares í…Œì´ë¸” (ê³µìœ )
14. politician_verification í…Œì´ë¸” (ë³¸ì¸ ì¸ì¦)
15. **audit_logs í…Œì´ë¸” (ê°ì‚¬ ë¡œê·¸)** - P4BA8ì—ì„œ í•„ìš”
16. **advertisements í…Œì´ë¸” (ê´‘ê³ )** - P4BA9ì—ì„œ í•„ìš”
17. **policies í…Œì´ë¸” (ì •ì±…)** - P4BA10ì—ì„œ í•„ìš”
18. **notification_templates í…Œì´ë¸” (ì•Œë¦¼ í…œí”Œë¦¿)** - P4BA11ì—ì„œ í•„ìš”
19. **system_settings í…Œì´ë¸” (ì‹œìŠ¤í…œ ì„¤ì •)** - P4BA12ì—ì„œ í•„ìš”
20. **admin_actions í…Œì´ë¸” (ê´€ë¦¬ì ì•¡ì…˜ ë¡œê·¸)** - P4BA13ì—ì„œ í•„ìš”
21. Storage Buckets (avatars, attachments, politician-images)
22. ì¸ë±ìŠ¤ ìµœì í™”
23. íŠ¸ë¦¬ê±° ì„¤ì • (ìë™ íƒ€ì„ìŠ¤íƒ¬í”„, ì•Œë¦¼ ìƒì„±)
24. RLS (Row Level Security) ì •ì±…
25. Database Functions (ì§‘ê³„, ìˆœìœ„ ê³„ì‚°)

ê° í•­ëª©ì„ ì²´ê³„ì ìœ¼ë¡œ êµ¬í˜„í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.

**ê´€ë¦¬ì ê¸°ëŠ¥ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ ì°¸ê³ **:
- P4BA8.md: audit_logs í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
- P4BA9.md: advertisements í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
- P4BA10.md: policies í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
- P4BA11.md: notification_templates í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
- P4BA12.md: system_settings í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ
- P4BA13.md: admin_actions í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

### 3. ê²€ì¦ ë‹¨ê³„

- ì‘ì„±í•œ ì½”ë“œì˜ ì •ìƒ ë™ì‘ í™•ì¸
- íƒ€ì… ì²´í¬ ë° ë¦°íŠ¸ í†µê³¼
- í•„ìš”í•œ ê²½ìš° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±
- ì½”ë“œ ë¦¬ë·° ì¤€ë¹„

### 4. ì™„ë£Œ ë‹¨ê³„

- ìƒì„±ëœ íŒŒì¼ ëª©ë¡ í™•ì¸
- PROJECT GRID ìƒíƒœ ì—…ë°ì´íŠ¸
- ë‹¤ìŒ ì˜ì¡´ ì‘ì—…ì— ì˜í–¥ í™•ì¸

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] ëª¨ë“  í…Œì´ë¸”ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë¨
- [ ] ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë¨
- [ ] ì¸ë±ìŠ¤ê°€ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë¨
- [ ] íŠ¸ë¦¬ê±°ê°€ ì •ìƒ ì‘ë™í•¨
- [ ] RLS ì •ì±…ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë¨
- [ ] Storage Buckets ìƒì„± í™•ì¸
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì„±ê³µ
- [ ] DATABASE TYPES ìƒì„± í™•ì¸

---

**ì‘ì—…ì§€ì‹œì„œ ìƒì„±ì¼**: 2025-11-06
**PROJECT GRID Version**: v4.0
