# 작업지시서: P4BA20

## 기본 정보

- **작업 ID**: P4BA20
- **업무명**: 정치인 통합 이메일 인증 시스템
- **Phase**: Phase 4
- **Area**: Backend APIs (BA)
- **서브 에이전트**: backend-developer, frontend-developer
- **작업 방식**: AI-Only

---

## 작업 목표

정치인 글쓰기/댓글/보고서 구매를 위한 **통합 이메일 인증 시스템** 구현

**핵심 원칙:**
1. **등록된 정치인만** - 관리자가 DB에 등록한 정치인만 가능
2. **이름 선택 방식** - 드롭다운에서 선택 (직접 입력 X)
3. **이메일 인증** - 어떤 이메일이든 OK, 인증만 되면 됨
4. **이메일 변경 가능** - 새 이메일로 인증하면 업데이트
5. **통합 사용** - 글쓰기/댓글/보고서 구매 모두 동일 인증

---

## 사용 도구

```
[Claude 도구]
Read, Edit, Write, Grep, Glob, Bash

[기술 스택]
TypeScript, Next.js, Supabase, Zod, Resend

[npm 패키지]
- resend (이메일 발송, 이미 설치됨)

[전문 스킬]
api-builder, api-test
```

## 의존성 정보

**의존성 체인**: P3BA1, P3BA2

이 작업을 시작하기 전에 다음 작업이 완료되어야 합니다:
- P3BA1: 인증 API (사용자 인증)
- P3BA2: 정치인 API (정치인 데이터)

---

## 기대 결과물

### Backend API
- `src/app/api/politicians/auth/send-code/route.ts` (인증 코드 발송)
- `src/app/api/politicians/auth/verify-code/route.ts` (코드 확인 + 세션 발급)
- `src/app/api/politicians/auth/session/route.ts` (세션 상태 확인)

### Frontend Components
- `src/components/PoliticianAuthModal.tsx` (통합 인증 모달)

### Database Migration
- `0-4_Database/Supabase/migrations/062_politician_unified_auth.sql`

---

## 상세 프로세스

### 사용자 플로우

```
┌─────────────────────────────────────────────────────────────┐
│  STEP 1: 정치인 선택                                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  정치인을 선택하세요                    [드롭다운 ▼] │    │
│  │                                                     │    │
│  │  - 오세훈 (서울특별시장, 국민의힘)                  │    │
│  │  - 김동연 (경기도지사, 더불어민주당)                │    │
│  │  - ...                                              │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  STEP 2: 이메일 입력                                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  인증받을 이메일 주소를 입력하세요                  │    │
│  │                                                     │    │
│  │  [________________________] 이메일 입력             │    │
│  │                                                     │    │
│  │  * 본인이 확인 가능한 이메일을 입력하세요           │    │
│  │  * 이 이메일로 6자리 인증 코드가 발송됩니다         │    │
│  │                                                     │    │
│  │  [인증 코드 발송]                                   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  STEP 3: 코드 입력                                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  인증 코드를 입력하세요                             │    │
│  │                                                     │    │
│  │  example@email.com 으로 발송되었습니다              │    │
│  │                                                     │    │
│  │  [_ _ _ _ _ _]  6자리 코드                          │    │
│  │                                                     │    │
│  │  유효 시간: 09:45                                   │    │
│  │                                                     │    │
│  │  [인증 확인]  [코드 재발송]                         │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  STEP 4: 인증 완료                                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ✅ 오세훈님 본인 인증이 완료되었습니다!            │    │
│  │                                                     │    │
│  │  이제 글쓰기, 댓글, 보고서 구매가 가능합니다.       │    │
│  │                                                     │    │
│  │  [확인]                                             │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## 작업 지시사항

### 1. 데이터베이스 마이그레이션

```sql
-- 0-4_Database/Supabase/migrations/062_politician_unified_auth.sql

-- ============================================
-- 1. politicians 테이블에 verified_email 컬럼 추가 (없으면)
-- ============================================
ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS verified_email TEXT;

ALTER TABLE politicians
  ADD COLUMN IF NOT EXISTS email_verified_at TIMESTAMPTZ;

-- 인덱스
CREATE INDEX IF NOT EXISTS idx_politicians_verified_email
  ON politicians(verified_email);

-- ============================================
-- 2. politician_email_verifications 테이블 (인증 코드 관리)
-- ============================================
CREATE TABLE IF NOT EXISTS politician_email_verifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
    email TEXT NOT NULL,
    verification_code VARCHAR(6) NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,  -- NOW() + 10분
    verified BOOLEAN DEFAULT FALSE,
    verified_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX IF NOT EXISTS idx_politician_email_verifications_politician
  ON politician_email_verifications(politician_id);
CREATE INDEX IF NOT EXISTS idx_politician_email_verifications_code
  ON politician_email_verifications(verification_code, expires_at);

-- RLS
ALTER TABLE politician_email_verifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "politician_email_verifications_select_all"
  ON politician_email_verifications FOR SELECT USING (true);
CREATE POLICY "politician_email_verifications_insert_all"
  ON politician_email_verifications FOR INSERT WITH CHECK (true);
CREATE POLICY "politician_email_verifications_update_all"
  ON politician_email_verifications FOR UPDATE USING (true);

-- ============================================
-- 3. politician_sessions 테이블 수정 (영구 세션)
-- ============================================
-- 기존 테이블이 있으면 expires_at을 매우 길게 설정
-- 또는 expires_at NULL 허용 (영구)

-- 테이블이 없으면 생성
CREATE TABLE IF NOT EXISTS politician_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    politician_id TEXT NOT NULL REFERENCES politicians(id) ON DELETE CASCADE,
    session_token TEXT UNIQUE NOT NULL,
    expires_at TIMESTAMPTZ,  -- NULL이면 영구
    last_used_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    ip_address TEXT,
    user_agent TEXT
);

CREATE INDEX IF NOT EXISTS idx_politician_sessions_politician
  ON politician_sessions(politician_id);
CREATE INDEX IF NOT EXISTS idx_politician_sessions_token
  ON politician_sessions(session_token);
```

### 2. API 구현

#### 2.1 인증 코드 발송 API

```typescript
// src/app/api/politicians/auth/send-code/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { createAdminClient } from '@/lib/supabase/server';
import { Resend } from 'resend';

const resend = new Resend(process.env.RESEND_API_KEY);

const sendCodeSchema = z.object({
  politician_id: z.string().min(1, '정치인을 선택해주세요'),
  email: z.string().email('올바른 이메일 주소를 입력해주세요'),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validated = sendCodeSchema.parse(body);

    const supabase = createAdminClient();

    // 1. 정치인 존재 확인 (등록된 정치인만)
    const { data: politician, error: politicianError } = await supabase
      .from('politicians')
      .select('id, name, party, position')
      .eq('id', validated.politician_id)
      .single();

    if (politicianError || !politician) {
      return NextResponse.json({
        success: false,
        error: { code: 'NOT_FOUND', message: '등록된 정치인이 아닙니다.' }
      }, { status: 404 });
    }

    // 2. 6자리 인증 코드 생성
    const verificationCode = Math.random().toString(36).substring(2, 8).toUpperCase();

    // 3. 만료 시간 설정 (10분)
    const expiresAt = new Date();
    expiresAt.setMinutes(expiresAt.getMinutes() + 10);

    // 4. DB에 저장
    const { data: verification, error: insertError } = await supabase
      .from('politician_email_verifications')
      .insert({
        politician_id: validated.politician_id,
        email: validated.email,
        verification_code: verificationCode,
        expires_at: expiresAt.toISOString(),
      })
      .select()
      .single();

    if (insertError) {
      console.error('Insert error:', insertError);
      return NextResponse.json({
        success: false,
        error: { code: 'DATABASE_ERROR', message: '인증 코드 생성 실패' }
      }, { status: 500 });
    }

    // 5. 이메일 발송 (Resend)
    await resend.emails.send({
      from: 'PoliticianFinder <noreply@politicianfinder.ai.kr>',
      to: validated.email,
      subject: `[PoliticianFinder] ${politician.name}님 본인 인증 코드`,
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #064E3B;">안녕하세요, ${politician.name}님</h2>
          <p>PoliticianFinder 본인 인증을 위한 코드입니다.</p>
          <div style="background: #f3f4f6; padding: 20px; text-align: center; border-radius: 8px; margin: 20px 0;">
            <h1 style="color: #064E3B; font-size: 36px; letter-spacing: 8px; margin: 0;">
              ${verificationCode}
            </h1>
          </div>
          <p><strong>유효 시간:</strong> 10분</p>
          <p style="color: #999; font-size: 14px; margin-top: 30px;">
            본인이 요청하지 않았다면 이 메일을 무시하셔도 됩니다.
          </p>
          <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
          <p style="color: #666; font-size: 12px;">
            PoliticianFinder<br>
            https://www.politicianfinder.ai.kr
          </p>
        </div>
      `,
    });

    // 6. 응답 (이메일 일부 마스킹)
    const maskedEmail = validated.email.replace(/(.{2})(.*)(@.*)/, '$1***$3');

    return NextResponse.json({
      success: true,
      message: '인증 코드가 발송되었습니다.',
      verification_id: verification.id,
      email: maskedEmail,
      expires_at: expiresAt.toISOString(),
      politician: {
        id: politician.id,
        name: politician.name,
        party: politician.party,
        position: politician.position,
      }
    });

  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({
        success: false,
        error: { code: 'VALIDATION_ERROR', message: error.errors[0].message }
      }, { status: 400 });
    }

    console.error('Unexpected error:', error);
    return NextResponse.json({
      success: false,
      error: { code: 'INTERNAL_ERROR', message: '서버 오류가 발생했습니다.' }
    }, { status: 500 });
  }
}
```

#### 2.2 코드 확인 + 세션 발급 API

```typescript
// src/app/api/politicians/auth/verify-code/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { createAdminClient } from '@/lib/supabase/server';
import crypto from 'crypto';

const verifyCodeSchema = z.object({
  verification_id: z.string().uuid(),
  code: z.string().length(6, '6자리 코드를 입력해주세요'),
});

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const validated = verifyCodeSchema.parse(body);

    const supabase = createAdminClient();

    // 1. 인증 요청 조회
    const { data: verification, error: verificationError } = await supabase
      .from('politician_email_verifications')
      .select('*')
      .eq('id', validated.verification_id)
      .single();

    if (verificationError || !verification) {
      return NextResponse.json({
        success: false,
        error: { code: 'NOT_FOUND', message: '인증 요청을 찾을 수 없습니다.' }
      }, { status: 404 });
    }

    // 2. 이미 인증됨 체크
    if (verification.verified) {
      return NextResponse.json({
        success: false,
        error: { code: 'ALREADY_VERIFIED', message: '이미 인증된 요청입니다.' }
      }, { status: 400 });
    }

    // 3. 만료 체크
    if (new Date() > new Date(verification.expires_at)) {
      return NextResponse.json({
        success: false,
        error: { code: 'EXPIRED', message: '인증 코드가 만료되었습니다. 다시 발송해주세요.' }
      }, { status: 400 });
    }

    // 4. 코드 일치 확인
    if (verification.verification_code !== validated.code.toUpperCase()) {
      return NextResponse.json({
        success: false,
        error: { code: 'INVALID_CODE', message: '인증 코드가 일치하지 않습니다.' }
      }, { status: 400 });
    }

    // 5. 인증 완료 처리
    await supabase
      .from('politician_email_verifications')
      .update({ verified: true, verified_at: new Date().toISOString() })
      .eq('id', validated.verification_id);

    // 6. politicians.verified_email 업데이트 (새 이메일이면 변경)
    await supabase
      .from('politicians')
      .update({
        verified_email: verification.email,
        email_verified_at: new Date().toISOString(),
      })
      .eq('id', verification.politician_id);

    // 7. 기존 세션 삭제 (새 세션 발급 위해)
    await supabase
      .from('politician_sessions')
      .delete()
      .eq('politician_id', verification.politician_id);

    // 8. 새 세션 토큰 발급 (영구 또는 장기)
    const sessionToken = crypto.randomBytes(32).toString('hex');

    // 만료일: 1년 후 (실질적 영구)
    const sessionExpiresAt = new Date();
    sessionExpiresAt.setFullYear(sessionExpiresAt.getFullYear() + 1);

    const { error: sessionError } = await supabase
      .from('politician_sessions')
      .insert({
        politician_id: verification.politician_id,
        session_token: sessionToken,
        expires_at: sessionExpiresAt.toISOString(),
      });

    if (sessionError) {
      console.error('Session create error:', sessionError);
      return NextResponse.json({
        success: false,
        error: { code: 'SESSION_ERROR', message: '세션 생성 실패' }
      }, { status: 500 });
    }

    // 9. 정치인 정보 조회
    const { data: politician } = await supabase
      .from('politicians')
      .select('id, name, party, position')
      .eq('id', verification.politician_id)
      .single();

    return NextResponse.json({
      success: true,
      message: `${politician?.name}님 본인 인증이 완료되었습니다.`,
      session: {
        politician_id: verification.politician_id,
        session_token: sessionToken,
        expires_at: sessionExpiresAt.toISOString(),
      },
      politician: politician,
    });

  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({
        success: false,
        error: { code: 'VALIDATION_ERROR', message: error.errors[0].message }
      }, { status: 400 });
    }

    console.error('Unexpected error:', error);
    return NextResponse.json({
      success: false,
      error: { code: 'INTERNAL_ERROR', message: '서버 오류가 발생했습니다.' }
    }, { status: 500 });
  }
}
```

#### 2.3 세션 상태 확인 API

```typescript
// src/app/api/politicians/auth/session/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { politician_id, session_token } = body;

    if (!politician_id || !session_token) {
      return NextResponse.json({
        success: false,
        valid: false,
        error: { message: '세션 정보가 없습니다.' }
      }, { status: 400 });
    }

    const supabase = createAdminClient();

    // 세션 유효성 확인
    const { data: session, error } = await supabase
      .from('politician_sessions')
      .select('*, politicians(id, name, party, position, verified_email)')
      .eq('politician_id', politician_id)
      .eq('session_token', session_token)
      .gt('expires_at', new Date().toISOString())
      .single();

    if (error || !session) {
      return NextResponse.json({
        success: true,
        valid: false,
        message: '세션이 만료되었거나 유효하지 않습니다.',
      });
    }

    // last_used_at 업데이트
    await supabase
      .from('politician_sessions')
      .update({ last_used_at: new Date().toISOString() })
      .eq('id', session.id);

    return NextResponse.json({
      success: true,
      valid: true,
      politician: session.politicians,
      expires_at: session.expires_at,
    });

  } catch (error) {
    console.error('Session check error:', error);
    return NextResponse.json({
      success: false,
      valid: false,
      error: { message: '서버 오류가 발생했습니다.' }
    }, { status: 500 });
  }
}
```

### 3. 프론트엔드 컴포넌트

```tsx
// src/components/PoliticianAuthModal.tsx

'use client';

import { useState, useEffect } from 'react';

interface Politician {
  id: string;
  name: string;
  party: string;
  position: string;
}

interface PoliticianAuthModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: (session: { politician_id: string; session_token: string; politician: Politician }) => void;
}

export function PoliticianAuthModal({ isOpen, onClose, onSuccess }: PoliticianAuthModalProps) {
  const [step, setStep] = useState<1 | 2 | 3>(1);
  const [politicians, setPoliticians] = useState<Politician[]>([]);
  const [selectedPolitician, setSelectedPolitician] = useState<string>('');
  const [email, setEmail] = useState('');
  const [verificationId, setVerificationId] = useState('');
  const [code, setCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [countdown, setCountdown] = useState(600); // 10분

  // 정치인 목록 로드
  useEffect(() => {
    if (isOpen) {
      fetch('/api/politicians?limit=1000')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            setPoliticians(data.data);
          }
        });
    }
  }, [isOpen]);

  // 카운트다운
  useEffect(() => {
    if (step === 2 && countdown > 0) {
      const timer = setInterval(() => setCountdown(c => c - 1), 1000);
      return () => clearInterval(timer);
    }
  }, [step, countdown]);

  const formatTime = (seconds: number) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  // 인증 코드 발송
  const handleSendCode = async () => {
    if (!selectedPolitician || !email) {
      setError('정치인과 이메일을 입력해주세요.');
      return;
    }

    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/politicians/auth/send-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          politician_id: selectedPolitician,
          email: email,
        }),
      });

      const data = await res.json();

      if (data.success) {
        setVerificationId(data.verification_id);
        setStep(2);
        setCountdown(600);
      } else {
        setError(data.error?.message || '인증 코드 발송 실패');
      }
    } catch (err) {
      setError('서버 오류가 발생했습니다.');
    } finally {
      setLoading(false);
    }
  };

  // 코드 확인
  const handleVerifyCode = async () => {
    if (code.length !== 6) {
      setError('6자리 코드를 입력해주세요.');
      return;
    }

    setLoading(true);
    setError('');

    try {
      const res = await fetch('/api/politicians/auth/verify-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          verification_id: verificationId,
          code: code,
        }),
      });

      const data = await res.json();

      if (data.success) {
        // localStorage에 세션 저장
        localStorage.setItem('politician_session', JSON.stringify(data.session));

        setStep(3);

        setTimeout(() => {
          onSuccess({
            politician_id: data.session.politician_id,
            session_token: data.session.session_token,
            politician: data.politician,
          });
        }, 1500);
      } else {
        setError(data.error?.message || '인증 실패');
      }
    } catch (err) {
      setError('서버 오류가 발생했습니다.');
    } finally {
      setLoading(false);
    }
  };

  if (!isOpen) return null;

  const selectedPoliticianInfo = politicians.find(p => p.id === selectedPolitician);

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-md">
        <h2 className="text-xl font-bold mb-4">정치인 본인 인증</h2>

        {error && (
          <div className="bg-red-50 text-red-600 p-3 rounded mb-4">
            {error}
          </div>
        )}

        {/* STEP 1: 정치인 선택 + 이메일 입력 */}
        {step === 1 && (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-1">정치인 선택</label>
              <select
                value={selectedPolitician}
                onChange={(e) => setSelectedPolitician(e.target.value)}
                className="w-full border rounded-lg p-3"
              >
                <option value="">-- 선택하세요 --</option>
                {politicians.map(p => (
                  <option key={p.id} value={p.id}>
                    {p.name} ({p.position}, {p.party})
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">이메일 주소</label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="example@email.com"
                className="w-full border rounded-lg p-3"
              />
              <p className="text-xs text-gray-500 mt-1">
                본인이 확인 가능한 이메일을 입력하세요.
              </p>
            </div>

            <div className="flex gap-2">
              <button
                onClick={onClose}
                className="flex-1 px-4 py-3 border rounded-lg"
              >
                취소
              </button>
              <button
                onClick={handleSendCode}
                disabled={loading || !selectedPolitician || !email}
                className="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg disabled:opacity-50"
              >
                {loading ? '발송 중...' : '인증 코드 발송'}
              </button>
            </div>
          </div>
        )}

        {/* STEP 2: 코드 입력 */}
        {step === 2 && (
          <div className="space-y-4">
            <p className="text-center text-gray-600">
              <strong>{email}</strong>으로<br/>
              인증 코드를 발송했습니다.
            </p>

            <div className="text-center">
              <input
                type="text"
                value={code}
                onChange={(e) => setCode(e.target.value.toUpperCase().slice(0, 6))}
                placeholder="XXXXXX"
                maxLength={6}
                className="text-center text-2xl tracking-widest border-2 rounded-lg p-4 w-48"
              />
            </div>

            <p className="text-center text-gray-500">
              유효 시간: <span className={countdown < 60 ? 'text-red-500' : ''}>
                {formatTime(countdown)}
              </span>
            </p>

            <div className="flex gap-2">
              <button
                onClick={handleSendCode}
                className="flex-1 px-4 py-3 border rounded-lg"
              >
                코드 재발송
              </button>
              <button
                onClick={handleVerifyCode}
                disabled={loading || code.length !== 6}
                className="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg disabled:opacity-50"
              >
                {loading ? '확인 중...' : '인증 확인'}
              </button>
            </div>
          </div>
        )}

        {/* STEP 3: 완료 */}
        {step === 3 && (
          <div className="text-center space-y-4">
            <div className="text-5xl">✅</div>
            <p className="text-lg font-medium">
              {selectedPoliticianInfo?.name}님<br/>
              본인 인증이 완료되었습니다!
            </p>
            <p className="text-gray-600">
              이제 글쓰기, 댓글, 보고서 구매가 가능합니다.
            </p>
          </div>
        )}
      </div>
    </div>
  );
}
```

---

## 검증 단계

### 1. 빌드 검증
```bash
cd 1_Frontend
npm run build
```

### 2. API 테스트
```bash
# 인증 코드 발송
curl -X POST http://localhost:3000/api/politicians/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"politician_id":"62e7b453","email":"test@example.com"}'

# 코드 확인
curl -X POST http://localhost:3000/api/politicians/auth/verify-code \
  -H "Content-Type: application/json" \
  -d '{"verification_id":"uuid","code":"ABC123"}'

# 세션 확인
curl -X POST http://localhost:3000/api/politicians/auth/session \
  -H "Content-Type: application/json" \
  -d '{"politician_id":"62e7b453","session_token":"..."}'
```

### 3. 통합 테스트
- 정치인 선택 → 이메일 입력 → 코드 발송 → 코드 입력 → 인증 완료
- 인증 후 글쓰기/댓글/보고서 구매 가능 확인
- 이메일 변경 시 업데이트 확인

---

## 완료 기준

- [ ] DB 마이그레이션 적용 완료
- [ ] 인증 코드 발송 API 구현
- [ ] 코드 확인 + 세션 발급 API 구현
- [ ] 세션 상태 확인 API 구현
- [ ] 프론트엔드 인증 모달 구현
- [ ] 이메일 실제 발송 테스트 성공
- [ ] 이메일 변경 시 업데이트 확인
- [ ] 기존 댓글 이메일 인증과 통합
- [ ] TypeScript 타입 체크 통과
- [ ] Next.js 빌드 성공
- [ ] PROJECT GRID 상태 업데이트 완료

---

## 기존 코드와의 통합

### 변경이 필요한 기존 파일

1. **댓글 인증** (`src/app/community/posts/[id]/page.tsx`)
   - 이메일 인증 모달 사용

2. **글쓰기 인증** (해당 페이지)
   - 통합 이메일 인증 모달 연동

3. **보고서 구매** (해당 페이지)
   - 통합 이메일 인증 모달 연동

### 세션 확인 유틸리티

```typescript
// src/lib/auth/politicianAuth.ts

export function getPoliticianSession() {
  if (typeof window === 'undefined') return null;

  const session = localStorage.getItem('politician_session');
  if (!session) return null;

  try {
    return JSON.parse(session);
  } catch {
    return null;
  }
}

export function clearPoliticianSession() {
  localStorage.removeItem('politician_session');
}

export async function validatePoliticianSession() {
  const session = getPoliticianSession();
  if (!session) return { valid: false };

  const res = await fetch('/api/politicians/auth/session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(session),
  });

  return res.json();
}
```

---

**작업지시서 생성일**: 2025-12-13
**PROJECT GRID Version**: v4.2
